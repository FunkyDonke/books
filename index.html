<!DOCTYPE html>
<html lang="bn" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>স্মার্ট পাঠশালা - অটোমেটেড</title>
    <!-- Tailwind CSS with Typography Plugin -->
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Hind Siliguri', 'sans-serif'],
                    },
                    animation: {
                        'flip-in': 'flipIn 0.6s ease-in-out',
                    },
                    keyframes: {
                        flipIn: {
                            '0%': { transform: 'rotateY(90deg)', opacity: '0' },
                            '100%': { transform: 'rotateY(0deg)', opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Marked.js for Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Chart.js for Statistics Charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>

    <style>
        body { font-family: 'Hind Siliguri', sans-serif; overflow-x: hidden; height: 100vh; }
        .gradient-text {
            background: linear-gradient(to right, #4f46e5, #06b6d4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .card-hover { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .card-hover:hover { transform: translateY(-5px); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); }
        .fade-in { animation: fadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1) both; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        

        /* Header collapse transition */
        #reader-subject-header {
            transition: max-height 0.25s ease, opacity 0.2s ease, padding 0.2s ease;
            max-height: 200px;
            overflow: hidden;
        }
        #reader-subject-header.header-collapsed {
            max-height: 0 !important;
            opacity: 0;
            padding: 0 !important;
            border-bottom: none !important;
            pointer-events: none !important;
            visibility: hidden;
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        .dark ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .dark ::-webkit-scrollbar-thumb { background: #4b5563; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .modal { transition: opacity 0.25s ease; }
        body.modal-active { overflow: hidden; }
        
        /* Drag & Nesting Styles */
        .btn-visible-anim { display: flex !important; animation: popIn 0.2s ease-out; }
        @keyframes popIn { 0% { transform: scale(0); opacity: 0; } 80% { transform: scale(1.1); opacity: 1; } 100% { transform: scale(1); opacity: 1; } }
        .dragging { opacity: 0.5; border: 2px dashed #4f46e5; }
        .drag-over { background-color: rgba(79, 70, 229, 0.1); border: 2px dashed #4f46e5; }
        .drag-over-top { border-top: 3px solid #10b981; }
        .drag-over-bottom { border-bottom: 3px solid #10b981; }
        .drag-over-middle { background-color: rgba(79, 70, 229, 0.15); border: 2px dashed #4f46e5; border-radius: 0.5rem; }
        .is-hidden-subject { opacity: 0.6; border: 2px dashed #9ca3af; filter: grayscale(100%); transition: all 0.3s ease; }

        /* Accordion */
        .accordion-content { transition: max-height 0.3s ease-out, opacity 0.3s ease-out; max-height: 0; overflow: hidden; opacity: 0; margin-left: 0.75rem; border-left: 1px solid #e5e7eb; }
        .dark .accordion-content { border-left-color: #374151; }
        .accordion-content.open { max-height: 10000px; opacity: 1; }

        /* Custom Checkbox */
        .custom-checkbox { width: 1.25rem; height: 1.25rem; cursor: pointer; border-radius: 0.25rem; accent-color: #4f46e5; }
        
        /* Tab Active State */
        .tab-active { border-bottom: 2px solid #4f46e5; color: #4f46e5; font-weight: 600; }
        .dark .tab-active { border-bottom: 2px solid #818cf8; color: #818cf8; }

        /* Resizable Video Card */
        .resizable-card {
            resize: both;
            overflow: hidden;
            min-width: 320px;
            min-height: 240px;
            max-width: 100%;
            display: flex;
            flex-direction: column;
            background-color: black;
        }
        
        /* Group Optional Style */
        .group-optional { background-image: linear-gradient(45deg, rgba(79, 70, 229, 0.05) 25%, transparent 25%, transparent 50%, rgba(79, 70, 229, 0.05) 50%, rgba(79, 70, 229, 0.05) 75%, transparent 75%, transparent); background-size: 20px 20px; border: 2px dashed #6366f1; }
        .dark .group-optional { background-image: linear-gradient(45deg, rgba(255, 255, 255, 0.03) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, 0.03) 50%, rgba(255, 255, 255, 0.03) 75%, transparent 75%, transparent); border-color: #818cf8; }
        
        /* Markdown Specific Styles */
        .prose img { margin: 1rem auto; border-radius: 0.5rem; }
        .prose a { color: #4f46e5; text-decoration: none; }
        .prose a:hover { text-decoration: underline; }
        .prose table { width: 100%; border-collapse: collapse; margin: 1rem 0; }
        .prose th, .prose td { border: 1px solid #e5e7eb; padding: 0.5rem; text-align: left; }
        .dark .prose th, .dark .prose td { border-color: #374151; }
        .prose th { background-color: #f9fafb; font-weight: 600; }
        .dark .prose th { background-color: #1f2937; }
        .prose blockquote { border-left: 4px solid #e5e7eb; padding-left: 1rem; color: #6b7280; font-style: italic; }
        .dark .prose blockquote { border-color: #374151; color: #9ca3af; }
        
        /* Improved Image Floating Styles for Prose */
        .prose .float-right { float: right; margin-left: 1.5rem; margin-bottom: 0.5rem; clear: right; }
        .prose .float-left { float: left; margin-right: 1.5rem; margin-bottom: 0.5rem; clear: left; }
        .prose figure { margin: 0; }
        .prose figcaption { text-align: center; font-size: 0.875rem; color: #6b7280; margin-top: 0.5rem; }
        .dark .prose figcaption { color: #9ca3af; }

        /* FIX: Reset margins for images inside custom layouts to remove extra space */
        .prose .float-right img, .prose .float-left img, .prose .grid img {
            margin: 0 !important;
        }
        /* UPDATED FIX: Center Block - Auto Horizontal Margins for centering, 0 Vertical to prevent gaps */
        .prose figure img {
            margin: 0 auto !important;
            display: block; 
        }

        /* Flashcard Styles */
        .flashcard-container { perspective: 1000px; height: 200px; }
        .flashcard {
            width: 100%; height: 100%; position: relative; transition: transform 0.6s; transform-style: preserve-3d; cursor: pointer;
        }
        .flashcard.flipped { transform: rotateY(180deg); }
        .flashcard-face {
            position: absolute; width: 100%; height: 100%; backface-visibility: hidden; 
            display: flex; flex-direction: column; justify-content: center; items-center; 
            padding: 1.5rem; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            text-align: center;
        }
        .flashcard-front { background: linear-gradient(135deg, #4f46e5, #4338ca); color: white; }
        .flashcard-back { background: white; color: #1f2937; transform: rotateY(180deg); border: 1px solid #e5e7eb; overflow-y: auto; }
        .dark .flashcard-back { background: #1f2937; color: white; border-color: #374151; }

        /* Toolbar Button */
        .toolbar-btn { padding: 4px 8px; border-radius: 4px; font-weight: 600; font-size: 14px; transition: all 0.2s; }
        .toolbar-btn:hover { background-color: #e0e7ff; color: #4338ca; }
        .dark .toolbar-btn:hover { background-color: #374151; color: #a5b4fc; }

        /* Focus Mode */
        .focus-mode { position: fixed !important; top: 0; left: 0; width: 100vw !important; height: 100vh !important; z-index: 9999; border-radius: 0 !important; }

        /* Loading Overlay for Auto Import */
        #auto-import-overlay { z-index: 9999; }
    </style>
</head>
<body class="h-screen flex flex-col text-gray-800 bg-gray-50 dark:bg-gray-950 dark:text-gray-100 transition-colors duration-300">

    <!-- Auto Import Loading Overlay -->
    <div id="auto-import-overlay" class="hidden fixed inset-0 bg-white dark:bg-gray-900 flex flex-col items-center justify-center">
        <i data-lucide="loader-2" class="animate-spin h-10 w-10 text-indigo-600 mb-4"></i>
        <h2 class="text-xl font-bold dark:text-white">ডাটাবেস তৈরি হচ্ছে...</h2>
        <p class="text-gray-500 text-sm mt-2">ফাইল ফেচিং ও প্রসেসিং চলছে</p>
    </div>

    <!-- Navbar -->
    <input type="file" id="restore-file-input" class="hidden" accept=".json" onchange="importBackup(this)">

    <!-- Main Content -->
    <main id="main-container" class="flex-grow w-full overflow-hidden relative">
        <div class="h-full w-full overflow-y-auto custom-scrollbar"> 
            <div class="w-full h-full flex flex-col">
            
                <!-- VIEW 1: Class Selection -->
                <div id="view-classes" class="fade-in py-10 px-4 flex-grow flex flex-col justify-center">
                    <div class="text-center mb-10">
                        <h1 class="text-4xl md:text-6xl font-bold mb-4 text-gray-900 dark:text-white">আপনার <span class="gradient-text">শ্রেণী</span> নির্বাচন করুন</h1>
                        <p class="text-lg text-gray-600 dark:text-gray-400">ডিজিটাল পাঠ্যবই এবং নোট ম্যানেজমেন্ট সিস্টেম (অটোমেটেড)</p>
                    </div>
                    <div id="row-junior" class="flex flex-wrap justify-center gap-6 mb-8"></div>
                    <div id="row-senior" class="flex flex-wrap justify-center gap-6"></div>
                </div>

                <!-- VIEW 2: Subject Selection -->
                <div id="view-subjects" class="hidden fade-in pb-20 relative px-4 lg:px-6">
                     <!-- Bulk Action Bar -->
                    <div id="bulk-action-bar-subjects" class="hidden fixed bottom-6 left-1/2 transform -translate-x-1/2 z-50 bg-white dark:bg-gray-800 shadow-xl border border-gray-200 dark:border-gray-700 rounded-full px-6 py-3 flex items-center gap-4 animate-bounce-in">
                        <span class="text-sm font-bold text-gray-700 dark:text-white"><span id="selected-count-subs">0</span> টি নির্বাচিত</span>
                        <div class="h-4 w-px bg-gray-300 dark:bg-gray-600"></div>
                        <button onclick="bulkToggleVisibilitySubjects()" class="text-gray-600 dark:text-gray-300 hover:text-indigo-600 dark:hover:text-indigo-400 transition" title="হাইড/শো (ঐচ্ছিক)"><i data-lucide="eye" class="h-5 w-5"></i></button>
                        <button onclick="bulkDeleteSubjects()" class="text-red-500 hover:text-red-700 transition" title="ডিলিট"><i data-lucide="trash-2" class="h-5 w-5"></i></button>
                        <button onclick="clearSelection()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition"><i data-lucide="x" class="h-5 w-5"></i></button>
                    </div>

                    <!-- Sticky Header -->
                    <div class="sticky top-0 z-30 bg-gray-50/95 dark:bg-gray-950/95 pt-4 pb-4 mb-4 border-b border-gray-200 dark:border-gray-800 shadow-sm transition-colors backdrop-blur-md">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                            <div class="flex items-center gap-3">
                                <button onclick="goHome()" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-800 transition">
                                    <i data-lucide="arrow-left" class="h-6 w-6"></i>
                                </button>
                                <div>
                                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white"><span id="selected-class-name" class="text-indigo-600 dark:text-indigo-400"></span></h2>
                                    <p class="text-xs text-gray-500">বিষয় নির্বাচন করুন</p>
                                </div>
                            </div>
                            <div class="flex flex-wrap items-center gap-3 w-full md:w-auto">
                                <div id="group-selector-container" class="hidden">
                                    <select id="group-select" onchange="updateGroup()" class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                                        <option value="science">বিজ্ঞান (Science)</option>
                                        <option value="arts">মানবিক (Arts)</option>
                                        <option value="commerce">ব্যবসায় শিক্ষা (Commerce)</option>
                                    </select>
                                </div>
                                <div class="flex items-center gap-2 ml-auto">
                                    <label class="flex items-center cursor-pointer select-none bg-white dark:bg-gray-800 px-3 py-2 rounded-lg border border-gray-200 dark:border-gray-700">
                                        <span class="text-xs font-medium mr-2">ঐচ্ছিক বিষয়</span>
                                        <input type="checkbox" id="toggle-optional" class="accent-indigo-600 w-4 h-4" onchange="toggleOptionalSubjects()">
                                    </label>
                                    <button id="btn-edit-mode" onclick="toggleEditMode()" class="flex items-center gap-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 px-3 py-2 rounded-lg text-sm font-medium transition">
                                        <i data-lucide="edit-3" class="h-4 w-4"></i> এডিট
                                    </button>
                                    <div class="relative flex-shrink-0" id="add-btn-wrapper">
                                         <button onclick="toggleAddMenu()" class="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition">
                                            <i data-lucide="plus" class="h-4 w-4"></i> যুক্ত করুন
                                        </button>
                                        <div id="add-menu-panel" class="absolute right-0 mt-2 w-56 bg-white dark:bg-gray-800 rounded-lg shadow-xl border border-gray-100 dark:border-gray-700 z-50 overflow-hidden" style="display:none">
                                            <button onclick="closeAddMenu();openAddSubjectModal();" class="w-full text-left px-4 py-3 hover:bg-gray-50 dark:hover:bg-gray-700 text-sm flex items-center gap-2"><i data-lucide="plus-circle" class="h-4 w-4"></i> ম্যানুয়াল যোগ</button>
                                            <button onclick="closeAddMenu();openBulkImportSubjectModal();" class="w-full text-left px-4 py-3 hover:bg-gray-50 dark:hover:bg-gray-700 text-sm border-t border-gray-100 dark:border-gray-700 flex items-center gap-2"><i data-lucide="list-plus" class="h-4 w-4"></i> বাল্ক ইম্পোর্ট</button>
                                            <button onclick="closeAddMenu();exportClassData();" class="w-full text-left px-4 py-3 hover:bg-gray-50 dark:hover:bg-gray-700 text-sm border-t border-gray-100 dark:border-gray-700 flex items-center gap-2 text-indigo-600"><i data-lucide="download" class="h-4 w-4"></i> বাল্ক এক্সপোর্ট</button>
                                        </div>
                                    </div>
                                    <!-- Tools button for subjects page -->
                                    <div class="relative flex-shrink-0" id="tools-menu-wrapper-subjects">
                                        <button onclick="toggleToolsMenuSubjects()" title="টুলস মেনু"
                                            class="flex items-center gap-1.5 p-2 rounded-lg text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                                            <i data-lucide="settings-2" class="h-5 w-5"></i>
                                        </button>
                                        <div id="tools-menu-panel-subjects" class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl shadow-xl overflow-hidden min-w-[190px]" style="position:fixed;z-index:99999;display:none">
                                            <div class="flex flex-col py-1">
                                                <button onclick="closeToolsMenuSubjects();document.getElementById('restore-file-input').click();" class="flex items-center gap-2.5 px-4 py-2.5 text-sm text-green-600 dark:text-green-400 hover:bg-gray-50 dark:hover:bg-gray-700 transition w-full text-left">
                                                    <i data-lucide="upload-cloud" class="h-4 w-4"></i> রিস্টোর ডাটা
                                                </button>
                                                <button onclick="closeToolsMenuSubjects();confirmReset();" class="flex items-center gap-2.5 px-4 py-2.5 text-sm text-red-500 hover:bg-gray-50 dark:hover:bg-gray-700 transition w-full text-left">
                                                    <i data-lucide="rotate-ccw" class="h-4 w-4"></i> রিসেট
                                                </button>
                                                <button onclick="closeToolsMenuSubjects();exportData();" class="flex items-center gap-2.5 px-4 py-2.5 text-sm text-indigo-600 dark:text-indigo-400 hover:bg-gray-50 dark:hover:bg-gray-700 transition w-full text-left">
                                                    <i data-lucide="download" class="h-4 w-4"></i> ব্যাকআপ
                                                </button>
                                                <button onclick="closeToolsMenuSubjects();openStatsModal();" class="flex items-center gap-2.5 px-4 py-2.5 text-sm text-purple-600 dark:text-purple-400 hover:bg-gray-50 dark:hover:bg-gray-700 transition w-full text-left">
                                                    <i data-lucide="bar-chart-3" class="h-4 w-4"></i> পরিসংখ্যান
                                                </button>
                                                <div class="border-t border-gray-100 dark:border-gray-700 my-1"></div>
                                                <button onclick="closeToolsMenuSubjects();toggleTheme();" class="flex items-center gap-2.5 px-4 py-2.5 text-sm text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition w-full text-left">
                                                    <i data-lucide="moon" class="h-4 w-4"></i> থিম পরিবর্তন
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="subject-content" class="min-h-[50vh]"></div>
                </div>

                <!-- VIEW 3: Reader View -->
                                <div id="view-reader" class="hidden h-full flex flex-col relative pt-4 pl-6 lg:pl-8 pr-6 lg:pr-8">
                     <!-- Bulk Action Bar -->
                    <div id="bulk-action-bar-chapters" class="hidden absolute bottom-6 left-1/2 transform -translate-x-1/2 z-50 bg-white dark:bg-gray-800 shadow-xl border border-gray-200 dark:border-gray-700 rounded-full px-6 py-3 flex items-center gap-4 animate-bounce-in">
                        <span class="text-sm font-bold text-gray-700 dark:text-white"><span id="selected-count-chaps">0</span> টি নির্বাচিত</span>
                         <div class="h-4 w-px bg-gray-300 dark:bg-gray-600"></div>
                        <button onclick="bulkDeleteChapters()" class="text-red-500 hover:text-red-700 transition" title="ডিলিট"><i data-lucide="trash-2" class="h-5 w-5"></i></button>
                        <button onclick="clearSelection()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 transition"><i data-lucide="x" class="h-5 w-5"></i></button>
                    </div>

                    <!-- Mobile Sidebar Overlay -->
                    <div id="sidebar-overlay" class="hidden fixed inset-0 bg-black/60 z-40 lg:hidden" onclick="toggleSidebar()"></div>

                    <div id="reader-panels" class="flex gap-0 lg:gap-6 h-full pb-2 overflow-hidden">
                        <!-- Sidebar: pl-0 so its LEFT edge touches the page padding edge -->
                        <div id="reader-sidebar" class="fixed lg:relative top-0 left-0 h-full w-80 lg:w-80 flex-shrink-0 flex-col z-50 lg:z-auto bg-white dark:bg-gray-900 shadow-2xl lg:shadow-none lg:rounded-2xl overflow-hidden transition-all duration-300 -translate-x-full lg:translate-x-0 lg:flex">
                            <!-- Inner border — clipped by overflow-hidden when w-0, never flashes -->
                            <div class="h-full flex flex-col border-r lg:border border-gray-100 dark:border-gray-800 lg:rounded-2xl overflow-hidden">
                            <div class="p-4 border-b border-gray-100 dark:border-gray-800 flex justify-between items-center bg-gray-50 dark:bg-gray-800/50">
                                <button onclick="showSubjects()" class="text-gray-500 hover:text-indigo-600 transition"><i data-lucide="arrow-left" class="h-5 w-5"></i></button>
                                <span class="font-bold text-gray-700 dark:text-gray-200 truncate mx-2">সূচিপত্র</span>
                                <div class="flex gap-1 flex-shrink-0">
                                    <!-- Close button for mobile -->
                                    <button onclick="toggleSidebar()" class="lg:hidden p-1.5 text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 rounded" title="বন্ধ করুন"><i data-lucide="x" class="h-4 w-4"></i></button>
                                    <button onclick="exportChapterData()" title="Export List" class="hidden sm:block p-1.5 text-indigo-600 hover:bg-indigo-50 dark:hover:bg-indigo-900/20 rounded"><i data-lucide="download" class="h-4 w-4"></i></button>
                                    <button onclick="openBulkImportSubjectModal(true)" title="Import List" class="hidden sm:block p-1.5 text-indigo-600 hover:bg-indigo-50 dark:hover:bg-indigo-900/20 rounded"><i data-lucide="file-text" class="h-4 w-4"></i></button>
                                    <button id="btn-edit-mode-reader" onclick="toggleEditMode()" title="Edit" class="p-1.5 text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 rounded"><i data-lucide="edit-3" class="h-4 w-4"></i></button>
                                    <button onclick="openAddChapterModal()" title="Add" class="p-1.5 text-green-600 hover:bg-green-50 dark:hover:bg-green-900/20 rounded"><i data-lucide="plus" class="h-4 w-4"></i></button>
                                </div>
                            </div>
                            <div id="chapter-list" class="flex-grow overflow-y-auto p-2 custom-scrollbar" style="scroll-behavior: auto;"></div>
                            <div id="empty-chapters-msg" class="hidden p-8 text-center text-sm text-gray-400">কোন অধ্যায় নেই।</div>
                            </div><!-- end inner border wrapper -->
                        </div>

                        <!-- Content Area (Reader Features) - Full Width Responsive -->
                        <div id="reader-content-area" class="flex-grow h-full w-full bg-white dark:bg-gray-900 lg:rounded-2xl shadow-sm lg:border border-gray-100 dark:border-gray-800 flex flex-col relative" style="overflow:hidden">

                            <!-- Floating restore button: shown when header is hidden -->
                            <div id="header-restore-btn" style="display:none;position:absolute;bottom:12px;right:12px;z-index:60">
                                <button onclick="toggleHeaderCollapse()" title="হেডার দেখান"
                                    class="flex items-center gap-1.5 px-3 py-1.5 bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-bold rounded-full shadow-xl transition-all">
                                    <i data-lucide="chevrons-down" class="h-3.5 w-3.5"></i> দেখান
                                </button>
                            </div>

                            <!-- Content Header with Tabs -->
                            <div id="reader-subject-header" class="flex-none border-b border-gray-100 dark:border-gray-800 bg-gray-50 dark:bg-gray-800/50" style="overflow:visible;position:relative;z-index:100">
                                <div class="p-4 md:p-6 pb-2">
                                    <div class="flex items-start gap-3">
                                        <!-- Back button (always visible) -->
                                        <button onclick="showSubjects()" class="flex-shrink-0 p-2 mt-1 text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-lg transition-colors" title="বিষয় তালিকায় ফিরুন">
                                            <i data-lucide="arrow-left" class="h-5 w-5"></i>
                                        </button>
                                        <!-- Toggle Sidebar Button -->
                                        <button onclick="toggleSidebar()" class="flex-shrink-0 p-2 mt-1 text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-lg transition-colors" title="সূচিপত্র দেখান/লুকান">
                                            <i data-lucide="panel-left" class="h-5 w-5"></i>
                                        </button>
                                        <div class="flex-grow min-w-0">
                                            <h1 id="chapter-title" class="text-lg md:text-2xl font-bold text-gray-900 dark:text-white truncate">স্বাগতম</h1>
                                            <p id="reader-subject-title" class="text-xs md:text-sm text-gray-500 mt-1 truncate">বিষয় নির্বাচন করুন</p>
                                        </div>

                        <!-- Collapse header button -->
                        <button onclick="toggleHeaderCollapse()" title="হেডার লুকান / পুরো পর্দায় দেখুন"
                            class="flex-shrink-0 p-2 mt-1 rounded-lg text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                            <i data-lucide="chevrons-up" class="h-5 w-5"></i>
                        </button>

                        <!-- Tools dropdown -->
                        <div class="relative flex-shrink-0" id="tools-menu-wrapper" style="overflow:visible">
                            <button onclick="toggleToolsMenu()" id="tools-menu-btn" title="টুলস মেনু" class="p-2 mt-1 rounded-lg text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                                <i data-lucide="settings-2" class="h-5 w-5"></i>
                            </button>
                            <div id="tools-menu-panel" class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl shadow-xl overflow-hidden min-w-[190px]" style="position:fixed;z-index:99999;display:none">
                                <div class="flex flex-col py-1">
                                    <button onclick="closeToolsMenu();document.getElementById('restore-file-input').click();" class="flex items-center gap-2.5 px-4 py-2.5 text-sm text-green-600 dark:text-green-400 hover:bg-gray-50 dark:hover:bg-gray-700 transition w-full text-left">
                                        <i data-lucide="upload-cloud" class="h-4 w-4"></i> রিস্টোর ডাটা
                                    </button>
                                    <button onclick="closeToolsMenu();confirmReset();" class="flex items-center gap-2.5 px-4 py-2.5 text-sm text-red-500 hover:bg-gray-50 dark:hover:bg-gray-700 transition w-full text-left">
                                        <i data-lucide="rotate-ccw" class="h-4 w-4"></i> রিসেট
                                    </button>
                                    <button onclick="closeToolsMenu();exportData();" class="flex items-center gap-2.5 px-4 py-2.5 text-sm text-indigo-600 dark:text-indigo-400 hover:bg-gray-50 dark:hover:bg-gray-700 transition w-full text-left">
                                        <i data-lucide="download" class="h-4 w-4"></i> ব্যাকআপ
                                    </button>
                                    <button onclick="closeToolsMenu();openStatsModal();" class="flex items-center gap-2.5 px-4 py-2.5 text-sm text-purple-600 dark:text-purple-400 hover:bg-gray-50 dark:hover:bg-gray-700 transition w-full text-left">
                                        <i data-lucide="bar-chart-3" class="h-4 w-4"></i> পরিসংখ্যান
                                    </button>
                                    <div class="border-t border-gray-100 dark:border-gray-700 my-1"></div>
                                    <button onclick="closeToolsMenu();toggleTheme();" class="flex items-center gap-2.5 px-4 py-2.5 text-sm text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition w-full text-left">
                                        <i data-lucide="moon" id="theme-icon" class="h-4 w-4"></i> থিম পরিবর্তন
                                    </button>
                                </div>
                            </div>
                        </div>
                                    </div>
                                </div>

                                
                                <!-- Tabs + actions row -->
                                <div id="content-tabs" class="hidden" style="display:none">
                                    <div class="flex items-center overflow-x-auto border-t border-gray-100 dark:border-gray-800">
                                        <div class="flex flex-1 min-w-0">
                                            <button onclick="switchTab('text')" id="tab-btn-text" class="tab-btn px-4 py-2.5 text-sm font-medium text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 flex items-center gap-2 whitespace-nowrap">
                                                <i data-lucide="file-text" class="h-4 w-4"></i> ডিজিটাল পাঠ
                                            </button>
                                            <button onclick="switchTab('pdf')" id="tab-btn-pdf" class="tab-btn px-4 py-2.5 text-sm font-medium text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 flex items-center gap-2 whitespace-nowrap">
                                                <i data-lucide="file" class="h-4 w-4"></i> মূল বই (PDF)
                                            </button>
                                            <button onclick="switchTab('video')" id="tab-btn-video" class="tab-btn px-4 py-2.5 text-sm font-medium text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 flex items-center gap-2 whitespace-nowrap">
                                                <i data-lucide="youtube" class="h-4 w-4"></i> টিউটোরিয়াল
                                            </button>
                                            <button onclick="switchTab('qna')" id="tab-btn-qna" class="tab-btn px-4 py-2.5 text-sm font-medium text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 flex items-center gap-2 whitespace-nowrap">
                                                <i data-lucide="help-circle" class="h-4 w-4"></i> প্রশ্ন ও উত্তর
                                            </button>
                                        </div>
                                        <!-- Per-tab action buttons -->
                                        <div class="flex-shrink-0 flex items-center gap-1 px-3 border-l border-gray-100 dark:border-gray-800">
                                            <div id="tab-actions-text" style="display:none" class="hidden items-center gap-1">
                                                <button onclick="openAddTextLinkModal()" class="text-purple-600 hover:bg-purple-50 dark:hover:bg-gray-700 px-2.5 py-1.5 rounded-lg text-xs flex items-center gap-1 transition">
                                                    <i data-lucide="cloud" class="h-3.5 w-3.5"></i> ক্লাউড লিংক
                                                </button>
                                                <label class="cursor-pointer text-indigo-600 hover:bg-indigo-50 dark:hover:bg-gray-700 px-2.5 py-1.5 rounded-lg text-xs flex items-center gap-1 transition">
                                                    <i data-lucide="upload" class="h-3.5 w-3.5"></i> ফাইল
                                                    <input type="file" class="hidden" accept=".txt,.md" onchange="loadLocalTextFile(this)">
                                                </label>
                                                <button onclick="openEditContentModal('text')" class="text-indigo-600 hover:bg-indigo-50 dark:hover:bg-gray-700 px-2.5 py-1.5 rounded-lg text-xs flex items-center gap-1 transition">
                                                    <i data-lucide="edit" class="h-3.5 w-3.5"></i> এডিট
                                                </button>
                                            </div>
                                            <div id="tab-actions-pdf" style="display:none" class="hidden items-center gap-1">
                                                <label class="cursor-pointer text-indigo-600 hover:bg-indigo-50 dark:hover:bg-gray-700 px-2.5 py-1.5 rounded-lg text-xs flex items-center gap-1 transition">
                                                    <i data-lucide="folder-open" class="h-3.5 w-3.5"></i> Local PDF
                                                    <input type="file" class="hidden" accept="application/pdf" onchange="loadLocalPdfFile(this)">
                                                </label>
                                                <button onclick="openEditContentModal('pdf')" class="text-indigo-600 hover:bg-indigo-50 dark:hover:bg-gray-700 px-2.5 py-1.5 rounded-lg text-xs flex items-center gap-1 transition">
                                                    <i data-lucide="settings" class="h-3.5 w-3.5"></i> ম্যানেজ
                                                </button>
                                            </div>
                                            <div id="tab-actions-video" style="display:none" class="hidden items-center gap-1"></div>
                                            <div id="tab-actions-qna" style="display:none" class="hidden items-center gap-1">
                                                <div class="bg-gray-200 dark:bg-gray-700 rounded-lg p-0.5 flex mr-1">
                                                    <button onclick="toggleQnaView('list')" id="btn-qna-list" class="px-2.5 py-1 text-xs rounded-md bg-white dark:bg-gray-600 text-gray-800 dark:text-white font-medium shadow-sm transition">List</button>
                                                    <button onclick="toggleQnaView('card')" id="btn-qna-card" class="px-2.5 py-1 text-xs rounded-md text-gray-500 dark:text-gray-400 hover:text-gray-700 transition">Flashcard</button>
                                                </div>
                                                <button onclick="openEditContentModal('qna')" class="text-indigo-600 hover:bg-indigo-50 dark:hover:bg-gray-700 px-2.5 py-1.5 rounded-lg text-xs flex items-center gap-1 transition">
                                                    <i data-lucide="plus-circle" class="h-3.5 w-3.5"></i> প্রশ্ন যুক্ত করুন
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Content Body -->
                            <div id="content-body" class="flex-grow overflow-y-auto p-0 relative bg-white dark:bg-gray-900 custom-scrollbar" style="scroll-behavior: auto;">
                                
                                <!-- Empty State -->
                                <div id="content-empty" class="flex flex-col items-center justify-center h-full text-gray-400 p-8 text-center">
                                    <i data-lucide="book-open" class="h-16 w-16 mb-4 opacity-20"></i>
                                    <p>বাম পাশের তালিকা থেকে একটি অধ্যায় নির্বাচন করুন।</p>
                                </div>

                                <!-- Tab: Text (Digital) -->
                                <div id="tab-content-text" class="hidden flex flex-col min-h-full">

                                    <div id="loading-indicator" class="hidden flex justify-center items-center py-10">
                                        <i data-lucide="loader-2" class="animate-spin h-8 w-8 text-indigo-600"></i>
                                    </div>
                                    <div id="render-markdown" class="prose dark:prose-invert max-w-none p-6 md:p-10"></div>
                                    <div id="empty-text-msg" class="hidden flex-grow flex flex-col items-center justify-center text-gray-400">
                                        <i data-lucide="file-text" class="h-10 w-10 mb-2 opacity-30"></i>
                                        <p>কোন টেক্সট নেই</p>
                                    </div>
                                </div>

                                <!-- Tab: PDF (Advanced Multi-Doc) -->
                                <div id="tab-content-pdf" class="hidden h-full flex flex-row" style="overflow:hidden">
                                    <!-- PDF Sidebar List -->
                                    <div id="pdf-sidebar" class="w-48 bg-gray-50 dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700 hidden flex-col">
                                        <div class="p-3 border-b border-gray-200 dark:border-gray-700 font-bold text-xs text-gray-500">RESOURCES</div>
                                        <div id="pdf-list-container" class="flex-grow overflow-y-auto"></div>
                                        <button onclick="openEditContentModal('pdf')" class="p-3 text-indigo-600 text-xs font-bold border-t border-gray-200 dark:border-gray-700 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center justify-center gap-1">
                                            <i data-lucide="plus-circle" class="h-3 w-3"></i> ম্যানেজ করুন
                                        </button>
                                    </div>

                                    <div class="flex-grow flex flex-col h-full relative">
                                        <!-- Floating sidebar toggle button -->
                                        <button id="toggle-pdf-sidebar"
                                            title="PDF তালিকা দেখান/লুকান"
                                            style="position:absolute;bottom:8px;left:8px;z-index:10"
                                            class="flex items-center gap-1.5 px-2.5 py-1.5 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-lg shadow text-gray-600 dark:text-gray-300 text-xs font-medium hover:bg-gray-50 dark:hover:bg-gray-700 transition">
                                            <i data-lucide="panel-left" class="h-3.5 w-3.5"></i>
                                        </button>

                                        <iframe id="pdf-frame" class="w-full flex-grow border-none" src=""></iframe>
                                        <div id="empty-pdf-msg" class="hidden flex-grow flex flex-col items-center justify-center text-gray-400">
                                            <i data-lucide="file-question" class="h-10 w-10 mb-2 opacity-30"></i>
                                            <p>কোন PDF নির্বাচন করা হয়নি</p>
                                            <button onclick="openEditContentModal('pdf')" class="mt-4 px-4 py-2 bg-indigo-600 text-white rounded text-sm">নতুন PDF যুক্ত করুন</button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Tab: Video (Advanced YouTube) -->
                                <div id="tab-content-video" class="hidden h-full flex-col" style="min-height:0;overflow:hidden">
                                    <iframe id="youtube-tab-iframe"
                                        style="width:100%;height:100%;border:none;display:block;flex:1"
                                        sandbox="allow-scripts allow-same-origin allow-popups allow-forms allow-modals allow-popups-to-escape-sandbox"
                                        srcdoc="<!DOCTYPE html>
<html lang=&quot;bn&quot;>
<head>
  <meta charset=&quot;UTF-8&quot;>
  <meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;>
  <title>YouTube Clone</title>
  
  <!-- Tailwind CSS CDN -->
  <script src=&quot;https://cdn.tailwindcss.com&quot;></script>
  
  <!-- FontAwesome for Icons -->
  <link rel=&quot;stylesheet&quot; href=&quot;https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css&quot;>
  
  <!-- React &amp; ReactDOM CDN -->
  <script src=&quot;https://unpkg.com/react@18/umd/react.production.min.js&quot; crossorigin></script>
  <script src=&quot;https://unpkg.com/react-dom@18/umd/react-dom.production.min.js&quot; crossorigin></script>
  
  <!-- Babel for JSX compilation in browser -->
  <script src=&quot;https://unpkg.com/@babel/standalone/babel.min.js&quot;></script>

  <!-- YouTube Iframe API -->
  <script src=&quot;https://www.youtube.com/iframe_api&quot;></script>
  <script>
    window.ytApiLoaded = false;
    function onYouTubeIframeAPIReady() {
      window.ytApiLoaded = true;
      window.dispatchEvent(new Event('yt-api-ready'));
    }
  </script>
  <style>
    /* Custom Scrollbar */
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #555; border-radius: 10px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #888; }
  </style>
</head>
<body class=&quot;bg-[#0f0f0f] text-white font-sans&quot;>
  <div id=&quot;root&quot;></div>

  <script type=&quot;text/babel&quot;>

    // Chapter-scoped localStorage — every key is prefixed with chapter ID
    window._chapterId = window._chapterId || 'global';
    function lsKey(name) { return 'ytClone_' + window._chapterId + '_' + name; }

    const { useState, useEffect, useRef } = React;

    const initialVideos = [];

    function parseMediaInput(input) {
      let videoId = null;
      let listId = null;
      let driveId = null;
      let externalUrl = null;
      let title = '';
      let urlStr = input.replace(/&amp;amp;/g, '&amp;');

      const iframeMatch = urlStr.match(/src=[&quot;'](.*?)[&quot;']/);
      if (iframeMatch) urlStr = iframeMatch[1];
      const titleMatch = input.match(/title=[&quot;'](.*?)[&quot;']/);
      if (titleMatch) title = titleMatch[1];
      
      if(title.toLowerCase() === 'youtube video player' || title.toLowerCase() === 'custom video') title = ''; 

      try {
        if (urlStr.includes('photos.app.goo.gl') || urlStr.includes('photos.google.com')) {
            externalUrl = urlStr;
            return { videoId, listId, driveId, externalUrl, title };
        }

        if (urlStr.includes('drive.google.com')) {
            const driveMatch = urlStr.match(/\/d\/([a-zA-Z0-9_-]+)/);
            if (driveMatch) driveId = driveMatch[1];
            return { videoId, listId, driveId, title };
        }

        if (!urlStr.startsWith('http') &amp;&amp; !urlStr.startsWith('//')) urlStr = 'https://' + urlStr;
        else if (urlStr.startsWith('//')) urlStr = 'https:' + urlStr;
        
        const url = new URL(urlStr);
        if (url.searchParams.has('v')) videoId = url.searchParams.get('v');
        if (url.searchParams.has('list')) listId = url.searchParams.get('list');
        
        if (url.pathname.startsWith('/embed/')) {
          const pathParts = url.pathname.split('/');
          const id = pathParts[pathParts.length - 1];
          if (id &amp;&amp; id !== 'videoseries') videoId = id;
        } else if (url.hostname.includes('youtu.be')) {
          videoId = url.pathname.slice(1);
        }
      } catch (e) {
        console.error(&quot;URL Error&quot;, e);
      }
      return { videoId, listId, driveId, externalUrl, title };
    }

    const generateThumbnail = (file) => {
        return new Promise((resolve) => {
            const video = document.createElement('video');
            video.preload = 'metadata';
            video.src = URL.createObjectURL(file);
            video.muted = true;
            video.playsInline = true;
            
            video.addEventListener('loadedmetadata', () => {
                video.currentTime = Math.min(1, video.duration / 2 || 0); 
            });

            video.addEventListener('seeked', () => {
                try {
                    const canvas = document.createElement('canvas');
                    canvas.width = video.videoWidth || 640;
                    canvas.height = video.videoHeight || 360;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    resolve(canvas.toDataURL('image/jpeg'));
                } catch (e) {
                    resolve('https://placehold.co/640x360/10B981/FFFFFF/png?text=Local+Video');
                }
                URL.revokeObjectURL(video.src);
            });

            video.addEventListener('error', () => {
                resolve('https://placehold.co/640x360/10B981/FFFFFF/png?text=Local+Video');
                URL.revokeObjectURL(video.src);
            });
        });
    };

    function HoverPlayer({ video, savedTime, onPlay }) {
        const playerContainerRef = useRef(null);
        const playerRef = useRef(null);

        if (video.provider === 'local') {
            let blobUrl = video.blobUrl;
            let currentId = video.id;
            
            if (video.type === 'local_playlist' &amp;&amp; video.videoObjects?.length > 0) {
                blobUrl = video.videoObjects[0].blobUrl;
                currentId = video.videoObjects[0].id;
            }

            return (
                <div className=&quot;absolute inset-0 z-10 bg-black rounded-lg overflow-hidden group/player pointer-events-auto&quot;>
                    <video 
                        src={blobUrl} 
                        className=&quot;w-full h-full object-cover pointer-events-auto&quot; 
                        autoPlay 
                        muted 
                        controls
                        onLoadedMetadata={(e) => {
                             const times = JSON.parse(localStorage.getItem(lsKey('Times')) || '{}');
                             if (times[currentId] &amp;&amp; times[currentId] > 0) {
                                 e.target.currentTime = times[currentId];
                             }
                        }}
                    />
                    <div 
                        className=&quot;absolute top-0 left-0 right-0 bottom-[45px] z-20 cursor-pointer&quot;
                        onClick={(e) => {
                            e.stopPropagation();
                            onPlay();
                        }}
                    ></div>
                </div>
            );
        }

        useEffect(() => {
            if (!window.YT || !video.videoId) return;
            
            const playerDiv = document.createElement('div');
            playerDiv.style.width = '100%';
            playerDiv.style.height = '100%';
            playerContainerRef.current.appendChild(playerDiv);

            playerRef.current = new window.YT.Player(playerDiv, {
                videoId: video.videoId,
                playerVars: { 
                    autoplay: 1, 
                    mute: 1, 
                    start: savedTime || 0, 
                    controls: 1, 
                    modestbranding: 1, 
                    playsinline: 1, 
                    rel: 0,
                    showinfo: 0,
                    fs: 0
                }
            });

            return () => {
                if (playerRef.current &amp;&amp; typeof playerRef.current.destroy === 'function') {
                    playerRef.current.destroy();
                }
                if (playerContainerRef.current) {
                    playerContainerRef.current.innerHTML = '';
                }
            };
        }, [video.videoId, savedTime]);

        return (
            <div className=&quot;absolute inset-0 z-10 bg-black rounded-lg overflow-hidden group/player pointer-events-auto&quot;>
                <div className=&quot;w-full h-full pointer-events-auto&quot; ref={playerContainerRef}></div>
                <div 
                    className=&quot;absolute top-0 left-0 right-0 bottom-[45px] z-20 cursor-pointer&quot;
                    onClick={(e) => {
                        e.stopPropagation();
                        onPlay();
                    }}
                ></div>
            </div>
        );
    }

    function SidebarToggle({ icon, label, isExpanded, onToggle, children, isOpen, scrollable }) {
        return (
            <>
                <div 
                    onClick={onToggle} 
                    className={`flex items-center ${isOpen ? 'justify-start px-3' : 'justify-center flex-col'} py-2.5 my-1 rounded-xl cursor-pointer transition-colors ${isExpanded ? 'bg-white/10 font-bold' : 'hover:bg-white/10'}`}
                >
                    <div className={`flex items-center justify-center ${isOpen ? 'mr-4' : 'mb-1'} ${isExpanded ? 'text-white' : 'text-gray-200'}`}>{icon}</div>
                    <span className={`${isOpen ? 'text-sm' : 'text-[10px]'} flex-1 ${isExpanded ? 'text-white font-semibold' : 'text-gray-200'} whitespace-nowrap overflow-hidden text-ellipsis`}>{label}</span>
                    {isOpen &amp;&amp; <i className={`fas fa-chevron-down text-xs text-gray-400 transition-transform ${isExpanded ? 'rotate-180' : ''}`}></i>}
                </div>
                {isExpanded &amp;&amp; isOpen &amp;&amp; (
                    <div className={`flex flex-col gap-2 px-2 mt-1 mb-3 ${scrollable ? 'max-h-[260px] overflow-y-auto custom-scrollbar pr-1' : ''}`}>
                        {children}
                    </div>
                )}
            </>
        );
    }

    function App() {
      const [videos, setVideos] = useState(() => {
        // Always use chapter videos sent from SmartPathshala via postMessage
        return window._chapterInitVideos || [];
      });

      const [currentVideo, setCurrentVideo] = useState(null);
      const [searchQuery, setSearchQuery] = useState('');
      const [isSidebarOpen, setIsSidebarOpen] = useState(true);
      
      const [watchHistory, setWatchHistory] = useState([]);
      const [lastWatched, setLastWatched] = useState(null);
      
      const [isAllVideosExpanded, setIsAllVideosExpanded] = useState(false);
      const [isAllPlaylistsExpanded, setIsAllPlaylistsExpanded] = useState(false);
      const [isCurrentPlaylistExpanded, setIsCurrentPlaylistExpanded] = useState(true);
      const [isHistoryExpanded, setIsHistoryExpanded] = useState(false);
      
      const [gridCols, setGridCols] = useState(4);

      const [playlistQueue, setPlaylistQueue] = useState([]);
      const [currentPlaylistIndex, setCurrentPlaylistIndex] = useState(0);
      const [fetchedMeta, setFetchedMeta] = useState({});

      const [alertState, setAlertState] = useState({ isOpen: false, message: '' });
      const [confirmState, setConfirmState] = useState({ isOpen: false, message: '', targetId: null });

      const [isAddModalOpen, setIsAddModalOpen] = useState(false);
      const [isLocalModalOpen, setIsLocalModalOpen] = useState(false);
      
      const [newMediaInput, setNewMediaInput] = useState({ link: '', title: '', channel: '' });
      const [isCreateListModalOpen, setIsCreateListModalOpen] = useState(false);
      const [newListTitle, setNewListTitle] = useState('');
      const [selectedVideoIds, setSelectedVideoIds] = useState([]);

      const [isMiniplayer, setIsMiniplayer] = useState(false);
      const [isTheaterMode, setIsTheaterMode] = useState(false);
      const [playerRect, setPlayerRect] = useState(null); 
      const [isDragging, setIsDragging] = useState(false);
      const [dragOffset, setDragOffset] = useState({ x: 0, y: 0 });
      const [resizeState, setResizeState] = useState({ active: false, dir: null, startX: 0, startY: 0, startLeft: 0, startTop: 0, startWidth: 0, startHeight: 0 });

      const [progressData, setProgressData] = useState({ times: {}, durations: {} });
      const [hoveredVideo, setHoveredVideo] = useState(null);
      const hoverTimeout = useRef(null);

      const [ytReady, setYtReady] = useState(window.ytApiLoaded);
      const ytContainerRef = useRef(null);
      const playerRef = useRef(null);
      const timeIntervalRef = useRef(null);
      const localVideoRef = useRef(null);
      const popupWindowRef = useRef(null); // পপ-আপ উইন্ডোর রেফারেন্স ধরে রাখার জন্য নতুন Ref
      
      const [autoPlay, setAutoPlay] = useState(false); 

      const currentVideoData = currentVideo ? (videos.find(v => v.id === currentVideo.id) || currentVideo) : null;

      useEffect(() => {
        // Chapter-scoped: load only this chapter's history &amp; progress, never auto-miniplayer
        const savedHistory = localStorage.getItem(lsKey('History'));
        if (savedHistory) {
            let parsedHistory = JSON.parse(savedHistory).filter(v => v.provider !== 'local');
            setWatchHistory(parsedHistory);
        }
        setProgressData({
            times: JSON.parse(localStorage.getItem(lsKey('Times')) || '{}'),
            durations: JSON.parse(localStorage.getItem(lsKey('Durations')) || '{}')
        });
        const handleReady = () => setYtReady(true);
        window.addEventListener('yt-api-ready', handleReady);
        return () => window.removeEventListener('yt-api-ready', handleReady);
      }, []);

      useEffect(() => {
        let isMounted = true;
        const fetchMissingTitles = () => {
            if(currentVideoData?.provider === 'local') return;
            playlistQueue.forEach(vidId => {
                const existsLocally = videos.find(v => v.videoId === vidId);
                if (!existsLocally) {
                    setFetchedMeta(prev => {
                        if (prev[vidId]) return prev;
                        fetch(`https://noembed.com/embed?url=https://www.youtube.com/watch?v=${vidId}`)
                            .then(res => res.json())
                            .then(data => {
                                if (data &amp;&amp; data.title &amp;&amp; isMounted) {
                                    setFetchedMeta(current => ({ ...current, [vidId]: { title: data.title, channel: data.author_name } }));
                                }
                            }).catch(() => {});
                        return { ...prev, [vidId]: { loading: true } };
                    });
                }
            });
        };

        if (playlistQueue.length > 0) fetchMissingTitles();
        return () => { isMounted = false; };
      }, [playlistQueue, videos, currentVideoData]);

      const handleMouseEnter = (video) => {
          if (video.type === 'video' &amp;&amp; video.provider !== 'gdrive' &amp;&amp; video.provider !== 'external' &amp;&amp; (video.videoId || video.blobUrl)) {
              hoverTimeout.current = setTimeout(() => {
                  setHoveredVideo(video.id);
              }, 600); 
          }
      };

      const handleMouseLeave = () => {
          if (hoverTimeout.current) clearTimeout(hoverTimeout.current);
          setHoveredVideo(null);
      };

      const handleLocalFiles = async (e, isFolder) => {
          const files = Array.from(e.target.files).filter(f => f.type.startsWith('video/'));
          if (files.length === 0) {
              setAlertState({ isOpen: true, message: 'কোনো সঠিক ভিডিও ফাইল পাওয়া যায়নি!' });
              return;
          }

          setIsLocalModalOpen(false); 
          
          setTimeout(() => {
              setAlertState({ isOpen: true, message: 'ফাইলগুলো প্রসেস করা হচ্ছে, দয়া করে একটু অপেক্ষা করুন...' });
          }, 100);

          let updated = [...videos];

          if (isFolder &amp;&amp; files.length > 1) {
              const folderName = files[0].webkitRelativePath.split('/')[0] || 'লোকাল ফোল্ডার';
              const playlistId = 'local-folder-' + Date.now();
              
              const vidsWithThumbs = [];
              for(let i=0; i<files.length; i++){
                  const f = files[i];
                  const thumb = await generateThumbnail(f);
                  vidsWithThumbs.push({
                      id: playlistId + '-vid-' + i,
                      videoId: playlistId + '-vid-' + i,
                      title: f.name.replace(/\.[^/.]+$/, &quot;&quot;),
                      channel: 'Local Storage',
                      views: 'Local File',
                      thumbnail: thumb,
                      type: 'video',
                      provider: 'local',
                      fileObj: f,
                      blobUrl: URL.createObjectURL(f)
                  });
              }

              const playlist = {
                  id: playlistId,
                  listId: playlistId,
                  title: folderName,
                  channel: 'Local Storage',
                  views: `${vidsWithThumbs.length} ভিডিও`,
                  thumbnail: vidsWithThumbs[0]?.thumbnail || 'https://placehold.co/640x360/3B82F6/FFFFFF/png?text=Local+Folder',
                  type: 'local_playlist',
                  provider: 'local',
                  videoObjects: vidsWithThumbs
              };
              
              updated = [playlist, ...videos];
          } else {
              const newVideos = [];
              for(let i=0; i<files.length; i++){
                  const f = files[i];
                  const thumb = await generateThumbnail(f);
                  newVideos.push({
                      id: 'local-vid-' + Date.now() + '-' + i,
                      videoId: 'local-vid-' + Date.now() + '-' + i,
                      title: f.name.replace(/\.[^/.]+$/, &quot;&quot;),
                      channel: 'Local Storage',
                      views: 'Local File',
                      thumbnail: thumb,
                      type: 'video',
                      provider: 'local',
                      fileObj: f,
                      blobUrl: URL.createObjectURL(f)
                  });
              }
              updated = [...newVideos, ...videos];
          }

          setVideos(updated);
          
          const storable = updated.filter(v => v.provider !== 'local');
          localStorage.setItem(lsKey('Videos'), JSON.stringify(storable));
        try { window.parent.postMessage({ type: 'ytVideosChanged', videos: storable, chapterId: window._chapterId }, '*'); } catch(e) {}
          
          setAlertState({ isOpen: false, message: '' }); 
      };

      useEffect(() => {
        if (!ytReady) return;
        
        if (!currentVideo) {
            if (playerRef.current) {
                playerRef.current.destroy();
                playerRef.current = null;
            }
            return;
        }

        if (currentVideo.provider === 'gdrive' || currentVideo.driveId || currentVideo.provider === 'local' || currentVideo.provider === 'external') {
            if (playerRef.current &amp;&amp; typeof playerRef.current.pauseVideo === 'function') {
                playerRef.current.pauseVideo();
            }
            return;
        }

        const currentTimes = JSON.parse(localStorage.getItem(lsKey('Times')) || '{}');
        const startSeconds = currentTimes[currentVideo.id] || 0;

        const savedIndexes = JSON.parse(localStorage.getItem(lsKey('PlaylistIndexes')) || '{}');
        const startIndex = savedIndexes[currentVideo.id] || 0;

        const isPlaylist = currentVideo.type === 'playlist';
        const isLocalPlaylist = currentVideo.type === 'local_playlist';
        
        let playerVars = { autoplay: autoPlay ? 1 : 0, start: startSeconds, enablejsapi: 1, playsinline: 1 };

        if (!playerRef.current) {
            if (ytContainerRef.current) {
                const playerDiv = document.createElement('div');
                ytContainerRef.current.appendChild(playerDiv);

                playerRef.current = new window.YT.Player(playerDiv, {
                    height: '100%', width: '100%',
                    videoId: isLocalPlaylist ? currentVideo.videoIds[0] : (currentVideo.videoId || ''),
                    playerVars: playerVars,
                    events: {
                        onReady: (e) => { 
                            if (isPlaylist) {
                                if (autoPlay) e.target.loadPlaylist({ list: currentVideo.listId, listType: 'playlist', index: startIndex, startSeconds: startSeconds });
                                else e.target.cuePlaylist({ list: currentVideo.listId, listType: 'playlist', index: startIndex, startSeconds: startSeconds });
                            } else if (isLocalPlaylist) {
                                if (autoPlay) e.target.loadPlaylist({ playlist: currentVideo.videoIds, index: startIndex, startSeconds: startSeconds });
                                else e.target.cuePlaylist({ playlist: currentVideo.videoIds, index: startIndex, startSeconds: startSeconds });
                            } else {
                                if (autoPlay) e.target.playVideo();
                            }
                        },
                        onStateChange: (e) => {
                            if (e.data === window.YT.PlayerState.PLAYING || e.data === window.YT.PlayerState.UNSTARTED || e.data === window.YT.PlayerState.CUED) {
                                if (currentVideo.type.includes('playlist')) {
                                    const queue = e.target.getPlaylist();
                                    if (queue &amp;&amp; queue.length > 0) {
                                        setPlaylistQueue(queue);
                                        const idx = e.target.getPlaylistIndex();
                                        if (idx !== null &amp;&amp; idx !== undefined &amp;&amp; idx !== -1) {
                                            setCurrentPlaylistIndex(idx);
                                        }
                                        
                                        setVideos(prev => {
                                            let changed = false;
                                            const updated = prev.map(v => {
                                                if (v.id === currentVideo.id) {
                                                    const expectedThumb = `https://img.youtube.com/vi/${queue[0]}/hqdefault.jpg`;
                                                    if (v.thumbnail !== expectedThumb) {
                                                        changed = true;
                                                        return { ...v, thumbnail: expectedThumb };
                                                    }
                                                }
                                                return v;
                                            });
                                            if (changed) {
                                                const storable = updated.filter(v => v.provider !== 'local');
                                                localStorage.setItem(lsKey('Videos'), JSON.stringify(storable));
        try { window.parent.postMessage({ type: 'ytVideosChanged', videos: storable, chapterId: window._chapterId }, '*'); } catch(e) {}
                                            }
                                            return changed ? updated : prev;
                                        });
                                    }
                                }
                            }

                            if (e.data === window.YT.PlayerState.PLAYING) {
                                if (currentVideo.type.includes('playlist')) {
                                    const currentIdx = e.target.getPlaylistIndex();
                                    if (currentIdx !== null &amp;&amp; currentIdx !== undefined &amp;&amp; currentIdx !== -1) {
                                        const indexes = JSON.parse(localStorage.getItem(lsKey('PlaylistIndexes')) || '{}');
                                        if (indexes[currentVideo.id] !== currentIdx) {
                                            indexes[currentVideo.id] = currentIdx;
                                            localStorage.setItem(lsKey('PlaylistIndexes'), JSON.stringify(indexes));
                                            
                                            const times = JSON.parse(localStorage.getItem(lsKey('Times')) || '{}');
                                            times[currentVideo.id] = 0;
                                            localStorage.setItem(lsKey('Times'), JSON.stringify(times));
                                        }
                                    }
                                } else {
                                    const vData = e.target.getVideoData();
                                    if (vData &amp;&amp; vData.title) {
                                        setVideos(prev => {
                                            let changed = false;
                                            const updated = prev.map(v => {
                                                if (v.id === currentVideo.id &amp;&amp; (v.title === 'YouTube Video' || v.title === 'Custom Video' || v.title === '')) {
                                                    changed = true;
                                                    return { ...v, title: vData.title };
                                                }
                                                return v;
                                            });
                                            if(changed) {
                                                const storable = updated.filter(v => v.provider !== 'local');
                                                localStorage.setItem(lsKey('Videos'), JSON.stringify(storable));
        try { window.parent.postMessage({ type: 'ytVideosChanged', videos: storable, chapterId: window._chapterId }, '*'); } catch(e) {}
                                            }
                                            return changed ? updated : prev;
                                        });
                                    }
                                }

                                timeIntervalRef.current = setInterval(() => {
                                    if (playerRef.current &amp;&amp; playerRef.current.getCurrentTime &amp;&amp; playerRef.current.getDuration) {
                                        const time = Math.floor(playerRef.current.getCurrentTime());
                                        const duration = Math.floor(playerRef.current.getDuration());
                                        
                                        const times = JSON.parse(localStorage.getItem(lsKey('Times')) || '{}');
                                        const durations = JSON.parse(localStorage.getItem(lsKey('Durations')) || '{}');
                                        
                                        times[currentVideo.id] = time;
                                        durations[currentVideo.id] = duration;
                                        
                                        localStorage.setItem(lsKey('Times'), JSON.stringify(times));
                                        localStorage.setItem(lsKey('Durations'), JSON.stringify(durations));

                                        setProgressData({ times, durations }); 
                                    }
                                }, 1000);
                            } else {
                                clearInterval(timeIntervalRef.current);
                            }
                        }
                    }
                });
            }
        } else {
            if (isPlaylist) {
                if (autoPlay) playerRef.current.loadPlaylist({ list: currentVideo.listId, listType: 'playlist', index: startIndex, startSeconds });
                else playerRef.current.cuePlaylist({ list: currentVideo.listId, listType: 'playlist', index: startIndex, startSeconds });
            } else if (isLocalPlaylist) {
                if (autoPlay) playerRef.current.loadPlaylist({ playlist: currentVideo.videoIds, index: startIndex, startSeconds });
                else playerRef.current.cuePlaylist({ playlist: currentVideo.videoIds, index: startIndex, startSeconds });
            } else {
                if (autoPlay) playerRef.current.loadVideoById({ videoId: currentVideo.videoId, startSeconds });
                else playerRef.current.cueVideoById({ videoId: currentVideo.videoId, startSeconds });
            }
        }

        return () => clearInterval(timeIntervalRef.current);
      }, [currentVideo, ytReady, autoPlay]);

      const activateMiniplayer = () => {
        if (!playerRect) {
            const w = 384;
            const h = w * (9/16) + 40;
            setPlayerRect({ left: window.innerWidth - w - 24, top: window.innerHeight - h - 24, width: w, height: h });
        }
        setIsMiniplayer(true);
      };

      const playVideo = (video) => {
        if (video.provider === 'external') {
            setCurrentVideo(video);
            setIsTheaterMode(true);
            setIsMiniplayer(false);
            setAutoPlay(true);
            
            setTimeout(() => {
                const container = document.getElementById('video-player-container');
                if (!container) return;
                
                const rect = container.getBoundingClientRect();
                
                // জুম এবং স্কেলিং রেশিও ফিক্স
                const zoomRatio = window.devicePixelRatio || 1;
                
                // ব্রাউজারের স্ক্রিন পজিশন
                const screenX = window.screenX !== undefined ? window.screenX : window.screenLeft;
                const screenY = window.screenY !== undefined ? window.screenY : window.screenTop;
                
                // Edge Vertical Tabs এর সাইজ ক্যালকুলেশন
                const chromeWidth = window.outerWidth - window.innerWidth;
                const chromeHeight = window.outerHeight - window.innerHeight;
                
                // Edge এ Vertical Tabs অন থাকলে বামদিকে জায়গা নেয়
                const leftChromeOffset = chromeWidth > 40 ? chromeWidth - 10 : 8; 
                const topChromeOffset = chromeHeight > 40 ? chromeHeight - 10 : 85;
                
                // পপ-আপের এক্স্যাক্ট পজিশন (জুমের সাথে মাল্টিপ্লাই করে ফিজিক্যাল পিক্সেলে নেয়া হলো)
                const left = Math.round(screenX + leftChromeOffset + (rect.left * zoomRatio));
                const top = Math.round(screenY + topChromeOffset + (rect.top * zoomRatio));
                
                // পপ-আপ উইন্ডোর সাইজ ফিক্স (আপনার স্ক্রিনশট অনুযায়ী হাইট আরও একটু কমানো হলো)
                const popupWidth = Math.round((rect.width * zoomRatio) - 16); 
                const popupHeight = Math.round((rect.height * zoomRatio) - 70); 
                
                const features = `menubar=no,toolbar=no,location=no,status=no,scrollbars=no,resizable=yes,width=${popupWidth},height=${popupHeight},left=${left},top=${top}`;
                
                const popup = window.open(video.externalUrl, 'ExternalVideoPopup', features);
                if (popup) {
                    popup.focus();
                    popupWindowRef.current = popup; // রেফারেন্স সেভ করে রাখা হলো
                }
            }, 300); 
            
            const updatedHistory = [video, ...watchHistory.filter(v => v.id !== video.id)].slice(0, 20);
            setWatchHistory(updatedHistory);
            const storableHistory = updatedHistory.filter(v => v.provider !== 'local');
            localStorage.setItem(lsKey('History'), JSON.stringify(storableHistory));
            return;
        }

        if (currentVideo &amp;&amp; currentVideo.id === video.id) {
            setIsMiniplayer(false);
            setAutoPlay(true);
            if (video.provider !== 'local' &amp;&amp; playerRef.current &amp;&amp; typeof playerRef.current.playVideo === 'function') {
                playerRef.current.playVideo();
            }
            if (video.provider === 'local' &amp;&amp; localVideoRef.current) {
                localVideoRef.current.play();
            }
            return;
        }

        setAutoPlay(true); 
        setCurrentVideo(video);
        setIsMiniplayer(false); 
        
        if (video.provider === 'local' &amp;&amp; video.type === 'local_playlist') {
            const savedIndexes = JSON.parse(localStorage.getItem(lsKey('PlaylistIndexes')) || '{}');
            const startIndex = savedIndexes[video.id] || 0;
            
            setPlaylistQueue(video.videoObjects.map(v => v.id));
            setCurrentPlaylistIndex(startIndex);
            setIsCurrentPlaylistExpanded(true);
        } else if (video.provider !== 'local') {
            setPlaylistQueue([]); 
            setCurrentPlaylistIndex(0);
            setIsCurrentPlaylistExpanded(true); 
        }

        const updatedHistory = [video, ...watchHistory.filter(v => v.id !== video.id)].slice(0, 20);
        setWatchHistory(updatedHistory);
        
        const storableHistory = updatedHistory.filter(v => v.provider !== 'local');
        localStorage.setItem(lsKey('History'), JSON.stringify(storableHistory));
        
        if (video.provider !== 'local') {
            setLastWatched(video);
            localStorage.setItem(lsKey('LastWatched'), JSON.stringify(video));
        }
      };

      const deleteMedia = (e, id) => {
        e.stopPropagation();
        setConfirmState({ isOpen: true, message: 'আপনি কি নিশ্চিত যে এই আইটেমটি ডিলিট করতে চান?', targetId: id });
      };

      const executeDelete = () => {
        const updatedVideos = videos.filter(v => v.id !== confirmState.targetId);
        setVideos(updatedVideos);
        
        const storable = updatedVideos.filter(v => v.provider !== 'local');
        localStorage.setItem(lsKey('Videos'), JSON.stringify(storable));
        try { window.parent.postMessage({ type: 'ytVideosChanged', videos: storable, chapterId: window._chapterId }, '*'); } catch(e) {}
        
        if(currentVideo?.id === confirmState.targetId) {
            setCurrentVideo(null);
            setIsMiniplayer(false);
        }
        setConfirmState({ isOpen: false, message: '', targetId: null });
      };

      const handleAddSubmit = (e) => {
        e.preventDefault();
        const { videoId, listId, driveId, externalUrl, title: extractedTitle } = parseMediaInput(newMediaInput.link);
        
        if (!videoId &amp;&amp; !listId &amp;&amp; !driveId &amp;&amp; !externalUrl) {
            setAlertState({ isOpen: true, message: 'দয়া করে একটি সঠিক ইউটিউব, গুগল ড্রাইভ বা গুগল ফটোজ লিংক দিন।' });
            return;
        }

        const id = externalUrl ? 'ext-' + Date.now() : (driveId ? driveId : (listId ? listId : videoId));
        const type = listId ? 'playlist' : 'video';
        const provider = externalUrl ? 'external' : (driveId ? 'gdrive' : 'youtube');
        
        let finalTitle = newMediaInput.title || extractedTitle;
        if (!finalTitle) finalTitle = externalUrl ? 'Google Photos Video' : (driveId ? 'Google Drive Video' : (type === 'playlist' ? 'YouTube Playlist' : 'YouTube Video'));

        let thumbnail = 'https://placehold.co/640x360/222222/FFFFFF/png?text=Media';
        if (externalUrl) thumbnail = 'https://placehold.co/640x360/DB4437/FFFFFF/png?text=Google+Photos';
        else if (driveId) thumbnail = 'https://placehold.co/640x360/1a73e8/FFFFFF/png?text=Google+Drive';
        else if (videoId) thumbnail = `https://img.youtube.com/vi/${videoId}/hqdefault.jpg`;
        else if (listId) thumbnail = 'https://placehold.co/640x360/222222/FFFFFF/png?text=YouTube+Playlist';

        const newMedia = {
            id: id, videoId, listId, driveId, externalUrl, type, provider, title: finalTitle,
            channel: newMediaInput.channel || 'Added by User', views: externalUrl ? 'External Link' : '0 views', thumbnail,
            channelAvatar: `https://ui-avatars.com/api/?name=${newMediaInput.channel || 'User'}&amp;background=random`,
        };

        const updatedVideos = [newMedia, ...videos];
        setVideos(updatedVideos);
        
        const storable = updatedVideos.filter(v => v.provider !== 'local');
        localStorage.setItem(lsKey('Videos'), JSON.stringify(storable));
        try { window.parent.postMessage({ type: 'ytVideosChanged', videos: storable, chapterId: window._chapterId }, '*'); } catch(e) {}
        
        setIsAddModalOpen(false);
        setNewMediaInput({ link: '', title: '', channel: '' });
      };

      const handleCreatePlaylist = (e) => {
        e.preventDefault();
        if(selectedVideoIds.length === 0) {
            setAlertState({ isOpen: true, message: 'অন্তত একটি ভিডিও নির্বাচন করুন।' });
            return;
        }
        
        const firstVid = videos.find(v => v.videoId === selectedVideoIds[0]);
        const newPlaylist = {
            id: 'local-list-' + Date.now(), type: 'local_playlist', provider: 'youtube', title: newListTitle || 'My Playlist',
            videoIds: selectedVideoIds, thumbnail: firstVid ? firstVid.thumbnail : 'https://placehold.co/640x360/222222/FFFFFF/png?text=Playlist',
            channel: 'Created by You', channelAvatar: 'https://ui-avatars.com/api/?name=User&amp;background=random',
            views: selectedVideoIds.length + ' videos'
        };
        
        const updated = [newPlaylist, ...videos];
        setVideos(updated);
        
        const storable = updated.filter(v => v.provider !== 'local');
        localStorage.setItem(lsKey('Videos'), JSON.stringify(storable));
        try { window.parent.postMessage({ type: 'ytVideosChanged', videos: storable, chapterId: window._chapterId }, '*'); } catch(e) {}
        
        setIsCreateListModalOpen(false);
        setNewListTitle('');
        setSelectedVideoIds([]);
      };

      const filteredVideos = videos.filter(video => video.title.toLowerCase().includes(searchQuery.toLowerCase()) || video.channel.toLowerCase().includes(searchQuery.toLowerCase()));

      let displayTitle = currentVideoData?.title || '';
      let displayChannel = currentVideoData?.channel || '';
      let displayAvatar = currentVideoData?.channelAvatar || '';

      if (currentVideoData?.type?.includes('playlist') &amp;&amp; playlistQueue.length > 0) {
          const activeVidId = playlistQueue[currentPlaylistIndex];
          
          if (currentVideoData.provider === 'local') {
              const activeLocalVid = currentVideoData.videoObjects?.[currentPlaylistIndex];
              if (activeLocalVid) {
                  displayTitle = activeLocalVid.title;
                  displayChannel = activeLocalVid.channel;
                  displayAvatar = activeLocalVid.thumbnail;
              }
          } else if (activeVidId) {
              const localVidInfo = videos.find(v => v.videoId === activeVidId);
              const meta = fetchedMeta[activeVidId];

              if (localVidInfo) {
                  displayTitle = localVidInfo.title;
                  displayChannel = localVidInfo.channel;
                  displayAvatar = localVidInfo.channelAvatar;
              } else if (meta &amp;&amp; meta.title) {
                  displayTitle = meta.title;
                  displayChannel = meta.channel;
              } else if (meta &amp;&amp; meta.loading) {
                  displayTitle = 'লোড হচ্ছে...';
              } else {
                  displayTitle = `ভিডিও ${currentPlaylistIndex + 1}`;
              }
          }
      }

      const handleDragStart = (e) => {
        if (e.target.closest('button') || e.target.tagName.toLowerCase() === 'input') return;
        setIsDragging(true);
        const clientX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
        const clientY = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY;
        setDragOffset({ x: clientX - playerRect.left, y: clientY - playerRect.top });
      };

      const handleResizeStart = (e, dir) => {
        e.stopPropagation(); e.preventDefault();
        const clientX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
        const clientY = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY;
        setResizeState({ active: true, dir, startX: clientX, startY: clientY, startLeft: playerRect.left, startTop: playerRect.top, startWidth: playerRect.width, startHeight: playerRect.height });
      };

      useEffect(() => {
        const handleMove = (e) => {
          const clientX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
          const clientY = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY;
          
          if (isDragging &amp;&amp; playerRect) {
            setPlayerRect(prev => ({ ...prev, left: clientX - dragOffset.x, top: clientY - dragOffset.y }));
          } else if (resizeState.active) {
            const dx = clientX - resizeState.startX, dy = clientY - resizeState.startY;
            let { startLeft, startTop, startWidth, startHeight, dir } = resizeState;
            let newWidth = startWidth, newLeft = startLeft, newTop = startTop;

            if (dir.includes('e')) newWidth = startWidth + dx;
            else if (dir.includes('w')) { newWidth = startWidth - dx; newLeft = startLeft + dx; } 
            
            if (dir.includes('n')) {
                const videoH = (startHeight - dy) - 40;
                newWidth = videoH * (16/9);
                newTop = startTop + dy;
                newLeft = startLeft + (startWidth - newWidth) / 2;
            } else if (dir.includes('s')) {
                const videoH = (startHeight + dy) - 40;
                newWidth = videoH * (16/9);
                newLeft = startLeft + (startWidth - newWidth) / 2;
            }

            if (newWidth < 250) { newWidth = 250; if (dir.includes('w')) newLeft -= (250 - newWidth); }
            if (newWidth > 800) { newWidth = 800; if (dir.includes('w')) newLeft += (newWidth - 800); }

            const newHeight = newWidth * (9/16) + 40;
            if (dir.includes('n')) newTop = startTop + (startHeight - newHeight);
            setPlayerRect({ left: newLeft, top: newTop, width: newWidth, height: newHeight });
          }
        };

        const handleUp = () => { setIsDragging(false); setResizeState(prev => ({ ...prev, active: false })); };

        if (isDragging || resizeState.active) {
          window.addEventListener('mousemove', handleMove); window.addEventListener('mouseup', handleUp);
          window.addEventListener('touchmove', handleMove, { passive: false }); window.addEventListener('touchend', handleUp);
        }
        return () => {
          window.removeEventListener('mousemove', handleMove); window.removeEventListener('mouseup', handleUp);
          window.removeEventListener('touchmove', handleMove); window.removeEventListener('touchend', handleUp);
        };
      }, [isDragging, resizeState, dragOffset, playerRect]);

      let gridClass = &quot;grid gap-x-4 gap-y-8 &quot;;
      if (gridCols === 1) gridClass += &quot;grid-cols-1&quot;;
      else if (gridCols === 2) gridClass += &quot;grid-cols-1 sm:grid-cols-2&quot;;
      else if (gridCols === 3) gridClass += &quot;grid-cols-1 sm:grid-cols-2 lg:grid-cols-3&quot;;
      else if (gridCols === 4) gridClass += &quot;grid-cols-1 sm:grid-cols-2 md:grid-cols-3 xl:grid-cols-4&quot;;
      else if (gridCols === 5) gridClass += &quot;grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5&quot;;
      else gridClass += &quot;grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6&quot;;

      return (
        <div className=&quot;min-h-screen flex flex-col relative overflow-hidden bg-[#0f0f0f]&quot;>
          <header className=&quot;flex items-center justify-between px-4 py-2 sticky top-0 bg-[#0f0f0f] z-40 h-16 border-b border-white/10&quot;>
            <div className=&quot;flex items-center gap-4&quot;>
              <button onClick={() => setIsSidebarOpen(!isSidebarOpen)} className=&quot;p-2 hover:bg-white/10 rounded-full transition-colors&quot;>
                <i className=&quot;fas fa-bars text-xl&quot;></i>
              </button>
              <div className=&quot;flex items-center gap-2 cursor-pointer&quot; onClick={() => { setCurrentVideo(null); setIsMiniplayer(false); }}>
                <i className=&quot;fab fa-youtube text-red-600 text-3xl&quot;></i>
                <span className=&quot;text-xl font-bold tracking-tighter hidden sm:block&quot;>YouTube</span>
              </div>
            </div>

            <div className=&quot;flex-1 max-w-xl flex items-center ml-4 mr-4&quot;>
              <div className=&quot;flex w-full bg-[#121212] border border-white/20 rounded-full overflow-hidden focus-within:border-blue-500&quot;>
                <input 
                  type=&quot;text&quot; 
                  placeholder=&quot;অনুসন্ধান করুন...&quot; 
                  className=&quot;w-full bg-transparent px-4 py-2 outline-none text-white placeholder-gray-400&quot;
                  value={searchQuery}
                  onChange={(e) => setSearchQuery(e.target.value)}
                />
                <button className=&quot;px-5 bg-white/10 hover:bg-white/20 transition-colors border-l border-white/20&quot;>
                  <i className=&quot;fas fa-search text-gray-300&quot;></i>
                </button>
              </div>
            </div>

            <div className=&quot;flex items-center gap-2 sm:gap-3&quot;>
              {(!currentVideo || isMiniplayer) &amp;&amp; (
                <div className=&quot;hidden md:flex items-center gap-2 bg-[#212121] px-2 py-1 rounded-full border border-gray-700 mr-1&quot;>
                  <button onClick={() => setGridCols(Math.max(1, gridCols - 1))} className=&quot;text-gray-300 hover:text-white hover:bg-white/10 w-6 h-6 rounded flex items-center justify-center transition&quot; title=&quot;ভিডিও বড় করুন&quot;>
                      <i className=&quot;fas fa-plus text-[10px]&quot;></i>
                  </button>
                  <div className=&quot;w-px h-3 bg-gray-600&quot;></div>
                  <button onClick={() => setGridCols(Math.min(6, gridCols + 1))} className=&quot;text-gray-300 hover:text-white hover:bg-white/10 w-6 h-6 rounded flex items-center justify-center transition&quot; title=&quot;ভিডিও ছোট করুন&quot;>
                      <i className=&quot;fas fa-minus text-[10px]&quot;></i>
                  </button>
                </div>
              )}
              
              <button onClick={() => setIsLocalModalOpen(true)} className=&quot;flex items-center gap-2 px-3 py-1.5 bg-emerald-600/20 hover:bg-emerald-600/40 text-emerald-400 rounded-full transition-colors border border-emerald-500/30&quot;>
                <i className=&quot;fas fa-folder-open text-sm&quot;></i><span className=&quot;text-sm font-semibold hidden md:block&quot;>লোকাল ফাইল</span>
              </button>

              <button onClick={() => setIsCreateListModalOpen(true)} className=&quot;flex items-center gap-2 px-3 py-1.5 bg-blue-600/20 hover:bg-blue-600/40 text-blue-400 rounded-full transition-colors border border-blue-500/30 hidden lg:flex&quot;>
                <i className=&quot;fas fa-folder-plus text-sm&quot;></i><span className=&quot;text-sm font-semibold&quot;>প্লেলিস্ট বানান</span>
              </button>
              
              <button onClick={() => setIsAddModalOpen(true)} className=&quot;flex items-center gap-2 px-3 py-1.5 bg-white/10 hover:bg-white/20 rounded-full transition-colors border border-white/20&quot;>
                <i className=&quot;fas fa-globe text-sm&quot;></i><span className=&quot;text-sm font-semibold hidden md:block&quot;>অনলাইন ভিডিও</span>
              </button>
            </div>
          </header>

          <div className=&quot;flex flex-1 overflow-hidden&quot;>
            <aside className={`${isSidebarOpen ? 'w-64' : 'w-20'} flex-shrink-0 hidden md:flex flex-col bg-[#0f0f0f] transition-all duration-300 overflow-y-auto px-2 py-3 border-r border-white/10 custom-scrollbar`}>
              
              <div onClick={() => { setCurrentVideo(null); setIsMiniplayer(false); }} className={`flex items-center ${isSidebarOpen ? 'justify-start px-3' : 'justify-center flex-col'} py-2.5 my-1 rounded-xl cursor-pointer transition-colors ${!currentVideo ? 'bg-white/10 font-bold' : 'hover:bg-white/10'}`}>
                <div className={`flex items-center justify-center ${isSidebarOpen ? 'mr-4' : 'mb-1'} ${!currentVideo ? 'text-white' : 'text-gray-200'}`}><i className=&quot;fas fa-home text-xl&quot;></i></div>
                <span className={`${isSidebarOpen ? 'text-sm' : 'text-[10px]'} ${!currentVideo ? 'text-white font-semibold' : 'text-gray-200'}`}>হোম</span>
              </div>
              
              <SidebarToggle icon={<i className=&quot;fas fa-video text-xl&quot;></i>} label=&quot;সকল ভিডিও&quot; isExpanded={isAllVideosExpanded} onToggle={() => setIsAllVideosExpanded(!isAllVideosExpanded)} isOpen={isSidebarOpen} scrollable={true}>
                  {videos.filter(v => v.type === 'video').length === 0 &amp;&amp; <p className=&quot;text-xs text-gray-500 pl-1&quot;>কোনো ভিডিও নেই</p>}
                  {videos.filter(v => v.type === 'video').map((video, idx) => {
                      const watchedSec = progressData.times[video.id] || 0;
                      const totalSec = progressData.durations[video.id] || 0;
                      const progressPercent = totalSec > 0 ? Math.min((watchedSec / totalSec) * 100, 100) : 0;
                      return (
                        <div key={idx} className=&quot;flex gap-2 cursor-pointer hover:bg-white/10 p-1.5 rounded-lg transition-colors group&quot; onClick={() => playVideo(video)}>
                          <div className=&quot;w-16 h-10 relative flex-shrink-0 bg-black rounded overflow-hidden border border-white/10&quot;>
                            <img src={video.thumbnail} className=&quot;w-full h-full object-cover&quot; />
                            {progressPercent > 0 &amp;&amp; (
                                <div className=&quot;absolute bottom-0 left-0 right-0 h-0.5 bg-gray-600/80&quot;>
                                  <div className=&quot;h-full bg-red-600&quot; style={{ width: `${progressPercent}%` }}></div>
                                </div>
                            )}
                          </div>
                          <div className=&quot;flex flex-col justify-center overflow-hidden flex-1&quot;>
                            <span className=&quot;text-[11px] font-semibold text-white line-clamp-1 group-hover:text-blue-400&quot;>{video.title}</span>
                            <span className=&quot;text-[9px] text-gray-400 truncate&quot;>{video.channel}</span>
                          </div>
                        </div>
                      )
                  })}
              </SidebarToggle>

              <SidebarToggle icon={<i className=&quot;fas fa-layer-group text-xl&quot;></i>} label=&quot;সকল প্লেলিস্ট&quot; isExpanded={isAllPlaylistsExpanded} onToggle={() => setIsAllPlaylistsExpanded(!isAllPlaylistsExpanded)} isOpen={isSidebarOpen} scrollable={true}>
                  {videos.filter(v => v.type.includes('playlist')).length === 0 &amp;&amp; <p className=&quot;text-xs text-gray-500 pl-1&quot;>কোনো প্লেলিস্ট নেই</p>}
                  {videos.filter(v => v.type.includes('playlist')).map((video, idx) => {
                      return (
                        <div key={idx} className=&quot;flex gap-2 cursor-pointer hover:bg-white/10 p-1.5 rounded-lg transition-colors group&quot; onClick={() => playVideo(video)}>
                          <div className=&quot;w-16 h-10 relative flex-shrink-0 bg-black rounded overflow-hidden border border-white/10&quot;>
                            <img src={video.thumbnail} className=&quot;w-full h-full object-cover&quot; />
                            <div className=&quot;absolute bottom-0.5 right-0.5 bg-black/80 text-[8px] px-1 rounded flex items-center gap-0.5&quot;><i className=&quot;fas fa-list&quot;></i></div>
                          </div>
                          <div className=&quot;flex flex-col justify-center overflow-hidden flex-1&quot;>
                            <span className=&quot;text-[11px] font-semibold text-white line-clamp-1 group-hover:text-blue-400&quot;>{video.title}</span>
                            <span className=&quot;text-[9px] text-gray-400 truncate&quot;>{video.channel}</span>
                          </div>
                        </div>
                      )
                  })}
              </SidebarToggle>

              {currentVideoData?.type?.includes('playlist') &amp;&amp; playlistQueue.length > 0 &amp;&amp; (
                  <>
                  <hr className=&quot;border-white/10 my-2&quot; />
                  <SidebarToggle icon={<i className=&quot;fas fa-play-circle text-xl text-blue-400&quot;></i>} label=&quot;বর্তমান প্লেলিস্ট&quot; isExpanded={isCurrentPlaylistExpanded} onToggle={() => setIsCurrentPlaylistExpanded(!isCurrentPlaylistExpanded)} isOpen={isSidebarOpen} scrollable={true}>
                      {playlistQueue.map((vidId, index) => {
                          const isPlaying = index === currentPlaylistIndex;
                          let title = `ভিডিও ${index + 1}`;
                          let channel = 'YouTube';
                          let thumbnail = `https://img.youtube.com/vi/${vidId}/mqdefault.jpg`;
                          
                          let progressPercent = 0;

                          if (currentVideoData.provider === 'local') {
                              const localVidInfo = currentVideoData.videoObjects?.[index];
                              if (localVidInfo) {
                                  title = localVidInfo.title;
                                  channel = localVidInfo.channel;
                                  thumbnail = localVidInfo.thumbnail;
                                  const watchedSec = progressData.times[localVidInfo.id] || 0;
                                  const totalSec = progressData.durations[localVidInfo.id] || 0;
                                  progressPercent = totalSec > 0 ? Math.min((watchedSec / totalSec) * 100, 100) : 0;
                              }
                          } else {
                              const localVidInfo = videos.find(v => v.videoId === vidId);
                              const meta = fetchedMeta[vidId];
                              if (localVidInfo) {
                                  title = localVidInfo.title;
                                  channel = localVidInfo.channel;
                                  const watchedSec = progressData.times[localVidInfo.id] || 0;
                                  const totalSec = progressData.durations[localVidInfo.id] || 0;
                                  progressPercent = totalSec > 0 ? Math.min((watchedSec / totalSec) * 100, 100) : 0;
                              } else if (meta &amp;&amp; meta.title) {
                                  title = meta.title;
                                  channel = meta.channel;
                              } else if (meta &amp;&amp; meta.loading) {
                                  title = 'লোড হচ্ছে...';
                              }
                          }

                          return (
                              <div 
                                  key={index} 
                                  onClick={() => {
                                      if (currentVideoData.provider === 'local') {
                                          setCurrentPlaylistIndex(index);
                                          const indexes = JSON.parse(localStorage.getItem(lsKey('PlaylistIndexes')) || '{}');
                                          indexes[currentVideoData.id] = index;
                                          localStorage.setItem(lsKey('PlaylistIndexes'), JSON.stringify(indexes));
                                      } else {
                                          playerRef.current?.playVideoAt(index);
                                      }
                                  }}
                                  className={`flex gap-2 cursor-pointer hover:bg-white/10 p-1.5 rounded-lg transition-colors group ${isPlaying ? 'bg-white/20 border border-white/10' : ''}`}
                              >
                                  <div className=&quot;text-[10px] text-gray-400 w-3 flex items-center justify-center&quot;>
                                      {isPlaying ? <i className=&quot;fas fa-play text-white&quot;></i> : index + 1}
                                  </div>
                                  <div className=&quot;w-16 h-10 relative flex-shrink-0 bg-black rounded overflow-hidden border border-white/10&quot;>
                                      <img src={thumbnail} className=&quot;w-full h-full object-cover&quot; />
                                      {progressPercent > 0 &amp;&amp; (
                                          <div className=&quot;absolute bottom-0 left-0 right-0 h-0.5 bg-gray-600/80&quot;>
                                              <div className=&quot;h-full bg-red-600&quot; style={{ width: `${progressPercent}%` }}></div>
                                          </div>
                                      )}
                                  </div>
                                  <div className=&quot;flex flex-col justify-center overflow-hidden flex-1&quot;>
                                      <span className={`text-[11px] font-semibold line-clamp-1 group-hover:text-blue-400 ${isPlaying ? 'text-white' : 'text-gray-300'}`}>{title}</span>
                                      <span className=&quot;text-[9px] text-gray-400 truncate&quot;>{channel}</span>
                                  </div>
                              </div>
                          )
                      })}
                  </SidebarToggle>
                  </>
              )}

              {isSidebarOpen &amp;&amp; <hr className=&quot;border-white/10 my-2&quot; />}
              
              <SidebarToggle icon={<i className=&quot;fas fa-history text-xl&quot;></i>} label=&quot;ইতিহাস&quot; isExpanded={isHistoryExpanded} onToggle={() => setIsHistoryExpanded(!isHistoryExpanded)} isOpen={isSidebarOpen} scrollable={true}>
                  {watchHistory.length === 0 ? (
                    <p className=&quot;text-xs text-gray-500 pl-1&quot;>কোনো ইতিহাস নেই</p>
                  ) : (
                    watchHistory.map((video, idx) => {
                      const watchedSec = progressData.times[video.id] || 0;
                      const totalSec = progressData.durations[video.id] || 0;
                      const progressPercent = totalSec > 0 ? Math.min((watchedSec / totalSec) * 100, 100) : 0;
                      return (
                        <div key={idx} className=&quot;flex gap-2 cursor-pointer hover:bg-white/10 p-1.5 rounded-lg transition-colors group&quot; onClick={() => playVideo(video)}>
                          <div className=&quot;w-16 h-10 relative flex-shrink-0 bg-black rounded overflow-hidden border border-white/10&quot;>
                            <img src={video.thumbnail} className=&quot;w-full h-full object-cover&quot; />
                            {progressPercent > 0 &amp;&amp; (
                                <div className=&quot;absolute bottom-0 left-0 right-0 h-0.5 bg-gray-600/80&quot;>
                                  <div className=&quot;h-full bg-red-600&quot; style={{ width: `${progressPercent}%` }}></div>
                                </div>
                            )}
                          </div>
                          <div className=&quot;flex flex-col justify-center overflow-hidden flex-1&quot;>
                            <span className=&quot;text-[11px] font-semibold text-white line-clamp-1 group-hover:text-blue-400&quot;>{video.title}</span>
                            <span className=&quot;text-[9px] text-gray-400 truncate&quot;>{video.channel}</span>
                          </div>
                        </div>
                      )
                    })
                  )}
              </SidebarToggle>

            </aside>

            <main className=&quot;flex-1 overflow-y-auto bg-[#0f0f0f] relative custom-scrollbar&quot;>
              
              <div className={`${isTheaterMode &amp;&amp; !isMiniplayer ? 'w-full max-w-full h-[calc(100vh-64px)] p-4 flex-col' : 'max-w-[1600px] mx-auto p-4 flex-col lg:flex-row'} gap-6 ${(currentVideo &amp;&amp; !isMiniplayer) ? 'flex' : 'absolute w-0 h-0 overflow-hidden invisible'}`}>
                <div className={`flex flex-col relative ${isTheaterMode &amp;&amp; !isMiniplayer ? 'w-full h-full' : 'flex-1 lg:w-2/3'}`}>
                  {currentVideo &amp;&amp; (
                    <div 
                      className={`${isMiniplayer ? 'fixed z-[100] flex flex-col overflow-visible visible' : (isTheaterMode ? 'w-full h-full relative' : 'w-full aspect-video relative')}`}
                      style={isMiniplayer &amp;&amp; playerRect ? { left: `${playerRect.left}px`, top: `${playerRect.top}px`, width: `${playerRect.width}px`, height: `${playerRect.height}px` } : {}}
                    >
                      <div id=&quot;video-player-container&quot; className={`w-full h-full flex flex-col relative rounded-xl overflow-hidden group ${isMiniplayer ? 'bg-[#212121] shadow-2xl border border-gray-700' : 'bg-black shadow-lg'}`}>
                        <div className={`${isMiniplayer ? 'flex' : 'hidden'} h-10 flex-shrink-0 justify-between items-center px-3 bg-[#181818] cursor-move select-none z-10 border-b border-gray-700`} onMouseDown={handleDragStart} onTouchStart={handleDragStart}>
                          <div className=&quot;flex flex-col truncate pr-2 w-[75%]&quot;>
                            <span className=&quot;text-sm font-bold truncate text-white&quot;>
                                {currentVideoData?.provider === 'gdrive' &amp;&amp; <i className=&quot;fab fa-google-drive mr-2 text-blue-400&quot;></i>}
                                {currentVideoData?.provider === 'local' &amp;&amp; <i className=&quot;fas fa-hdd mr-2 text-emerald-400&quot;></i>}
                                {currentVideoData?.provider === 'external' &amp;&amp; <i className=&quot;fas fa-external-link-alt mr-2 text-red-500&quot;></i>}
                                {currentVideoData?.type?.includes('playlist') &amp;&amp; <i className=&quot;fas fa-play mr-2 text-gray-400 text-[10px]&quot;></i>}
                                {displayTitle}
                            </span>
                          </div>
                          <div className=&quot;flex gap-4 text-gray-400 items-center&quot;>
                            <button onClick={() => setIsMiniplayer(false)} className=&quot;hover:text-white&quot; title=&quot;Expand&quot;><i className=&quot;fas fa-expand-alt&quot;></i></button>
                            <button onClick={() => { setCurrentVideo(null); setIsMiniplayer(false); }} className=&quot;hover:text-white&quot; title=&quot;Close&quot;><i className=&quot;fas fa-times text-lg&quot;></i></button>
                          </div>
                        </div>

                        <div className=&quot;w-full flex-1 relative bg-black pointer-events-auto overflow-hidden&quot;>
                          {(isDragging || resizeState.active) &amp;&amp; <div className=&quot;absolute inset-0 z-10 bg-transparent&quot;></div>}
                          
                          <div 
                              ref={ytContainerRef} 
                              className={`w-full h-full absolute inset-0 ${(!currentVideoData?.provider || currentVideoData?.provider === 'youtube') ? 'block' : 'hidden'}`}
                          ></div>

                          {currentVideoData?.provider === 'gdrive' &amp;&amp; (
                              <iframe 
                                  src={`https://drive.google.com/file/d/${currentVideoData.driveId}/preview`} 
                                  className=&quot;w-full h-full border-0 absolute inset-0 z-0&quot; 
                                  allow=&quot;autoplay; fullscreen&quot;
                                  allowFullScreen
                              ></iframe>
                          )}

                          {currentVideoData?.provider === 'local' &amp;&amp; (
                              <video 
                                  ref={localVideoRef}
                                  src={currentVideoData.type === 'local_playlist' ? currentVideoData.videoObjects[currentPlaylistIndex]?.blobUrl : currentVideoData.blobUrl} 
                                  className=&quot;w-full h-full object-contain absolute inset-0 z-0 outline-none&quot; 
                                  controls
                                  autoPlay
                                  onLoadedMetadata={(e) => {
                                      const vidId = currentVideoData.type === 'local_playlist' ? currentVideoData.videoObjects[currentPlaylistIndex].id : currentVideoData.id;
                                      const times = JSON.parse(localStorage.getItem(lsKey('Times')) || '{}');
                                      if (times[vidId] &amp;&amp; times[vidId] > 0) {
                                          e.target.currentTime = times[vidId];
                                      }
                                  }}
                                  onEnded={() => {
                                      if (currentVideoData.type === 'local_playlist' &amp;&amp; currentPlaylistIndex < currentVideoData.videoObjects.length - 1) {
                                          const nextIdx = currentPlaylistIndex + 1;
                                          setCurrentPlaylistIndex(nextIdx);
                                          
                                          const indexes = JSON.parse(localStorage.getItem(lsKey('PlaylistIndexes')) || '{}');
                                          indexes[currentVideoData.id] = nextIdx;
                                          localStorage.setItem(lsKey('PlaylistIndexes'), JSON.stringify(indexes));
                                      }
                                  }}
                                  onTimeUpdate={(e) => {
                                      const time = Math.floor(e.target.currentTime);
                                      const duration = Math.floor(e.target.duration);
                                      const vidId = currentVideoData.type === 'local_playlist' ? currentVideoData.videoObjects[currentPlaylistIndex].id : currentVideoData.id;
                                      
                                      setProgressData(prev => ({
                                          times: { ...prev.times, [vidId]: time },
                                          durations: { ...prev.durations, [vidId]: duration }
                                      }));

                                      const storedTimes = JSON.parse(localStorage.getItem(lsKey('Times')) || '{}');
                                      const storedDurations = JSON.parse(localStorage.getItem(lsKey('Durations')) || '{}');
                                      storedTimes[vidId] = time;
                                      storedDurations[vidId] = duration;
                                      localStorage.setItem(lsKey('Times'), JSON.stringify(storedTimes));
                                      localStorage.setItem(lsKey('Durations'), JSON.stringify(storedDurations));
                                  }}
                              ></video>
                          )}

                          {currentVideoData?.provider === 'external' &amp;&amp; (
                              <div className=&quot;absolute inset-0 z-10 flex flex-col items-center justify-center bg-[#121212] text-white&quot;>
                                  <i className=&quot;fas fa-external-link-alt text-4xl text-red-500 mb-4&quot;></i>
                                  <h2 className=&quot;text-xl font-bold mb-2&quot;>গুগল ফটোজের ভিডিওটি পপ-আপ উইন্ডোতে চলছে</h2>
                                  <p className=&quot;text-gray-400 text-sm mb-6 text-center px-4&quot;>ব্রাউজারের সিকিউরিটি রুলসের কারণে এটি নতুন উইন্ডোতে ওপেন হয়েছে।</p>
                                  <div className=&quot;flex gap-4&quot;>
                                      <button 
                                          onClick={() => {
                                              // উইন্ডোটি রানিং থাকলে সামনে আনবে, কেটে দিলে আবার ওপেন করবে
                                              if (popupWindowRef.current &amp;&amp; !popupWindowRef.current.closed) {
                                                  popupWindowRef.current.focus();
                                              } else {
                                                  playVideo(currentVideoData);
                                              }
                                          }} 
                                          className=&quot;bg-white/10 hover:bg-white/20 text-white px-6 py-2.5 rounded-full font-bold transition flex items-center&quot;
                                      >
                                          <i className=&quot;fas fa-window-restore mr-2&quot;></i> সামনে আনুন
                                      </button>
                                      <button 
                                          onClick={() => playVideo(currentVideoData)} 
                                          className=&quot;bg-red-600 hover:bg-red-500 text-white px-6 py-2.5 rounded-full font-bold transition flex items-center&quot;
                                      >
                                          <i className=&quot;fas fa-redo mr-2&quot;></i> আবার খুলুন
                                      </button>
                                  </div>
                              </div>
                          )}
                        </div>

                        {isTheaterMode &amp;&amp; !isMiniplayer &amp;&amp; (
                            <button onClick={() => setIsTheaterMode(false)} className=&quot;absolute bottom-[70px] right-6 z-50 bg-black/80 hover:bg-black text-white px-5 py-2.5 rounded-md flex items-center gap-2 transition-all backdrop-blur-sm border border-white/20 opacity-0 group-hover:opacity-100 shadow-xl font-medium text-sm&quot;>
                                <i className=&quot;fas fa-compress&quot;></i> সাধারণ ভিউ
                            </button>
                        )}
                      </div>

                      {isMiniplayer &amp;&amp; (
                        <>
                          <div className=&quot;absolute -top-2 left-2 right-2 h-4 cursor-n-resize z-20&quot; onMouseDown={(e) => handleResizeStart(e, 'n')} onTouchStart={(e) => handleResizeStart(e, 'n')} />
                          <div className=&quot;absolute -bottom-2 left-2 right-2 h-4 cursor-s-resize z-20&quot; onMouseDown={(e) => handleResizeStart(e, 's')} onTouchStart={(e) => handleResizeStart(e, 's')} />
                          <div className=&quot;absolute top-2 bottom-2 -left-2 w-4 cursor-w-resize z-20&quot; onMouseDown={(e) => handleResizeStart(e, 'w')} onTouchStart={(e) => handleResizeStart(e, 'w')} />
                          <div className=&quot;absolute top-2 bottom-2 -right-2 w-4 cursor-e-resize z-20&quot; onMouseDown={(e) => handleResizeStart(e, 'e')} onTouchStart={(e) => handleResizeStart(e, 'e')} />
                          <div className=&quot;absolute -top-2 -left-2 w-6 h-6 cursor-nw-resize z-30&quot; onMouseDown={(e) => handleResizeStart(e, 'nw')} onTouchStart={(e) => handleResizeStart(e, 'nw')} />
                          <div className=&quot;absolute -top-2 -right-2 w-6 h-6 cursor-ne-resize z-30&quot; onMouseDown={(e) => handleResizeStart(e, 'ne')} onTouchStart={(e) => handleResizeStart(e, 'ne')} />
                          <div className=&quot;absolute -bottom-2 -left-2 w-6 h-6 cursor-sw-resize z-30&quot; onMouseDown={(e) => handleResizeStart(e, 'sw')} onTouchStart={(e) => handleResizeStart(e, 'sw')} />
                          <div className=&quot;absolute -bottom-2 -right-2 w-6 h-6 cursor-se-resize z-30&quot; onMouseDown={(e) => handleResizeStart(e, 'se')} onTouchStart={(e) => handleResizeStart(e, 'se')} />
                        </>
                      )}
                    </div>
                  )}

                  <div className={`${(isMiniplayer || isTheaterMode) ? 'hidden' : 'block'}`}>
                    <h1 className=&quot;text-xl md:text-2xl font-bold mt-4 mb-1&quot;>
                        {currentVideoData?.provider === 'gdrive' &amp;&amp; <span className=&quot;bg-blue-600/20 text-blue-400 text-xs px-2 py-1 rounded mr-2 align-middle border border-blue-500/30&quot;><i className=&quot;fab fa-google-drive&quot;></i> Google Drive</span>}
                        {currentVideoData?.provider === 'local' &amp;&amp; <span className=&quot;bg-emerald-600/20 text-emerald-400 text-xs px-2 py-1 rounded mr-2 align-middle border border-emerald-500/30&quot;><i className=&quot;fas fa-hdd&quot;></i> Local File</span>}
                        {currentVideoData?.provider === 'external' &amp;&amp; <span className=&quot;bg-red-600/20 text-red-500 text-xs px-2 py-1 rounded mr-2 align-middle border border-red-500/30&quot;><i className=&quot;fas fa-external-link-alt&quot;></i> Google Photos</span>}
                        {displayTitle}
                    </h1>
                    {currentVideoData?.type?.includes('playlist') &amp;&amp; (
                        <p className=&quot;text-sm text-gray-400 mb-3 flex items-center gap-2&quot;>
                            <i className=&quot;fas fa-list&quot;></i> {currentVideoData.title}
                        </p>
                    )}
                    <div className=&quot;flex flex-col sm:flex-row sm:items-center justify-between gap-4&quot;>
                      <div className=&quot;flex items-center gap-3&quot;>
                        <img src={displayAvatar || 'https://ui-avatars.com/api/?name=User&amp;background=random'} alt={displayChannel} className=&quot;w-10 h-10 rounded-full&quot; />
                        <div>
                          <h3 className=&quot;font-bold text-sm&quot;>{displayChannel}</h3>
                          <p className=&quot;text-xs text-gray-400&quot;>সাবস্ক্রাইবার অজানা</p>
                        </div>
                        <button className=&quot;bg-white text-black px-4 py-2 rounded-full font-bold ml-2 hover:bg-gray-200 transition&quot;>সাবস্ক্রাইব</button>
                      </div>
                      <div className=&quot;flex items-center gap-2&quot;>
                        <button onClick={() => setIsTheaterMode(true)} className=&quot;flex items-center gap-2 px-4 py-2 bg-white/10 rounded-full hover:bg-white/20 transition font-bold whitespace-nowrap&quot; title=&quot;থিয়েটার মোড&quot;>
                          <i className=&quot;fas fa-tv&quot;></i> থিয়েটার
                        </button>
                        <button onClick={activateMiniplayer} className=&quot;flex items-center gap-2 px-4 py-2 bg-white/10 rounded-full hover:bg-white/20 transition font-bold whitespace-nowrap&quot; title=&quot;Miniplayer&quot;>
                          <i className=&quot;fas fa-compress-alt&quot;></i> মিনিপ্লেয়ার
                        </button>
                      </div>
                    </div>
                  </div>
                </div>

                <div className={`lg:w-1/3 w-full flex flex-col gap-3 ${(isMiniplayer || isTheaterMode) ? 'hidden' : 'flex'}`}>
                  
                  {playlistQueue.length > 0 &amp;&amp; currentVideoData?.type.includes('playlist') &amp;&amp; (
                      <div className=&quot;bg-[#212121] rounded-xl border border-white/10 flex flex-col max-h-[500px] shadow-lg mb-2&quot;>
                          <div className=&quot;p-4 border-b border-white/10 bg-[#181818] rounded-t-xl&quot;>
                              <h3 className=&quot;font-bold text-lg leading-tight&quot;>{currentVideoData.title}</h3>
                              <p className=&quot;text-xs text-gray-400 mt-1&quot;>{currentVideoData.channel} • {currentPlaylistIndex + 1} / {playlistQueue.length}</p>
                          </div>
                          <div className=&quot;overflow-y-auto flex-1 p-2 flex flex-col gap-1 custom-scrollbar&quot;>
                              {playlistQueue.map((vidId, index) => {
                                  const isPlaying = index === currentPlaylistIndex;
                                  let title = `ভিডিও ${index + 1}`;
                                  let channel = 'YouTube';
                                  let thumbnail = `https://img.youtube.com/vi/${vidId}/mqdefault.jpg`;

                                  if (currentVideoData.provider === 'local') {
                                      const localVidInfo = currentVideoData.videoObjects?.[index];
                                      if (localVidInfo) {
                                          title = localVidInfo.title;
                                          channel = localVidInfo.channel;
                                          thumbnail = localVidInfo.thumbnail;
                                      }
                                  } else {
                                      const localVidInfo = videos.find(v => v.videoId === vidId);
                                      const meta = fetchedMeta[vidId];
                                      if (localVidInfo) {
                                          title = localVidInfo.title;
                                          channel = localVidInfo.channel;
                                      } else if (meta &amp;&amp; meta.title) {
                                          title = meta.title;
                                          channel = meta.channel;
                                      } else if (meta &amp;&amp; meta.loading) {
                                          title = 'লোড হচ্ছে...';
                                      }
                                  }

                                  return (
                                      <div 
                                        key={index} 
                                        onClick={() => {
                                            if (currentVideoData.provider === 'local') {
                                                setCurrentPlaylistIndex(index);
                                                const indexes = JSON.parse(localStorage.getItem(lsKey('PlaylistIndexes')) || '{}');
                                                indexes[currentVideoData.id] = index;
                                                localStorage.setItem(lsKey('PlaylistIndexes'), JSON.stringify(indexes));
                                            } else {
                                                playerRef.current?.playVideoAt(index);
                                            }
                                        }}
                                        className={`flex gap-3 p-2 rounded-lg cursor-pointer transition items-center ${isPlaying ? 'bg-white/20' : 'hover:bg-white/10'}`}
                                      >
                                          <div className=&quot;text-xs text-gray-400 w-4 text-center&quot;>
                                              {isPlaying ? <i className=&quot;fas fa-play text-white text-[10px]&quot;></i> : index + 1}
                                          </div>
                                          <div className=&quot;w-24 h-14 flex-shrink-0 relative rounded overflow-hidden bg-black border border-white/10&quot;>
                                              <img src={thumbnail} className=&quot;w-full h-full object-cover&quot; />
                                          </div>
                                          <div className=&quot;flex flex-col justify-center overflow-hidden pr-2&quot;>
                                              <h4 className={`text-sm font-semibold line-clamp-2 leading-snug ${isPlaying ? 'text-white' : 'text-gray-300'}`}>{title}</h4>
                                              <p className=&quot;text-xs text-gray-400 mt-0.5 truncate&quot;>{channel}</p>
                                          </div>
                                      </div>
                                  )
                              })}
                          </div>
                      </div>
                  )}

                  <h3 className=&quot;font-bold text-lg mb-2 mt-2&quot;>আপনার জন্য প্রস্তাবিত</h3>
                  {videos.filter(v => v?.id !== currentVideo?.id).map(video => {
                      const watchedSec = progressData.times[video.id] || 0;
                      const totalSec = progressData.durations[video.id] || 0;
                      const progressPercent = totalSec > 0 ? Math.min((watchedSec / totalSec) * 100, 100) : 0;

                      return (
                        <div key={video.id} className=&quot;flex gap-2 cursor-pointer group relative&quot;>
                          <div 
                            className=&quot;w-40 h-24 flex-shrink-0 relative rounded-lg overflow-hidden bg-gray-900 border border-white/10&quot;
                            onMouseEnter={() => handleMouseEnter(video)}
                            onMouseLeave={handleMouseLeave}
                          >
                            <button 
                              onClick={(e) => deleteMedia(e, video.id)}
                              className=&quot;absolute top-1 left-1 bg-black/80 hover:bg-red-600 text-white w-6 h-6 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition z-30 shadow-lg&quot;
                              title=&quot;মুছে ফেলুন&quot;
                            >
                              <i className=&quot;fas fa-trash text-[10px]&quot;></i>
                            </button>

                            <img src={video.thumbnail} alt={video.title} onClick={() => playVideo(video)} className={`w-full h-full object-cover transition duration-300 cursor-pointer ${hoveredVideo === video.id ? 'opacity-0' : 'opacity-100'}`} />
                            
                            {hoveredVideo === video.id &amp;&amp; <HoverPlayer video={video} savedTime={watchedSec} onPlay={() => playVideo(video)} />}

                            {progressPercent > 0 &amp;&amp; hoveredVideo !== video.id &amp;&amp; (
                                <div className=&quot;absolute bottom-0 left-0 right-0 h-1 bg-gray-600/80 z-20 pointer-events-none&quot;>
                                    <div className=&quot;h-full bg-red-600&quot; style={{ width: `${progressPercent}%` }}></div>
                                </div>
                            )}

                            {video.type.includes('playlist') &amp;&amp; (
                                <div className=&quot;absolute bottom-1 right-1 bg-black/80 text-xs px-1.5 py-0.5 rounded flex items-center gap-1 z-20 pointer-events-none&quot;>
                                    <i className=&quot;fas fa-list text-[10px]&quot;></i> Playlist
                                </div>
                            )}

                            {/* External Link Badge for Recommendations */}
                            {video.provider === 'external' &amp;&amp; (
                                <div className=&quot;absolute top-1 right-1 bg-red-600/90 text-white text-[10px] px-1.5 py-0.5 rounded font-medium flex items-center gap-1 z-20 pointer-events-none shadow-lg&quot;>
                                    <i className=&quot;fas fa-external-link-alt&quot;></i> Photos
                                </div>
                            )}
                          </div>
                          <div className=&quot;flex flex-col pr-6&quot; onClick={() => playVideo(video)}>
                            <h4 className=&quot;text-sm font-semibold line-clamp-2 group-hover:text-blue-400&quot;>{video.title}</h4>
                            <p className=&quot;text-xs text-gray-400 mt-1&quot;>{video.channel}</p>
                          </div>
                        </div>
                      )
                  })}
                </div>
              </div>

              <div className={`p-4 sm:p-6 lg:p-8 max-w-[1800px] mx-auto ${(!currentVideo || isMiniplayer) ? 'block' : 'hidden'}`}>
                
                <div className=&quot;mb-6&quot;>
                  {searchQuery &amp;&amp; <h2 className=&quot;text-xl font-bold&quot;>&quot;{searchQuery}&quot; এর ফলাফল</h2>}
                </div>

                <div className={gridClass}>
                  {filteredVideos.map((video, index) => {
                      const watchedSec = progressData.times[video.id] || 0;
                      const totalSec = progressData.durations[video.id] || 0;
                      const progressPercent = totalSec > 0 ? Math.min((watchedSec / totalSec) * 100, 100) : 0;

                      return (
                        <div key={`${video.id}-${index}`} className=&quot;flex flex-col group relative&quot;>
                          <button 
                            onClick={(e) => deleteMedia(e, video.id)}
                            className=&quot;absolute top-2 left-2 bg-black/80 hover:bg-red-600 text-white w-8 h-8 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition z-30 shadow-lg&quot;
                            title=&quot;মুছে ফেলুন&quot;
                          >
                            <i className=&quot;fas fa-trash text-sm&quot;></i>
                          </button>

                          <div 
                            className=&quot;w-full aspect-video relative rounded-xl overflow-hidden mb-3 border border-white/10 bg-gray-900 cursor-pointer&quot;
                            onMouseEnter={() => handleMouseEnter(video)}
                            onMouseLeave={handleMouseLeave}
                          >
                            <img src={video.thumbnail} alt={video.title} onClick={() => playVideo(video)} className={`w-full h-full object-cover transition duration-300 ${hoveredVideo === video.id ? 'opacity-0' : 'opacity-100'}`} />
                            
                            {hoveredVideo === video.id &amp;&amp; <HoverPlayer video={video} savedTime={watchedSec} onPlay={() => playVideo(video)} />}

                            {progressPercent > 0 &amp;&amp; hoveredVideo !== video.id &amp;&amp; (
                                <div className=&quot;absolute bottom-0 left-0 right-0 h-1 bg-gray-600/80 z-20 pointer-events-none&quot;>
                                    <div className=&quot;h-full bg-red-600&quot; style={{ width: `${progressPercent}%` }}></div>
                                </div>
                            )}

                            {video.type.includes('playlist') &amp;&amp; (
                                <div className=&quot;absolute bottom-1.5 right-1.5 bg-black/80 text-xs px-2 py-0.5 rounded font-medium flex items-center gap-1 z-20 pointer-events-none&quot;>
                                    <i className=&quot;fas fa-list&quot;></i> Playlist
                                </div>
                            )}

                            {/* External Link Badge for Main Grid */}
                            {video.provider === 'external' &amp;&amp; (
                                <div className=&quot;absolute top-2 right-2 bg-red-600/90 text-white text-[10px] px-2 py-1 rounded font-medium flex items-center gap-1 z-20 pointer-events-none shadow-lg&quot;>
                                    <i className=&quot;fas fa-external-link-alt&quot;></i> Photos
                                </div>
                            )}
                          </div>
                          
                          <div className=&quot;flex gap-3 pr-2 cursor-pointer&quot; onClick={() => playVideo(video)}>
                            <img src={video.channelAvatar} alt={video.channel} className=&quot;w-9 h-9 rounded-full mt-1 flex-shrink-0&quot; />
                            <div>
                              <h3 className=&quot;text-sm font-semibold line-clamp-2 group-hover:text-blue-400&quot;>{video.title}</h3>
                              <p className=&quot;text-sm text-gray-400 mt-1 hover:text-white transition&quot;>{video.channel}</p>
                              <p className=&quot;text-sm text-gray-400&quot;>{video.views}</p>
                            </div>
                          </div>
                        </div>
                      )
                  })}
                </div>
              </div>
            </main>
          </div>

          {/* Local Modal (File &amp; Folder Upload) */}
          {isLocalModalOpen &amp;&amp; (
            <div className=&quot;fixed inset-0 z-[200] flex items-center justify-center bg-black/80 p-4 backdrop-blur-sm&quot;>
                <div className=&quot;bg-[#212121] rounded-2xl w-full max-w-lg border border-gray-700 shadow-2xl overflow-hidden&quot;>
                    <div className=&quot;flex justify-between items-center p-4 border-b border-gray-700&quot;>
                        <h2 className=&quot;text-xl font-bold&quot;>লোকাল ফাইল বা ফোল্ডার যোগ করুন</h2>
                        <button onClick={() => setIsLocalModalOpen(false)} className=&quot;text-gray-400 hover:text-white&quot;><i className=&quot;fas fa-times text-xl&quot;></i></button>
                    </div>
                    <div className=&quot;p-6 flex flex-col gap-6&quot;>
                        <div className=&quot;bg-[#121212] p-5 rounded-xl border border-gray-600 flex flex-col items-center justify-center gap-3 hover:bg-white/5 transition relative cursor-pointer&quot;>
                            <i className=&quot;fas fa-video text-3xl text-emerald-400&quot;></i>
                            <div className=&quot;text-center&quot;>
                                <h3 className=&quot;font-bold mb-1&quot;>ভিডিও ফাইল নির্বাচন করুন</h3>
                                <p className=&quot;text-xs text-gray-400&quot;>এক বা একাধিক .mp4, .webm ফাইল</p>
                            </div>
                            <input 
                                type=&quot;file&quot; 
                                accept=&quot;video/*&quot; 
                                multiple 
                                className=&quot;absolute inset-0 w-full h-full opacity-0 cursor-pointer&quot;
                                onChange={(e) => handleLocalFiles(e, false)}
                            />
                        </div>
                        
                        <div className=&quot;bg-[#121212] p-5 rounded-xl border border-gray-600 flex flex-col items-center justify-center gap-3 hover:bg-white/5 transition relative cursor-pointer&quot;>
                            <i className=&quot;fas fa-folder-open text-3xl text-blue-400&quot;></i>
                            <div className=&quot;text-center&quot;>
                                <h3 className=&quot;font-bold mb-1&quot;>পুরো ফোল্ডার নির্বাচন করুন</h3>
                                <p className=&quot;text-xs text-gray-400&quot;>ফোল্ডারের ভিডিওগুলো প্লেলিস্ট হবে</p>
                            </div>
                            <input 
                                type=&quot;file&quot; 
                                accept=&quot;video/*&quot; 
                                webkitdirectory=&quot;true&quot; 
                                directory=&quot;true&quot; 
                                multiple 
                                className=&quot;absolute inset-0 w-full h-full opacity-0 cursor-pointer&quot;
                                onChange={(e) => handleLocalFiles(e, true)}
                            />
                        </div>
                        
                        <p className=&quot;text-[11px] text-gray-400 text-center&quot;>
                            <i className=&quot;fas fa-info-circle mr-1 text-yellow-500&quot;></i> 
                            ব্রাউজারের সিকিউরিটি রুল অনুযায়ী পেজ রিলোড দিলে লোকাল ফাইলগুলো মুছে যাবে।
                        </p>
                    </div>
                </div>
            </div>
          )}

          {/* Other Modals (Online Add, Alert, Confirm, Create Playlist) ... */}
          {alertState.isOpen &amp;&amp; (
            <div className=&quot;fixed inset-0 z-[300] flex items-center justify-center bg-black/80 p-4 backdrop-blur-sm transition-opacity&quot;>
                <div className=&quot;bg-[#212121] rounded-2xl w-full max-w-sm border border-gray-700 shadow-2xl p-6 text-center transform transition-all scale-100&quot;>
                    <div className=&quot;w-16 h-16 bg-red-500/10 rounded-full flex items-center justify-center mx-auto mb-4 border border-red-500/20&quot;>
                        <i className=&quot;fas fa-exclamation-triangle text-2xl text-red-500&quot;></i>
                    </div>
                    <h2 className=&quot;text-xl font-bold mb-2&quot;>অ্যালার্ট</h2>
                    <p className=&quot;text-gray-400 mb-6&quot;>{alertState.message}</p>
                    <button onClick={() => setAlertState({isOpen: false, message: ''})} className=&quot;bg-blue-600 hover:bg-blue-500 text-white px-6 py-2.5 rounded-full font-bold transition w-full&quot;>
                        ঠিক আছে
                    </button>
                </div>
            </div>
          )}

          {confirmState.isOpen &amp;&amp; (
            <div className=&quot;fixed inset-0 z-[300] flex items-center justify-center bg-black/80 p-4 backdrop-blur-sm transition-opacity&quot;>
                <div className=&quot;bg-[#212121] rounded-2xl w-full max-w-sm border border-gray-700 shadow-2xl p-6 text-center transform transition-all scale-100&quot;>
                    <div className=&quot;w-16 h-16 bg-red-500/10 rounded-full flex items-center justify-center mx-auto mb-4 border border-red-500/20&quot;>
                        <i className=&quot;fas fa-trash-alt text-2xl text-red-500&quot;></i>
                    </div>
                    <h2 className=&quot;text-xl font-bold mb-2&quot;>নিশ্চিত করুন</h2>
                    <p className=&quot;text-gray-400 mb-6&quot;>{confirmState.message}</p>
                    <div className=&quot;flex gap-3&quot;>
                        <button onClick={() => setConfirmState({isOpen: false, message: '', targetId: null})} className=&quot;flex-1 bg-white/10 hover:bg-white/20 text-white py-2.5 rounded-full font-bold transition&quot;>
                            বাতিল
                        </button>
                        <button onClick={executeDelete} className=&quot;flex-1 bg-red-600 hover:bg-red-500 text-white py-2.5 rounded-full font-bold transition&quot;>
                            ডিলিট করুন
                        </button>
                    </div>
                </div>
            </div>
          )}

          {isAddModalOpen &amp;&amp; (
            <div className=&quot;fixed inset-0 z-[200] flex items-center justify-center bg-black/80 p-4 backdrop-blur-sm&quot;>
                <div className=&quot;bg-[#212121] rounded-2xl w-full max-w-lg border border-gray-700 shadow-2xl&quot;>
                    <div className=&quot;flex justify-between items-center p-4 border-b border-gray-700&quot;>
                        <h2 className=&quot;text-xl font-bold&quot;>অনলাইন ভিডিও যোগ করুন</h2>
                        <button onClick={() => setIsAddModalOpen(false)} className=&quot;text-gray-400 hover:text-white&quot;><i className=&quot;fas fa-times text-xl&quot;></i></button>
                    </div>
                    <form onSubmit={handleAddSubmit} className=&quot;p-4 flex flex-col gap-4&quot;>
                        <div>
                            <label className=&quot;block text-sm text-gray-400 mb-1&quot;>ইউটিউব, ড্রাইভ বা ফটোজ লিংক/এমবেড কোড</label>
                            <input type=&quot;text&quot; required placeholder='যেমন: https://photos.app.goo.gl/...' className=&quot;w-full bg-[#121212] border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-blue-500&quot; value={newMediaInput.link} onChange={(e) => setNewMediaInput({...newMediaInput, link: e.target.value})} />
                        </div>
                        <div>
                            <label className=&quot;block text-sm text-gray-400 mb-1&quot;>টাইটেল (খালি রাখলে নিজে থেকেই তৈরি হবে)</label>
                            <input type=&quot;text&quot; placeholder=&quot;ভিডিও বা প্লেলিস্টের নাম&quot; className=&quot;w-full bg-[#121212] border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-blue-500&quot; value={newMediaInput.title} onChange={(e) => setNewMediaInput({...newMediaInput, title: e.target.value})} />
                        </div>
                        <div>
                            <label className=&quot;block text-sm text-gray-400 mb-1&quot;>চ্যানেলের নাম (ঐচ্ছিক)</label>
                            <input type=&quot;text&quot; placeholder=&quot;চ্যানেলের নাম&quot; className=&quot;w-full bg-[#121212] border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-blue-500&quot; value={newMediaInput.channel} onChange={(e) => setNewMediaInput({...newMediaInput, channel: e.target.value})} />
                        </div>
                        <div className=&quot;flex justify-end gap-3 mt-4&quot;>
                            <button type=&quot;button&quot; onClick={() => setIsAddModalOpen(false)} className=&quot;px-4 py-2 rounded-full font-bold hover:bg-white/10&quot;>বাতিল</button>
                            <button type=&quot;submit&quot; className=&quot;bg-blue-600 hover:bg-blue-500 text-white px-5 py-2 rounded-full font-bold transition&quot;>যোগ করুন</button>
                        </div>
                    </form>
                </div>
            </div>
          )}

          {isCreateListModalOpen &amp;&amp; (
            <div className=&quot;fixed inset-0 z-[200] flex items-center justify-center bg-black/80 p-4 backdrop-blur-sm&quot;>
                <div className=&quot;bg-[#212121] rounded-2xl w-full max-w-lg border border-gray-700 shadow-2xl&quot;>
                    <div className=&quot;flex justify-between items-center p-4 border-b border-gray-700&quot;>
                        <h2 className=&quot;text-xl font-bold&quot;>নতুন কাস্টম প্লেলিস্ট বানান</h2>
                        <button onClick={() => setIsCreateListModalOpen(false)} className=&quot;text-gray-400 hover:text-white&quot;><i className=&quot;fas fa-times text-xl&quot;></i></button>
                    </div>
                    <form onSubmit={handleCreatePlaylist} className=&quot;p-4 flex flex-col gap-4&quot;>
                        <div>
                            <label className=&quot;block text-sm text-gray-400 mb-1&quot;>প্লেলিস্টের নাম</label>
                            <input type=&quot;text&quot; required placeholder=&quot;যেমন: My Favorite Videos&quot; className=&quot;w-full bg-[#121212] border border-gray-600 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-blue-500&quot; value={newListTitle} onChange={(e) => setNewListTitle(e.target.value)} />
                        </div>
                        <div>
                            <label className=&quot;block text-sm text-gray-400 mb-1&quot;>ভিডিও সিলেক্ট করুন</label>
                            <div className=&quot;max-h-60 overflow-y-auto bg-[#121212] rounded-lg p-2 flex flex-col gap-1 border border-gray-600 custom-scrollbar&quot;>
                                {videos.filter(v => v.type === 'video' &amp;&amp; v.provider !== 'gdrive' &amp;&amp; v.provider !== 'local').length === 0 &amp;&amp; <p className=&quot;text-center text-gray-400 py-4 text-sm&quot;>কোনো ইউটিউব ভিডিও নেই। আগে ভিডিও যোগ করুন!</p>}
                                {videos.filter(v => v.type === 'video' &amp;&amp; v.provider !== 'gdrive' &amp;&amp; v.provider !== 'local').map(v => (
                                    <label key={v.id} className=&quot;flex items-center gap-3 p-2 hover:bg-white/10 rounded cursor-pointer transition&quot;>
                                        <input type=&quot;checkbox&quot; checked={selectedVideoIds.includes(v.videoId)} onChange={(e) => { if(e.target.checked) setSelectedVideoIds([...selectedVideoIds, v.videoId]); else setSelectedVideoIds(selectedVideoIds.filter(id => id !== v.videoId)); }} className=&quot;w-4 h-4 rounded border-gray-500 bg-black cursor-pointer&quot; />
                                        <img src={v.thumbnail} className=&quot;w-12 h-8 object-cover rounded&quot; />
                                        <span className=&quot;text-sm truncate select-none&quot;>{v.title}</span>
                                    </label>
                                ))}
                            </div>
                            <p className=&quot;text-xs text-gray-400 mt-2 text-right&quot;>{selectedVideoIds.length} টি ভিডিও সিলেক্ট করা হয়েছে</p>
                        </div>
                        <div className=&quot;flex justify-end gap-3 mt-2&quot;>
                            <button type=&quot;button&quot; onClick={() => setIsCreateListModalOpen(false)} className=&quot;px-4 py-2 rounded-full font-bold hover:bg-white/10&quot;>বাতিল</button>
                            <button type=&quot;submit&quot; className=&quot;bg-blue-600 hover:bg-blue-500 text-white px-5 py-2 rounded-full font-bold transition&quot;>সেভ করুন</button>
                        </div>
                    </form>
                </div>
            </div>
          )}
        </div>
      );
    }

    window._chapterInitVideos = [];
    window._chapterId = 'global';
    window.addEventListener('message', function(e) {
      if (e.data &amp;&amp; e.data.type === 'initChapterVideos') {
        window._chapterInitVideos = e.data.videos || [];
        window._chapterId = e.data.chapterId || 'global';
        // Force full re-render with new chapter context
        const container = document.getElementById('root');
        container.innerHTML = '';
        ReactDOM.createRoot(container).render(React.createElement(App));
      }
    });
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>"
                                    ></iframe>
                                </div>

                                <!-- Tab: Q&A (Advanced Flashcard) -->
                                <div id="tab-content-qna" class="hidden flex flex-col min-h-full">

                                    
                                    <!-- List View -->
                                    <div id="qna-view-list" class="p-6 space-y-4"></div>
                                    
                                    <!-- Flashcard View -->
                                    <div id="qna-view-card" class="hidden p-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>

                                    <div id="empty-qna-msg" class="hidden flex-grow flex flex-col items-center justify-center text-gray-400 py-20">
                                        <i data-lucide="help-circle" class="h-10 w-10 mb-2 opacity-30"></i>
                                        <p>কোন প্রশ্ন যুক্ত করা হয়নি</p>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <!-- MODALS -->
    
    <!-- Add Text Link Modal -->
    <div id="modal-add-text-link" class="modal opacity-0 pointer-events-none fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-900 w-11/12 max-w-md rounded-xl shadow-2xl p-6">
            <h3 class="text-xl font-bold dark:text-white mb-4">ক্লাউড টেক্সট লিংক</h3>
            <input type="text" id="input-text-url" class="w-full px-3 py-2 border rounded-lg dark:bg-gray-800 dark:border-gray-700 dark:text-white outline-none mb-2" placeholder="Google Drive / Raw Text URL">
            <p class="text-xs text-gray-500 mb-4">Google Drive এর লিংকটি 'Anyone with the link' মুডে থাকতে হবে।</p>
            <div class="flex justify-end gap-2">
                <button onclick="closeModal('modal-add-text-link')" class="px-4 py-2 text-gray-500">বাতিল</button>
                <button onclick="saveTextLink()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg">সংরক্ষণ</button>
            </div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="modal-confirm" class="modal opacity-0 pointer-events-none fixed inset-0 z-[60] flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-900 w-11/12 max-w-sm rounded-xl shadow-2xl overflow-hidden transform scale-95 transition-all">
            <div class="p-6 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 dark:bg-red-900/30 mb-4">
                    <i data-lucide="alert-triangle" class="h-6 w-6 text-red-600"></i>
                </div>
                <h3 class="text-lg font-bold text-gray-900 dark:text-white">সতর্কীকরণ</h3>
                <p id="confirm-modal-text" class="text-sm text-gray-500 mt-2">আপনি কি নিশ্চিত?</p>
            </div>
            <div class="bg-gray-50 dark:bg-gray-800/50 px-6 py-4 flex gap-3">
                <button onclick="closeModal('modal-confirm')" class="flex-1 px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm font-medium hover:bg-gray-100 dark:hover:bg-gray-700">বাতিল</button>
                <button id="confirm-modal-btn" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg text-sm font-medium hover:bg-red-700">নিশ্চিত</button>
            </div>
        </div>
    </div>

    <!-- Subject Modal -->
    <div id="modal-subject" class="modal opacity-0 pointer-events-none fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-900 w-11/12 max-w-md rounded-xl shadow-2xl p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modal-subject-title" class="text-xl font-bold dark:text-white">নতুন বিষয়</h3>
                <button onclick="closeModal('modal-subject')"><i data-lucide="x" class="text-gray-500"></i></button>
            </div>
            <div class="space-y-4">
                <input type="hidden" id="input-sub-id">
                <input type="text" id="input-sub-name" class="w-full px-3 py-2 border rounded-lg dark:bg-gray-800 dark:border-gray-700 dark:text-white outline-none" placeholder="নাম">
                <input type="text" id="input-sub-desc" class="w-full px-3 py-2 border rounded-lg dark:bg-gray-800 dark:border-gray-700 dark:text-white outline-none" placeholder="বিবরণ (অপশনাল)">
                <div id="modal-group-select-wrapper" class="hidden">
                    <select id="input-sub-group" class="w-full px-3 py-2 border rounded-lg dark:bg-gray-800 dark:border-gray-700 dark:text-white">
                        <option value="common">আবশ্যিক (Common)</option><option value="science">বিজ্ঞান</option><option value="arts">মানবিক</option><option value="commerce">ব্যবসায় শিক্ষা</option>
                    </select>
                </div>
                <label class="flex items-center gap-2"><input type="checkbox" id="input-sub-optional" class="rounded text-indigo-600"><span class="text-sm text-gray-700 dark:text-gray-300">ঐচ্ছিক বিষয়?</span></label>
                <div class="flex justify-end gap-2 mt-6">
                    <button onclick="closeModal('modal-subject')" class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg">বাতিল</button>
                    <button onclick="saveSubject()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">সংরক্ষণ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Import Modal -->
    <div id="modal-bulk-import" class="modal opacity-0 pointer-events-none fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-900 w-11/12 max-w-lg rounded-xl shadow-2xl p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 id="modal-bulk-title" class="text-xl font-bold dark:text-white">বাল্ক ইম্পোর্ট</h3>
                <button onclick="closeModal('modal-bulk-import')"><i data-lucide="x" class="text-gray-500"></i></button>
            </div>
            <div id="bulk-import-controls" class="flex items-center gap-2 mb-3 bg-indigo-50 dark:bg-gray-800 p-2 rounded-lg">
                <input type="checkbox" id="bulk-include-chapters" class="h-4 w-4">
                <label for="bulk-include-chapters" class="text-sm font-medium dark:text-gray-300">সূচিপত্র সহ (Advanced)</label>
            </div>
            <p id="bulk-import-help" class="text-xs text-gray-500 mb-2">ফরম্যাট: *বিষয়, **অপ্রয়োজনীয়, !1বিজ্ঞান, !1*ঐচ্ছিক</p>
            <textarea id="bulk-import-text" class="w-full h-48 p-3 border rounded-lg dark:bg-gray-800 dark:border-gray-700 dark:text-white font-mono text-sm outline-none" placeholder="*বাংলা&#10;**সংগীত&#10;!1পদার্থবিজ্ঞান&#10;!1*উচ্চতর গণিত&#10;!12*কৃষিশিক্ষা"></textarea>
            <div class="flex justify-end gap-2 mt-4">
                <button id="btn-bulk-process" onclick="processBulkImport()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg">ইম্পোর্ট করুন</button>
            </div>
        </div>
    </div>

    <!-- Add Chapter Modal -->
    <div id="modal-add-chapter" class="modal opacity-0 pointer-events-none fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-900 w-11/12 max-w-sm rounded-xl shadow-2xl p-6">
            <h3 class="text-xl font-bold dark:text-white mb-4">নতুন অধ্যায়</h3>
            <input type="text" id="input-chap-name" class="w-full px-3 py-2 border rounded-lg dark:bg-gray-800 dark:border-gray-700 dark:text-white outline-none" placeholder="নাম">
            <div class="flex justify-end gap-2 mt-4">
                <button onclick="closeModal('modal-add-chapter')" class="px-4 py-2 text-gray-500">বাতিল</button>
                <button onclick="saveNewChapter()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg">সংরক্ষণ</button>
            </div>
        </div>
    </div>

    <!-- CONTENT EDIT MODALS -->

    <!-- Edit Text/Markdown Modal (UPDATED: With Image Tool) -->
    <div id="modal-edit-text" class="modal opacity-0 pointer-events-none fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-900 w-11/12 max-w-4xl h-[85vh] rounded-xl shadow-2xl p-6 flex flex-col">
            <div class="flex justify-between items-center mb-4 flex-none">
                <h3 class="text-xl font-bold dark:text-white">ডিজিটাল পাঠ এডিট (Markdown)</h3>
                <button onclick="closeModal('modal-edit-text')"><i data-lucide="x" class="text-gray-500"></i></button>
            </div>
            
            <!-- Editor Toolbar -->
            <div class="flex-none flex flex-wrap gap-2 mb-2 p-2 bg-gray-100 dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700">
                <button onclick="insertMarkdown('**', '**')" class="toolbar-btn text-gray-700 dark:text-gray-300" title="Bold">B</button>
                <button onclick="insertMarkdown('*', '*')" class="toolbar-btn text-gray-700 dark:text-gray-300 italic" title="Italic">I</button>
                <div class="w-px h-6 bg-gray-300 dark:bg-gray-600 mx-1"></div>
                <button onclick="insertMarkdown('# ', '')" class="toolbar-btn text-gray-700 dark:text-gray-300" title="H1">H1</button>
                <button onclick="insertMarkdown('## ', '')" class="toolbar-btn text-gray-700 dark:text-gray-300" title="H2">H2</button>
                <button onclick="insertMarkdown('### ', '')" class="toolbar-btn text-gray-700 dark:text-gray-300" title="H3">H3</button>
                <div class="w-px h-6 bg-gray-300 dark:bg-gray-600 mx-1"></div>
                <button onclick="insertMarkdown('- ', '')" class="toolbar-btn text-gray-700 dark:text-gray-300" title="List"><i data-lucide="list" class="h-4 w-4"></i></button>
                <button onclick="insertMarkdown('`', '`')" class="toolbar-btn text-gray-700 dark:text-gray-300" title="Code"><i data-lucide="code" class="h-4 w-4"></i></button>
                <div class="w-px h-6 bg-gray-300 dark:bg-gray-600 mx-1"></div>
                <button onclick="openInsertImageModal()" class="toolbar-btn bg-indigo-100 text-indigo-700 dark:bg-indigo-900 dark:text-indigo-300" title="Insert Image Layout"><i data-lucide="image-plus" class="h-4 w-4 inline mr-1"></i> ছবি যুক্ত করুন</button>
                <button onclick="insertMarkdown('[', '](url)')" class="toolbar-btn text-gray-700 dark:text-gray-300" title="Link"><i data-lucide="link" class="h-4 w-4"></i></button>
            </div>

            <div class="flex-grow flex flex-col md:flex-row gap-4 h-full overflow-hidden">
                <textarea id="input-content-text" class="w-full md:w-1/2 h-full p-4 border rounded-lg dark:bg-gray-800 dark:border-gray-700 dark:text-white font-mono text-sm outline-none resize-none focus:ring-2 focus:ring-indigo-500" placeholder="# শিরোনাম&#10;**বোল্ড টেক্সট**&#10;- তালিকা ১&#10;- তালিকা ২"></textarea>
                <div class="hidden md:block w-1/2 h-full border rounded-lg p-4 overflow-y-auto bg-gray-50 dark:bg-gray-800/50 prose dark:prose-invert" id="preview-content-text">
                    <p class="text-gray-400 text-center mt-10">Preview</p>
                </div>
            </div>
            <div class="flex-none flex justify-end gap-2 mt-4">
                <button onclick="saveContentText()" class="px-6 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">সংরক্ষণ করুন</button>
            </div>
        </div>
    </div>

    <!-- INSERT IMAGE LAYOUT MODAL (NEW) -->
    <div id="modal-insert-image" class="modal opacity-0 pointer-events-none fixed inset-0 z-[60] flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-900 w-11/12 max-w-lg rounded-xl shadow-2xl p-6">
            <h3 class="text-xl font-bold dark:text-white mb-4">ছবির লেআউট নির্বাচন করুন</h3>
            
            <!-- Tabs -->
            <div class="flex gap-2 mb-4 border-b border-gray-200 dark:border-gray-700 pb-2">
                <button onclick="toggleImageLayoutInputs('float')" id="btn-layout-float" class="px-3 py-1 text-sm font-medium rounded-md bg-indigo-100 text-indigo-700 dark:bg-indigo-900 dark:text-indigo-300 transition">Text Wrap</button>
                <button onclick="toggleImageLayoutInputs('center')" id="btn-layout-center" class="px-3 py-1 text-sm font-medium rounded-md text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800 transition">Center Block</button>
                <button onclick="toggleImageLayoutInputs('grid')" id="btn-layout-grid" class="px-3 py-1 text-sm font-medium rounded-md text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800 transition">Gallery Grid</button>
            </div>

            <!-- Float Inputs -->
            <div id="layout-inputs-float" class="space-y-3">
                <div class="grid grid-cols-2 gap-3">
                    <select id="img-float-dir" class="px-3 py-2 border rounded-lg dark:bg-gray-800 dark:border-gray-700 dark:text-white">
                        <option value="right">ডান দিকে (Right)</option>
                        <option value="left">বাম দিকে (Left)</option>
                    </select>
                    <select id="img-float-size" class="px-3 py-2 border rounded-lg dark:bg-gray-800 dark:border-gray-700 dark:text-white">
                        <option value="w-1/2 md:w-1/3">মাঝারি (33%)</option>
                        <option value="w-1/2 md:w-1/4">ছোট (25%)</option>
                        <option value="w-1/2">বড় (50%)</option>
                    </select>
                </div>
                <input type="text" id="img-float-url" class="w-full px-3 py-2 border rounded-lg dark:bg-gray-800 dark:border-gray-700 dark:text-white" placeholder="ছবির লিংক (URL)">
                <input type="text" id="img-float-cap" class="w-full px-3 py-2 border rounded-lg dark:bg-gray-800 dark:border-gray-700 dark:text-white" placeholder="ক্যাপশন (ঐচ্ছিক)">
            </div>

            <!-- Center Inputs -->
            <div id="layout-inputs-center" class="space-y-3 hidden">
                <input type="text" id="img-center-url" class="w-full px-3 py-2 border rounded-lg dark:bg-gray-800 dark:border-gray-700 dark:text-white" placeholder="ছবির লিংক (URL)">
                <input type="text" id="img-center-cap" class="w-full px-3 py-2 border rounded-lg dark:bg-gray-800 dark:border-gray-700 dark:text-white" placeholder="ক্যাপশন">
            </div>

            <!-- Grid Inputs -->
            <div id="layout-inputs-grid" class="space-y-3 hidden">
                <p class="text-xs text-gray-500">দুটি ছবি পাশাপাশি দেখাবে (মোবাইলে উপর-নিচ)</p>
                <div class="grid grid-cols-1 gap-3 border p-2 rounded border-dashed border-gray-300 dark:border-gray-700">
                    <input type="text" id="img-grid-url1" class="w-full px-3 py-1 border rounded text-sm dark:bg-gray-800 dark:border-gray-700 dark:text-white" placeholder="১ম ছবির লিংক">
                    <input type="text" id="img-grid-cap1" class="w-full px-3 py-1 border rounded text-sm dark:bg-gray-800 dark:border-gray-700 dark:text-white" placeholder="১ম ক্যাপশন">
                </div>
                <div class="grid grid-cols-1 gap-3 border p-2 rounded border-dashed border-gray-300 dark:border-gray-700">
                    <input type="text" id="img-grid-url2" class="w-full px-3 py-1 border rounded text-sm dark:bg-gray-800 dark:border-gray-700 dark:text-white" placeholder="২য় ছবির লিংক">
                    <input type="text" id="img-grid-cap2" class="w-full px-3 py-1 border rounded text-sm dark:bg-gray-800 dark:border-gray-700 dark:text-white" placeholder="২য় ক্যাপশন">
                </div>
            </div>

            <div class="flex justify-end gap-2 mt-6">
                <button onclick="closeModal('modal-insert-image')" class="px-4 py-2 text-gray-500">বাতিল</button>
                <button onclick="insertImageHtml()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">যুক্ত করুন</button>
            </div>
        </div>
    </div>

    <!-- Edit PDF Modal (UPDATED: Multi-PDF) -->
    <div id="modal-edit-pdf" class="modal opacity-0 pointer-events-none fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-900 w-11/12 max-w-lg rounded-xl shadow-2xl p-6">
            <h3 class="text-xl font-bold dark:text-white mb-4">PDF লাইব্রেরি ম্যানেজমেন্ট</h3>
            
            <div class="flex gap-2 mb-4">
                <input type="text" id="input-pdf-title" class="w-1/3 px-3 py-2 border rounded-lg dark:bg-gray-800 dark:border-gray-700 dark:text-white outline-none" placeholder="শিরোনাম (e.g., Guide)">
                <input type="text" id="input-pdf-url" class="flex-grow px-3 py-2 border rounded-lg dark:bg-gray-800 dark:border-gray-700 dark:text-white outline-none" placeholder="Link (Google Drive/Web)">
                <button onclick="addPdfResource()" class="bg-indigo-600 text-white px-3 py-2 rounded-lg hover:bg-indigo-700">Add</button>
            </div>

            <div class="bg-gray-50 dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700 h-48 overflow-y-auto p-2" id="pdf-manage-list">
                <!-- List will be here -->
            </div>

            <div class="flex justify-end gap-2 mt-4">
                <button onclick="closeModal('modal-edit-pdf')" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 rounded-lg">বন্ধ করুন</button>
            </div>
        </div>
    </div>

    <!-- Edit Video Modal -->
    <div id="modal-edit-video" class="modal opacity-0 pointer-events-none fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-900 w-11/12 max-w-md rounded-xl shadow-2xl p-6">
            <h3 class="text-xl font-bold dark:text-white mb-4">নতুন ভিডিও লিংক</h3>
            <input type="text" id="input-video-title" class="w-full px-3 py-2 border rounded-lg dark:bg-gray-800 dark:border-gray-700 dark:text-white outline-none mb-3" placeholder="ভিডিও শিরোনাম">
            <input type="text" id="input-video-url" class="w-full px-3 py-2 border rounded-lg dark:bg-gray-800 dark:border-gray-700 dark:text-white outline-none mb-2" placeholder="Video Link or Embed Code">
            <p class="text-xs text-gray-500 mb-4">ইউটিউব লিংক বা &lt;iframe&gt; এমবেড কোড দিন।</p>
            <div class="flex justify-end gap-2">
                <button onclick="closeModal('modal-edit-video')" class="px-4 py-2 text-gray-500">বাতিল</button>
                <button onclick="addVideo()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg">যুক্ত করুন</button>
            </div>
            <div id="video-list-manage" class="mt-4 max-h-40 overflow-y-auto border-t pt-2">
                <!-- List of existing videos to delete will go here -->
            </div>
        </div>
    </div>

    <!-- Edit Q&A Modal -->
    <div id="modal-edit-qna" class="modal opacity-0 pointer-events-none fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-900 w-11/12 max-w-lg rounded-xl shadow-2xl p-6">
            <h3 class="text-xl font-bold dark:text-white mb-4">প্রশ্ন ও উত্তর / লিংক</h3>
            <textarea id="input-qna-q" class="w-full p-2 border rounded-lg dark:bg-gray-800 dark:border-gray-700 dark:text-white outline-none mb-2 font-bold" rows="2" placeholder="প্রশ্ন বা শিরোনাম..."></textarea>
            <textarea id="input-qna-a" class="w-full p-2 border rounded-lg dark:bg-gray-800 dark:border-gray-700 dark:text-white outline-none mb-4" rows="4" placeholder="উত্তর বা লিংক..."></textarea>
            <div class="flex justify-end gap-2">
                <button onclick="closeModal('modal-edit-qna')" class="px-4 py-2 text-gray-500">বাতিল</button>
                <button onclick="addQna()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg">যুক্ত করুন</button>
            </div>
             <div id="qna-list-manage" class="mt-4 max-h-40 overflow-y-auto border-t pt-2 space-y-2">
                <!-- Manage existing QnA -->
            </div>
        </div>
    </div>

    <!-- Statistics Modal -->
    <div id="modal-stats" class="modal opacity-0 pointer-events-none fixed inset-0 flex items-center justify-center bg-black/60 backdrop-blur-sm" style="z-index:9998">
        <div class="bg-white dark:bg-gray-900 w-11/12 max-w-6xl rounded-xl shadow-2xl p-6 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-900 dark:text-white flex items-center gap-2">
                    <i data-lucide="bar-chart-3" class="h-6 w-6 text-purple-600"></i>
                    পড়াশোনার পরিসংখ্যান
                </h3>
                <button onclick="closeModal('modal-stats')" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-full transition">
                    <i data-lucide="x" class="h-5 w-5"></i>
                </button>
            </div>
            <div id="stats-modal-content">
                <!-- Content will be populated by JavaScript -->
            </div>
        </div>
    </div>


    <script>
        // --- DATA & INITIALIZATION ---
        // Mapping for Default Data Files in "index/" folder
        const DEFAULT_DATA_FILES = {
            6: 'index/class6.txt',
            7: 'index/class7.txt',
            8: 'index/class8.txt',
            9: 'index/ssc.txt',  // Class 9 (SSC)
            11: 'index/hsc.txt' // Class 11 (HSC)
        };

        let subjectsData = {};
        let currentClass = null;
        let progressData = JSON.parse(localStorage.getItem('smartPathshala_progress')) || {};
        let statsData = JSON.parse(localStorage.getItem('smartPathshala_stats')) || { studyTime: {}, streak: { current: 0, best: 0, lastStudyDate: null }, sessionsLog: [], goals: { daily: 30 } };
        let currentSubject = null;
        let currentChapterNode = null; 
        let activeTab = 'text'; 
        let qnaViewMode = 'list';
        let currentImageLayout = 'float';

        let currentGroup = 'science';
        let showOptional = false;
        let isEditMode = false;
        let dragSrcId = null;
        let expandTimer = null;
        let openAccordionIds = new Set();
        let lastReadPosition = JSON.parse(localStorage.getItem('smartPathshala_lastRead') || '{}');

        let selectedIds = new Set();
        let saveDataTimeout = null;
        
        // Smart ID Generation - creates SHORT, CONSISTENT IDs
        let idCounters = { subject: 0, chapter: 0 };
        
        // Simple hash function to create consistent short IDs from text
        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32bit integer
            }
            // Convert to base36 and take first 6 characters
            return Math.abs(hash).toString(36).substring(0, 6);
        }
        
        function generateShortId(type, title = '', classId = null) {
            if (!title) {
                // Fallback to counter if no title
                if (type === 'subject') {
                    idCounters.subject++;
                    return 's' + idCounters.subject;
                } else {
                    idCounters.chapter++;
                    return 'c' + idCounters.chapter;
                }
            }
            
            // Create a deterministic ID from the title
            // This ensures the same title always gets the same ID
            const baseId = simpleHash(title);
            
            // Add class prefix for subjects to avoid conflicts across classes
            if (type === 'subject' && classId) {
                return 's' + classId + '_' + baseId;
            } else if (type === 'chapter') {
                return 'c' + baseId;
            }
            
            return baseId;
        }
        
        // Initialize counters from existing data
        function initializeIdCounters() {
            let maxSubjectNum = 0;
            let maxChapterNum = 0;
            
            // Check all subjects
            [6, 7, 8, 9, 11].forEach(classId => {
                const subjects = subjectsData[classId] || [];
                subjects.forEach(subject => {
                    // Extract number from IDs like "s5", "s10"
                    const match = subject.id.match(/^s(\d+)$/);
                    if (match) {
                        maxSubjectNum = Math.max(maxSubjectNum, parseInt(match[1]));
                    }
                    
                    // Check chapters
                    function checkChapters(nodes) {
                        if (!nodes) return;
                        nodes.forEach(node => {
                            const chMatch = node.id.match(/^c(\d+)$/);
                            if (chMatch) {
                                maxChapterNum = Math.max(maxChapterNum, parseInt(chMatch[1]));
                            }
                            if (node.children) checkChapters(node.children);
                        });
                    }
                    
                    if (subject.chapters) checkChapters(subject.chapters);
                });
            });
            
            idCounters.subject = maxSubjectNum;
            idCounters.chapter = maxChapterNum;
        }

        async function init() {
            // Check Local Storage
            const stored = localStorage.getItem('smartPathshalaData_v2') || localStorage.getItem('smartPathshalaData');
            
            if (stored) {
                // If data exists, load it
                subjectsData = JSON.parse(stored);
                // Ensure all keys exist
                [6,7,8,9,11].forEach(c => { if(!subjectsData[c]) subjectsData[c] = []; });
                initializeIdCounters(); // Initialize ID counters from existing data
                initUI();
            } else {
                // If NO data, Fetch Default from "index" folder
                await fetchDefaultData();
            }
        }

        async function fetchDefaultData() {
            const overlay = document.getElementById('auto-import-overlay');
            overlay.classList.remove('hidden');

            // Initialize structure
            subjectsData = {};
            [6,7,8,9,11].forEach(c => subjectsData[c] = []);

            try {
                const promises = Object.entries(DEFAULT_DATA_FILES).map(async ([classId, filePath]) => {
                    try {
                        const response = await fetch(filePath);
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        const text = await response.text();
                        // Import Logic (using shared logic with Bulk Import)
                        parseAndImportData(text, parseInt(classId), true); // true = include chapters
                        console.log(`Loaded ${filePath} for Class ${classId}`);
                    } catch (e) {
                        console.warn(`Failed to load default data for Class ${classId}:`, e);
                        // Optional: Create basic empty structure if fetch fails
                    }
                });

                await Promise.all(promises);
                saveData(); // Save fetched data to local storage
            } catch (err) {
                console.error("Global fetch error:", err);
            } finally {
                overlay.classList.add('hidden');
                initUI();
            }
        }

        function initUI() {
            renderClassCards();
            checkTheme();
            lucide.createIcons();
            
            // Load YouTube API
            if (!window.YT) {
                var tag = document.createElement('script');
                tag.src = "https://www.youtube.com/iframe_api";
                var firstScriptTag = document.getElementsByTagName('script')[0];
                firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
            }

            document.getElementById('input-content-text').addEventListener('input', function() {
                document.getElementById('preview-content-text').innerHTML = marked.parse(this.value);
            });
            
            // Custom Renderer
            const renderer = new marked.Renderer();
            renderer.image = function(href, title, text) {
                return `<img src="${href}" alt="${text}" title="${title || ''}" class="max-w-full h-auto rounded-lg shadow-md my-4 mx-auto block" onerror="this.style.display='none'; this.insertAdjacentHTML('afterend', '<p class=\\'text-red-400 text-xs italic text-center\\'>[ইমেজ লোড ব্যর্থ: সঠিক URL দিন]</p>')">`;
            };
            renderer.link = function(href, title, text) {
                return `<a href="${href}" title="${title || ''}" target="_blank" class="text-blue-600 hover:underline break-words">${text}</a>`;
            };
            renderer.table = function(header, body) {
                return `<div class="overflow-x-auto my-4 rounded-lg border border-gray-200 dark:border-gray-700"><table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700"><thead class="bg-gray-50 dark:bg-gray-800">${header}</thead><tbody class="bg-white dark:bg-gray-900 divide-y divide-gray-200 dark:divide-gray-700">${body}</tbody></table></div>`;
            };

            marked.setOptions({
                renderer: renderer,
                gfm: true,
                breaks: true
            });
            
            // Debounced Save Helper
            window.debouncedSave = function() {
                if(saveDataTimeout) clearTimeout(saveDataTimeout);
                saveDataTimeout = setTimeout(() => {
                    saveData();
                }, 1000);
            };

            // Toggle PDF Sidebar
            document.getElementById('toggle-pdf-sidebar').onclick = function() {
                document.getElementById('pdf-sidebar').classList.toggle('hidden');
                document.getElementById('pdf-sidebar').classList.toggle('flex');
            }
        }

        function normalizeChapters(list) {
            if(!list) return [];
            return list.map(item => {
                const title = typeof item === 'string' ? item : item.title;
                const node = {
                    id: item.id || `ch_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`,
                    title: title,
                    children: typeof item === 'object' && item.children ? normalizeChapters(item.children) : [],
                    content: (typeof item === 'object' && item.content) ? item.content : { text: '', pdfUrl: '', pdfs: [], videos: [], qna: [], textUrl: '' }
                };
                return node;
            });
        }
        
        function ensureContentStructure(node) {
            if(!node.content) node.content = { text: '', pdfUrl: '', pdfs: [], videos: [], qna: [], textUrl: '' };
            if(!node.content.textUrl) node.content.textUrl = ''; 
            if(!node.content.pdfs) {
                node.content.pdfs = [];
                if(node.content.pdfUrl) {
                    node.content.pdfs.push({ title: 'মূল বই (Default)', url: node.content.pdfUrl });
                }
            }
            if(node.children) node.children.forEach(ensureContentStructure);
        }

        function saveData() { localStorage.setItem('smartPathshalaData_v2', JSON.stringify(subjectsData)); localStorage.setItem('smartPathshala_progress', JSON.stringify(progressData)); localStorage.setItem('smartPathshala_stats', JSON.stringify(statsData)); }
        
        // UPDATED: Reset now re-fetches default data
        function resetData() { 
            localStorage.removeItem('smartPathshalaData_v2'); 
            localStorage.removeItem('smartPathshalaData'); 
            location.reload(); 
        }

        // --- CORE PARSING LOGIC (Shared between Fetch & UI Import) ---
        function parseAndImportData(text, classId, includeChapters) {
            const lines = text.split('\n').filter(l => l.trim());
            
            // We need to fetch the existing array or create it if missing (for fetch logic)
            if(!subjectsData[classId]) subjectsData[classId] = [];

            let activeSubjects = []; // Holds references to currently created subjects
            
            const isJunior = [6, 7, 8].includes(classId);

            lines.forEach(line => {
                const trimmed = line.trim();
                
                // 1. Subject Definitions
                if (trimmed.startsWith('*') || (trimmed.startsWith('!') && !isJunior)) {
                    activeSubjects = []; // Reset active
                    
                    // Common Subjects (* or **)
                    if (trimmed.startsWith('*')) {
                        const isDouble = trimmed.startsWith('**');
                        const name = isDouble ? trimmed.substring(2).trim() : trimmed.substring(1).trim();
                        
                        if (name) {
                            const sub = {
                                id: generateShortId("subject", name, classId),
                                name: name,
                                desc: isDouble ? 'অপ্রয়োজনীয় (ঐচ্ছিক)' : 'আবশ্যিক',
                                icon: 'book',
                                group: 'common',
                                isOptional: isDouble,
                                isGroupOptional: false,
                                chapters: []
                            };
                            subjectsData[classId].push(sub);
                            activeSubjects.push(sub);
                        }
                    }
                    // Group Subjects (!1, !1*, etc)
                    else if (trimmed.startsWith('!') && !isJunior) {
                        const match = trimmed.match(/^!([123]+)(\*)?\s*(.*)/);
                        if (match) {
                            const groupsStr = match[1];
                            const isGroupOpt = !!match[2];
                            const name = match[3];
                            const groupMap = { '1': 'science', '2': 'arts', '3': 'commerce' };
                            
                            for (const char of groupsStr) {
                                const grp = groupMap[char];
                                if (grp && name) {
                                    const sub = {
                                        id: generateShortId("subject", name, classId),
                                        name: name,
                                        desc: isGroupOpt ? 'বিভাগীয় ঐচ্ছিক' : 'বিভাগীয়',
                                        icon: 'book',
                                        group: grp,
                                        isOptional: false,
                                        isGroupOptional: isGroupOpt,
                                        chapters: []
                                    };
                                    subjectsData[classId].push(sub);
                                    activeSubjects.push(sub);
                                }
                            }
                        }
                    }
                }
                // 2. Chapter Definitions
                else if (activeSubjects.length > 0 && includeChapters && (trimmed.startsWith('#') || trimmed.startsWith('-'))) {
                    let depth = -1;
                    let title = '';
                    if (trimmed.startsWith('#')) { depth = 0; title = trimmed.substring(1).trim(); }
                    else if (trimmed.startsWith('-')) {
                        const match = trimmed.match(/^(-+)\s*(.*)/);
                        if (match) { depth = match[1].length; title = match[2].trim(); }
                    }

                    if (depth > -1 && title) {
                        activeSubjects.forEach((sub) => {
                            const newNode = { 
                                id: generateShortId("chapter", title), 
                                title: title, 
                                children: [],
                                content: { text: '', pdfUrl: '', pdfs: [], videos: [], qna: [], textUrl: '' }
                            };
                            
                            if (!sub._importStack) sub._importStack = [];
                            const stack = sub._importStack;
                            
                            if (stack.length === 0) {
                                sub.chapters.push(newNode);
                                stack.push({ node: newNode, depth: depth });
                            } else {
                                while (stack.length > 0 && stack[stack.length - 1].depth >= depth) stack.pop();
                                if (stack.length > 0) stack[stack.length - 1].node.children.push(newNode);
                                else sub.chapters.push(newNode);
                                stack.push({ node: newNode, depth: depth });
                            }
                        });
                    }
                }
            });
            
            // Cleanup
            subjectsData[classId].forEach(s => delete s._importStack);
        }

        // --- NAVIGATION & UI ---
        function hideAllViews() { 
            ['view-classes', 'view-subjects', 'view-reader'].forEach(id => document.getElementById(id).classList.add('hidden')); 
        }
        function goHome() {
            hideAllViews(); document.getElementById('view-classes').classList.remove('hidden');
            currentClass = null; currentSubject = null; currentChapterNode = null;
            isEditMode = false; selectedIds.clear(); updateEditModeUI();
            updateURL(); // Update URL
        }
        function selectClass(clsId, clsName) {
            currentClass = { id: clsId, name: clsName };
            hideAllViews(); document.getElementById('view-subjects').classList.remove('hidden');
            document.getElementById('selected-class-name').innerText = clsName;
            const gs = document.getElementById('group-selector-container');
            if(clsId===9||clsId===11) gs.classList.remove('hidden'); else gs.classList.add('hidden');
            isEditMode=false; selectedIds.clear(); updateEditModeUI(); renderSubjects();
            updateURL(); // Update URL
        }
        function showSubjects() {
             if(currentClass) {
                 // End study session when leaving chapter view
                 if (studySessionStart) {
                     endStudySession();
                 }
                 // Reset currentSubject to null when going back
                 currentSubject = null;
                 currentChapterNode = null;
                 hideAllViews(); document.getElementById('view-subjects').classList.remove('hidden');
                 isEditMode=false; selectedIds.clear(); updateEditModeUI(); renderSubjects();
                 updateURL(); // Update URL
             }
        }

        // --- RENDER FUNCTIONS ---
        function renderClassCards() {
            const rowJun = document.getElementById('row-junior'); const rowSen = document.getElementById('row-senior');
            rowJun.innerHTML = ''; rowSen.innerHTML = ''; // Clear first to avoid duplicates on reset
            const classes = [
                { id: 6, name: 'ষষ্ঠ শ্রেণী', icon: 'graduation-cap', color: 'text-blue-600 bg-blue-50 dark:bg-blue-900/20' },
                { id: 7, name: 'সপ্তম শ্রেণী', icon: 'book-open', color: 'text-green-600 bg-green-50 dark:bg-green-900/20' },
                { id: 8, name: 'অষ্টম শ্রেণী', icon: 'library', color: 'text-yellow-600 bg-yellow-50 dark:bg-yellow-900/20' },
                { id: 9, name: 'এসএসসি', icon: 'microscope', color: 'text-purple-600 bg-purple-50 dark:bg-purple-900/20' },
                { id: 11, name: 'এইচএসসি', icon: 'atom', color: 'text-indigo-600 bg-indigo-50 dark:bg-indigo-900/20' }
            ];
            classes.forEach(c => {
                const el = document.createElement('div');
                el.className = `w-40 md:w-56 h-36 md:h-48 bg-white dark:bg-gray-900 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-800 flex flex-col items-center justify-center cursor-pointer card-hover p-4`;
                el.onclick = () => selectClass(c.id, c.name);
                el.innerHTML = `<div class="h-12 w-12 md:h-16 md:w-16 rounded-full ${c.color} flex items-center justify-center mb-3"><i data-lucide="${c.icon}" class="h-6 w-6 md:h-8 md:w-8"></i></div><h3 class="font-bold text-gray-800 dark:text-white text-lg">${c.name}</h3>`;
                if(c.id <= 8) rowJun.appendChild(el); else rowSen.appendChild(el);
            });
        }

        function updateGroup() { currentGroup = document.getElementById('group-select').value; renderSubjects(); }
        function toggleOptionalSubjects() { showOptional = document.getElementById('toggle-optional').checked; renderSubjects(); }

        function renderSubjects() {
            const container = document.getElementById('subject-content'); container.innerHTML = '';
            let subs = subjectsData[currentClass.id] || [];
            
            if (currentClass.id === 9 || currentClass.id === 11) {
                const groupSubs = subs.filter(s => s.group === currentGroup && (isEditMode || showOptional || !s.isOptional));
                const commonSubs = subs.filter(s => s.group === 'common' && (isEditMode || showOptional || !s.isOptional));
                renderSubjectSection(container, 'বিভাগের বিষয়', groupSubs);
                renderSubjectSection(container, 'আবশ্যিক ও অন্যান্য', commonSubs);
            } else {
                const visibleSubs = subs.filter(s => isEditMode || showOptional || !s.isOptional);
                renderSubjectSection(container, '', visibleSubs);
            }
            updateBulkActionBar('subjects'); lucide.createIcons();
        }

        function renderSubjectSection(container, title, items) {
            if(items.length===0) return;
            if(title) {
                const h3 = document.createElement('h3');
                h3.className = "text-lg font-bold text-gray-500 mb-3 mt-6 px-1";
                h3.innerText = title;
                container.appendChild(h3);
            }
            const grid = document.createElement('div'); grid.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4';
            items.forEach(sub => {
                const isSelected = selectedIds.has(sub.id);
                const el = document.createElement('div');
                const isHidden = sub.isOptional && !showOptional && isEditMode;
                let extraClass = '';
                if (sub.isGroupOptional) { extraClass = 'group-optional border-dashed border-2'; }
                el.className = `bg-white dark:bg-gray-900 p-4 rounded-xl border ${isSelected?'border-indigo-500 ring-2 ring-indigo-500/20':'border-gray-100 dark:border-gray-800'} hover:shadow-md cursor-pointer transition relative group select-none ${isHidden ? 'is-hidden-subject' : ''} ${extraClass}`;
                
                if(isEditMode) {
                    el.draggable = true;
                    el.addEventListener('click', (e) => { if (e.target.closest('button')) return; toggleSelection(sub.id); renderSubjects(); });
                    el.addEventListener('dragstart', (e) => { dragSrcId = sub.id; e.target.classList.add('dragging'); });
                    el.addEventListener('dragend', (e) => { e.target.classList.remove('dragging'); });
                    el.addEventListener('dragover', (e) => { e.preventDefault(); });
                    el.addEventListener('drop', (e) => handleSubjectDrop(e, sub.id));
                } else {
                    el.addEventListener('click', () => openReader(sub));
                }

                let controls = isEditMode ? `<div class="absolute top-2 right-2 btn-visible-anim"><button onclick="event.stopPropagation(); editSubject('${sub.id}')" class="p-1 bg-blue-50 text-blue-600 rounded-full"><i data-lucide="pencil" class="h-3 w-3"></i></button></div>` : '';

                
                const progress = calculateProgress(currentClass.id, sub.id, sub.chapters);
                const progressBar = `
                    <div class="mt-3">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs text-gray-500">অগ্রগতি</span>
                            <span class="text-xs font-semibold ${progress === 100 ? 'text-green-600' : 'text-indigo-600'}" data-progress-text="${sub.id}">${progress}%</span>
                        </div>
                        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                            <div class="h-full rounded-full transition-all duration-300 ${progress === 100 ? 'bg-green-500' : 'bg-indigo-600'}" data-progress-bar="${sub.id}" style="width: ${progress}%"></div>
                        </div>
                    </div>`;
                el.innerHTML = `${controls}
                    <div class="flex items-center gap-3">
                        <div class="p-2.5 rounded-lg bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400"><i data-lucide="${sub.icon}" class="h-5 w-5"></i></div>
                        <div><h4 class="font-bold text-gray-800 dark:text-white text-base">${sub.name}</h4><p class="text-xs text-gray-500">${sub.desc}</p></div>
                    </div>
                    ${!isEditMode ? progressBar : ''}`;
                grid.appendChild(el);
            });
            container.appendChild(grid);
        }

        // --- DRAG & DROP & READER LOGIC ---
        function handleSubjectDrop(e, targetId) {
            e.stopPropagation(); if(dragSrcId === targetId) return;
            const list = subjectsData[currentClass.id];
            const srcIdx = list.findIndex(s => s.id === dragSrcId);
            const tgtIdx = list.findIndex(s => s.id === targetId);
            if(srcIdx > -1 && tgtIdx > -1) {
                const [moved] = list.splice(srcIdx, 1);
                list.splice(tgtIdx, 0, moved);
                saveData(); renderSubjects();
            }
        }

        function openReader(sub) {
            currentSubject = sub;
            if(currentSubject.chapters) currentSubject.chapters.forEach(ensureContentStructure);
            
            // Expand all chapters by default
            if (currentSubject.chapters) {
                expandAllChapters(currentSubject.chapters);
            }
            
            // Pre-set the last read chapter BEFORE rendering, so tree renders already highlighted
            const lastChapterId = lastReadPosition[currentClass.id]?.[currentSubject.id];
            if (lastChapterId && !currentChapterNode) {
                const lastChapter = findNode(currentSubject.chapters, lastChapterId);
                if (lastChapter) {
                    currentChapterNode = lastChapter;
                    // Pre-expand the path to this chapter
                    const path = findPathToNode(currentSubject.chapters, lastChapterId);
                    if (path) path.forEach(parentId => openAccordionIds.add(parentId));
                }
            }
            
            hideAllViews();
            const readerEl = document.getElementById('view-reader');
            // Make it invisible but present in DOM so we can scroll before showing
            readerEl.classList.remove('hidden');
            readerEl.style.opacity = '0';
            document.getElementById('reader-subject-title').innerText = `${currentClass.name} > ${sub.name}`;
            selectedIds.clear();
            
            // Restore sidebar hidden state BEFORE any paint to prevent flash
            const sidebar = document.getElementById('reader-sidebar');
            const panels = document.getElementById('reader-panels');
            sidebar.style.transition = 'none'; // suppress during restore
            if (window.innerWidth >= 1024) {
                if (sessionStorage.getItem('sidebarHidden')) {
                    sidebar.classList.add('lg:w-0', 'lg:opacity-0', 'lg:pointer-events-none');
                    if (panels) panels.classList.remove('lg:gap-6');
                } else {
                    sidebar.classList.remove('lg:w-0', 'lg:opacity-0', 'lg:pointer-events-none');
                    if (panels) panels.classList.add('lg:gap-6');
                }
            }
            void sidebar.offsetWidth; // force reflow
            sidebar.style.transition = ''; // re-enable
            
            // Render chapters with highlight already in place
            renderChapters();
            
            // If we have a last chapter, show its content immediately
            if (currentChapterNode) {
                document.getElementById('content-empty').classList.add('hidden');
                const _ct = document.getElementById('content-tabs'); _ct.classList.remove('hidden'); _ct.style.display = 'block';
                document.getElementById('chapter-title').innerText = currentChapterNode.title;
                ensureContentStructure(currentChapterNode);
                switchTab(activeTab);
                
                // Scroll to correct position WHILE still invisible — no bounce possible
                const chapterElement = document.querySelector(`[onclick*="clickChapter('${currentChapterNode.id}'"]`);
                if (chapterElement) {
                    chapterElement.scrollIntoView({ behavior: 'instant', block: 'center' });
                }
            } else {
                document.getElementById('content-empty').classList.remove('hidden');
                document.getElementById('content-tabs').classList.add('hidden');
                ['text', 'pdf', 'video', 'qna'].forEach(t => document.getElementById(`tab-content-${t}`).classList.add('hidden'));
            }
            
            // Now reveal: both main panels slide up with standard fade-in.
            // translateY is relative to each panel's own layout position,
            // NOT their internal scroll — so no bounce!
            readerEl.style.opacity = '';
            
            const contentArea = readerEl.querySelector('.flex-grow.h-full.w-full');
            
            // Temporarily disable sidebar's transition so width restoration doesn't animate visibly
            sidebar.style.transition = 'none';
            void sidebar.offsetWidth; // force reflow
            
            // Remove class first in case it's still on from a previous visit
            sidebar.classList.remove('fade-in');
            if (contentArea) contentArea.classList.remove('fade-in');
            
            // Re-enable transition after suppressing the initial state flash
            requestAnimationFrame(() => {
                sidebar.style.transition = '';
                void sidebar.offsetWidth;
                
                // Now add fade-in — animation plays cleanly from frame 0
                sidebar.classList.add('fade-in');
                if (contentArea) contentArea.classList.add('fade-in');
                
                setTimeout(() => {
                    sidebar.classList.remove('fade-in');
                    if (contentArea) contentArea.classList.remove('fade-in');
                }, 500);
            });
            
            updateURL(); // Update URL
        }
        
        // Recursively expand all chapters with children
        function expandAllChapters(nodes) {
            nodes.forEach(node => {
                if (node.children && node.children.length > 0) {
                    openAccordionIds.add(node.id);
                    expandAllChapters(node.children);
                }
            });
        }

        function renderChapters() {
            const list = document.getElementById('chapter-list'); list.innerHTML = '';
            if(!currentSubject.chapters || currentSubject.chapters.length===0) document.getElementById('empty-chapters-msg').classList.remove('hidden');
            else {
                document.getElementById('empty-chapters-msg').classList.add('hidden');
                // Render all chapters
                currentSubject.chapters.forEach(node => list.appendChild(createChapterNode(node, 0)));
            }
            updateBulkActionBar('chapters'); lucide.createIcons();
        }
        
        // Find path from root to target node (returns array of parent IDs)
        function findPathToNode(nodes, targetId, path = []) {
            for (let node of nodes) {
                if (node.id === targetId) {
                    return path;
                }
                if (node.children && node.children.length > 0) {
                    const result = findPathToNode(node.children, targetId, [...path, node.id]);
                    if (result) return result;
                }
            }
            return null;
        }

        function createChapterNode(node, depth) {
            const div = document.createElement('div');
            const hasChildren = node.children && node.children.length > 0;
            const isOpen = openAccordionIds.has(node.id);
            const isSelected = selectedIds.has(node.id);
            const isActive = currentChapterNode && currentChapterNode.id === node.id;
            const padding = 0.5 + (depth * 1.2);

            const isCompleted = isChapterCompleted(currentClass.id, currentSubject.id, node.id);
            let checkbox = isEditMode 
                ? `<input type="checkbox" ${isSelected?'checked':''} class="mr-2 accent-indigo-600 h-4 w-4" onclick="toggleSelection('${node.id}'); renderChapters(); event.stopPropagation();">`
                : `<input type="checkbox" ${isCompleted?'checked':''} data-chapter-checkbox="${node.id}" class="mr-2 accent-indigo-600 h-4 w-4" onclick="toggleChapterCompletion('${node.id}'); event.stopPropagation();" title="সম্পন্ন চিহ্নিত করুন">`;
            
            div.innerHTML = `
            <div class="group flex items-center justify-between p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 cursor-pointer mb-1 select-none transition-all ${isActive ? 'bg-gray-200 dark:bg-gray-700/80 shadow-md' : ''}" 
                 style="padding-left: ${padding}rem" onclick="clickChapter('${node.id}', event)">
                <div class="flex items-center gap-2 overflow-hidden w-full">
                    ${checkbox}
                    <i id="icon-${node.id}" data-lucide="${hasChildren ? 'chevron-right' : 'circle'}" class="h-4 w-4 ${isActive ? 'text-gray-700 dark:text-gray-200' : 'text-gray-400'} transition-transform ${hasChildren && isOpen ? 'rotate-90' : ''} ${!hasChildren ? 'h-1.5 w-1.5 mt-0.5 ml-1' : ''}"></i>
                    <span class="truncate text-sm font-medium ${isActive ? 'font-semibold text-gray-900 dark:text-white' : 'text-gray-700 dark:text-gray-300'}">${node.title}</span>
                </div>
            </div>
            <div id="acc-${node.id}" class="accordion-content ${isOpen ? 'open' : ''}"></div>`;

            if(isEditMode) {
                div.firstElementChild.draggable = true;
                div.firstElementChild.ondragstart = (e) => { dragSrcId = node.id; e.stopPropagation(); e.target.style.opacity = '0.5'; };
                div.firstElementChild.ondragend = (e) => { e.target.style.opacity = '1'; removeDragClasses(); };
                div.firstElementChild.ondragover = handleChapDragOver;
                div.firstElementChild.ondragleave = handleChapDragLeave;
                div.firstElementChild.ondrop = (e) => handleChapDrop(e, node.id);
            }

            const container = div.querySelector('.accordion-content');
            if(node.children) node.children.forEach(c => container.appendChild(createChapterNode(c, depth + 1)));
            return div;
        }

        function findNode(nodes, id) {
            for(let n of nodes) { if(n.id===id) return n; if(n.children) { const f = findNode(n.children, id); if(f) return f; } } return null;
        }
        function findParent(nodes, id) {
             for(let i=0; i<nodes.length; i++) {
                 if(nodes[i].id === id) return { p: nodes, i };
                 if(nodes[i].children) { const f = findParent(nodes[i].children, id); if(f) return f; }
             }
             return null;
        }

        function clickChapter(id, e, isAutoOpen = false) {
            if(isEditMode && e && e.target && e.target.tagName === 'INPUT') return;
            const node = findNode(currentSubject.chapters, id);
            if (!node) return; // Safety check
            
            // End previous study session
            if (studySessionStart) {
                endStudySession();
            }
            
            if(node.children && node.children.length > 0) {
                const el = document.getElementById(`acc-${id}`);
                if(el && el.classList.contains('open')) { el.classList.remove('open'); openAccordionIds.delete(id); }
                else if(el) { el.classList.add('open'); openAccordionIds.add(id); }
                if (!isAutoOpen) renderChapters(); 
            }
            currentChapterNode = node;
            ensureContentStructure(currentChapterNode);
            document.getElementById('chapter-title').innerText = node.title;
            document.getElementById('content-empty').classList.add('hidden');
            const _ct = document.getElementById('content-tabs'); _ct.classList.remove('hidden'); _ct.style.display = 'block';
            
            // Re-render to update highlighting (only when user manually clicks)
            if (!isAutoOpen) {
                renderChapters();
                // Scroll content back to top when user picks a new chapter
                const contentBody = document.getElementById('content-body');
                if (contentBody) contentBody.scrollTop = 0;
            }
            
            switchTab(activeTab);
            
            // Save last chapter position (skip during auto-open to avoid overwriting)
            if (!isAutoOpen) {
                if (!lastReadPosition[currentClass.id]) lastReadPosition[currentClass.id] = {};
                lastReadPosition[currentClass.id][currentSubject.id] = id;
                localStorage.setItem('smartPathshala_lastRead', JSON.stringify(lastReadPosition));
            }
            
            // Update URL
            updateURL();
            
            // Start new study session
            startStudySession(currentSubject.id, id);
        }

        function handleChapDragOver(e) {
            e.preventDefault(); e.stopPropagation();
            const rect = e.currentTarget.getBoundingClientRect();
            const y = e.clientY - rect.top;
            removeDragClasses(e.currentTarget);
            const id = e.currentTarget.parentNode.querySelector('.accordion-content').id.replace('acc-', '');
            if(y > rect.height * 0.25 && y < rect.height * 0.75) {
                 e.currentTarget.classList.add('drag-over-middle');
                 if(!expandTimer) expandTimer = setTimeout(() => { if(document.querySelector('.drag-over-middle')) clickChapter(id); }, 800);
            } else if (y < rect.height * 0.25) e.currentTarget.classList.add('drag-over-top');
            else e.currentTarget.classList.add('drag-over-bottom');
        }
        function handleChapDragLeave(e) { removeDragClasses(e.currentTarget); clearTimeout(expandTimer); expandTimer = null; }
        function removeDragClasses(el) { if(el) el.classList.remove('drag-over-top', 'drag-over-bottom', 'drag-over-middle'); else document.querySelectorAll('.drag-over-top, .drag-over-bottom, .drag-over-middle').forEach(x => removeDragClasses(x)); }
        
        function handleChapDrop(e, targetId) {
            e.stopPropagation(); clearTimeout(expandTimer); removeDragClasses();
            if(dragSrcId === targetId) return;
            const srcNode = findNode(currentSubject.chapters, dragSrcId);
            if(isDescendant(srcNode, targetId)) { alert("Parent cannot be moved inside child."); return; }
            
            const srcInfo = findParent(currentSubject.chapters, dragSrcId);
            if(!srcInfo) return;
            const movedItem = srcInfo.p.splice(srcInfo.i, 1)[0];
            
            const rect = e.currentTarget.getBoundingClientRect();
            const y = e.clientY - rect.top;

            if (y > rect.height * 0.25 && y < rect.height * 0.75) {
                const tgtNode = findNode(currentSubject.chapters, targetId);
                if(!tgtNode.children) tgtNode.children = [];
                tgtNode.children.push(movedItem);
                openAccordionIds.add(targetId);
            } else {
                const tgtInfo = findParent(currentSubject.chapters, targetId);
                const pos = (y > rect.height * 0.75) ? tgtInfo.i + 1 : tgtInfo.i;
                tgtInfo.p.splice(pos, 0, movedItem);
            }
            saveData(); renderChapters();
        }
        function isDescendant(parent, childId) {
            if(!parent.children) return false;
            for(let c of parent.children) { if(c.id === childId) return true; if(isDescendant(c, childId)) return true; }
            return false;
        }

        // --- CONTENT TABS & RENDERING ---
        function switchTab(tab) {
            activeTab = tab;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('tab-active'));
            document.getElementById(`tab-btn-${tab}`).classList.add('tab-active');
            ['text', 'pdf', 'video', 'qna'].forEach(t => {
                const tc = document.getElementById(`tab-content-${t}`);
                if (tc) { tc.classList.add('hidden'); tc.style.display = 'none'; }
                const ta = document.getElementById(`tab-actions-${t}`);
                if (ta) { ta.classList.add('hidden'); ta.style.display = 'none'; }
            });
            const activeTab_ = document.getElementById(`tab-content-${tab}`);
            if (activeTab_) {
                activeTab_.classList.remove('hidden');
                activeTab_.style.display = 'flex';
                activeTab_.style.flexDirection = (tab === 'pdf') ? 'row' : 'column';
            }
            // pdf and video need fixed height (iframe), text/qna need scroll
            const contentBody = document.getElementById('content-body');
            if (contentBody) {
                if (tab === 'pdf' || tab === 'video') {
                    contentBody.style.overflowY = 'hidden';
                } else {
                    contentBody.style.overflowY = 'auto';
                }
            }
            const activeActions = document.getElementById(`tab-actions-${tab}`);
            if (activeActions) { activeActions.classList.remove('hidden'); activeActions.style.display = 'flex'; }
            if (tab === 'video') { sendChapterVideosToIframe(); }
            else { renderActiveTabContent(); }
        }

        function sendChapterVideosToIframe() {
            if (!currentChapterNode) return;
            const iframe = document.getElementById('youtube-tab-iframe');
            if (!iframe) return;
            const videos = (currentChapterNode.content && currentChapterNode.content.videos) || [];
            const chapterId = String(currentChapterNode.id || currentChapterNode.title || 'ch');
            function doSend() {
                try { iframe.contentWindow.postMessage({ type: 'initChapterVideos', videos: videos, chapterId: chapterId }, '*'); } catch(e) {}
            }
            doSend(); setTimeout(doSend, 300); setTimeout(doSend, 900);
            iframe.onload = doSend;
        }

        window.addEventListener('message', function(e) {
            if (e.data && e.data.type === 'ytVideosChanged') {
                if (!currentChapterNode) return;
                const chapterId = String(currentChapterNode.id || currentChapterNode.title || 'ch');
                if (e.data.chapterId && e.data.chapterId !== chapterId) return;
                if (!currentChapterNode.content) currentChapterNode.content = {};
                currentChapterNode.content.videos = e.data.videos || [];
                saveData();
            }
        });

        function renderActiveTabContent() {
            if (!currentChapterNode) return;
            const content = currentChapterNode.content;

            if (activeTab === 'text') {
                const viewer = document.getElementById('render-markdown');
                const emptyMsg = document.getElementById('empty-text-msg');
                const loader = document.getElementById('loading-indicator');
                viewer.innerHTML = ''; emptyMsg.classList.add('hidden');
                
                if (content.textUrl) {
                    loader.classList.remove('hidden');
                    fetchTextContent(content.textUrl)
                        .then(text => { viewer.innerHTML = marked.parse(text); loader.classList.add('hidden'); })
                        .catch(err => { viewer.innerHTML = `<div class="text-red-500 text-center">Error: ${err.message}</div>`; loader.classList.add('hidden'); });
                } else if (content.text && content.text.trim()) {
                    viewer.innerHTML = marked.parse(content.text);
                } else {
                    emptyMsg.classList.remove('hidden');
                }
            } else if (activeTab === 'pdf') {
                const frame = document.getElementById('pdf-frame');
                const sidebar = document.getElementById('pdf-sidebar');
                const list = document.getElementById('pdf-list-container');
                const pdfs = content.pdfs || [];
                list.innerHTML = '';

                if (pdfs.length > 0) {
                    if (pdfs.length > 1) { sidebar.classList.remove('hidden'); sidebar.classList.add('flex'); }
                    pdfs.forEach((pdf, index) => {
                        const btn = document.createElement('button');
                        btn.className = `w-full text-left px-3 py-2 text-xs truncate border-l-2 hover:bg-gray-100 dark:hover:bg-gray-700 ${frame.src.includes(pdf.url) ? 'border-indigo-600 font-bold bg-indigo-50 dark:bg-indigo-900/30' : 'border-transparent'}`;
                        btn.innerText = pdf.title;
                        btn.onclick = () => { setPdfFrame(pdf.url); renderActiveTabContent(); };
                        list.appendChild(btn);
                    });
                    if (!frame.src || frame.src === 'about:blank' || (pdfs.length === 1 && !frame.src.includes(pdfs[0].url))) { setPdfFrame(pdfs[0].url); }
                    frame.classList.remove('hidden'); document.getElementById('empty-pdf-msg').classList.add('hidden');
                } else {
                    frame.src = ''; frame.classList.add('hidden'); document.getElementById('empty-pdf-msg').classList.remove('hidden');
                }
            } else if (activeTab === 'video') {
                const grid = document.getElementById('video-grid'); grid.innerHTML = '';
                if (content.videos && content.videos.length > 0) {
                    content.videos.forEach((v, index) => {
                        let innerHTML = '';
                        if (v.id) { 
                             innerHTML = `<iframe class="w-full h-full" src="https://www.youtube.com/embed/${v.id}?rel=0&modestbranding=1" frameborder="0" allowfullscreen></iframe>`;
                        } else if (v.url && (v.url.endsWith('.mp4') || v.url.endsWith('.webm') || v.url.startsWith('blob:'))) { 
                            innerHTML = `<video id="vid-${index}" class="w-full h-full object-contain" src="${v.url}" controls></video>`;
                        } else { 
                            innerHTML = `<div class="flex flex-col items-center justify-center h-full p-4 text-center bg-gray-100 dark:bg-gray-800 text-gray-500"><a href="${v.url}" target="_blank" class="text-indigo-600 underline font-bold text-sm">Open Link</a></div>`;
                        }
                        const style = (v.width && v.height) ? `width: ${v.width}px; height: ${v.height}px; flex: none;` : '';
                        const card = document.createElement('div');
                        card.id = `vcard-${index}`;
                        card.className = `bg-black dark:bg-black rounded-lg overflow-hidden shadow-sm resizable-card relative group border border-gray-200 dark:border-gray-700`;
                        card.style = style;
                        card.innerHTML = `
                            <div class="flex-grow relative overflow-hidden bg-black flex items-center justify-center">${innerHTML}<button onclick="toggleFocusMode('vcard-${index}')" class="absolute top-2 right-2 p-1.5 bg-black/50 hover:bg-black/70 text-white rounded-full opacity-0 group-hover:opacity-100 transition z-10"><i data-lucide="maximize" class="h-4 w-4"></i></button></div>
                            <div class="p-3 h-12 bg-white dark:bg-gray-900 flex items-center justify-between flex-none border-t border-gray-100 dark:border-gray-800"><h4 class="font-bold text-sm dark:text-white truncate flex-1 mr-2" title="${v.title}">${v.title}</h4><div class="flex items-center gap-2"><button onclick="deleteVideo(${index})" class="p-1 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded transition" title="Delete"><i data-lucide="trash-2" class="h-4 w-4"></i></button><div class="cursor-se-resize p-1"><i data-lucide="maximize-2" class="h-3 w-3 text-gray-400"></i></div></div></div>`;
                        grid.appendChild(card);
                        const resizeObserver = new ResizeObserver(entries => {
                            for (let entry of entries) {
                                const { width, height } = entry.contentRect;
                                if (width > 0 && height > 0 && !card.classList.contains('focus-mode')) { v.width = width; v.height = height; debouncedSave(); }
                            }
                        });
                        resizeObserver.observe(card);
                        card.addEventListener('mouseup', () => { if (!card.classList.contains('focus-mode')) { v.width = card.offsetWidth; v.height = card.offsetHeight; saveData(); } });
                    });
                    document.getElementById('empty-video-msg').classList.add('hidden');
                } else { document.getElementById('empty-video-msg').classList.remove('hidden'); }
            } else if (activeTab === 'qna') {
                const listContainer = document.getElementById('qna-view-list');
                const cardContainer = document.getElementById('qna-view-card');
                listContainer.innerHTML = ''; cardContainer.innerHTML = '';
                if (content.qna && content.qna.length > 0) {
                    content.qna.forEach((qa, idx) => {
                        listContainer.innerHTML += `<div class="border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden"><div class="bg-gray-100 dark:bg-gray-800 p-3 font-bold text-gray-800 dark:text-gray-200 text-sm cursor-pointer" onclick="this.nextElementSibling.classList.toggle('hidden')"><span class="text-indigo-600 mr-2">Q${idx+1}.</span> ${qa.q}</div><div class="p-4 bg-white dark:bg-gray-900/50 text-gray-700 dark:text-gray-300 hidden border-t border-gray-100 dark:border-gray-800 prose dark:prose-invert max-w-none text-sm">${marked.parse(qa.a)}</div></div>`;
                        cardContainer.innerHTML += `<div class="flashcard-container group"><div class="flashcard" onclick="this.classList.toggle('flipped')"><div class="flashcard-face flashcard-front"><h3 class="text-lg font-bold">${qa.q}</h3><p class="text-xs opacity-70 mt-4">(Click to Flip)</p></div><div class="flashcard-face flashcard-back custom-scrollbar"><div class="prose dark:prose-invert text-sm max-w-none">${marked.parse(qa.a)}</div></div></div></div>`;
                    });
                    toggleQnaView(qnaViewMode); document.getElementById('empty-qna-msg').classList.add('hidden');
                } else {
                    document.getElementById('qna-view-list').classList.add('hidden'); document.getElementById('qna-view-card').classList.add('hidden'); document.getElementById('empty-qna-msg').classList.remove('hidden');
                }
            }
            lucide.createIcons();
        }
        
        function setPdfFrame(url) {
            let finalUrl = url;
            if (url.includes('drive.google.com') && url.includes('/view')) finalUrl = url.replace('/view', '/preview');
            document.getElementById('pdf-frame').src = finalUrl;
        }
        function addPdfResource() {
            const title = document.getElementById('input-pdf-title').value.trim();
            const url = document.getElementById('input-pdf-url').value.trim();
            if(title && url) {
                if(!currentChapterNode.content.pdfs) currentChapterNode.content.pdfs = [];
                currentChapterNode.content.pdfs.push({ title, url });
                saveData(); renderManagePdfList(); renderActiveTabContent();
                document.getElementById('input-pdf-title').value = ''; document.getElementById('input-pdf-url').value = '';
            }
        }
        function deletePdfResource(idx) {
            currentChapterNode.content.pdfs.splice(idx, 1);
            saveData(); renderManagePdfList(); renderActiveTabContent();
        }
        function renderManagePdfList() {
             const list = document.getElementById('pdf-manage-list'); list.innerHTML = '';
             const pdfs = currentChapterNode.content.pdfs || [];
             if(pdfs.length === 0) { list.innerHTML = '<p class="text-xs text-gray-400 text-center mt-4">কোন PDF নেই</p>'; return; }
             pdfs.forEach((pdf, i) => {
                 list.innerHTML += `<div class="flex justify-between items-center bg-white dark:bg-gray-900 p-2 mb-1 rounded border border-gray-100 dark:border-gray-700"><div class="truncate w-3/4"><div class="font-bold text-xs dark:text-white">${pdf.title}</div><div class="text-[10px] text-gray-400 truncate">${pdf.url}</div></div><button onclick="deletePdfResource(${i})" class="text-red-500 hover:text-red-700"><i data-lucide="trash-2" class="h-4 w-4"></i></button></div>`;
             });
             lucide.createIcons();
        }

        function toggleQnaView(mode) {
            qnaViewMode = mode;
            const btnList = document.getElementById('btn-qna-list'); const btnCard = document.getElementById('btn-qna-card');
            const viewList = document.getElementById('qna-view-list'); const viewCard = document.getElementById('qna-view-card');
            if (mode === 'list') {
                btnList.className = 'px-3 py-1 text-xs rounded-md shadow-sm bg-white dark:bg-gray-600 text-gray-800 dark:text-white font-medium transition';
                btnCard.className = 'px-3 py-1 text-xs rounded-md text-gray-500 dark:text-gray-400 hover:text-gray-700 transition';
                viewList.classList.remove('hidden'); viewCard.classList.add('hidden');
            } else {
                btnCard.className = 'px-3 py-1 text-xs rounded-md shadow-sm bg-white dark:bg-gray-600 text-gray-800 dark:text-white font-medium transition';
                btnList.className = 'px-3 py-1 text-xs rounded-md text-gray-500 dark:text-gray-400 hover:text-gray-700 transition';
                viewList.classList.add('hidden'); viewCard.classList.remove('hidden');
            }
        }

        function insertMarkdown(prefix, suffix) {
            const textarea = document.getElementById('input-content-text');
            const start = textarea.selectionStart; const end = textarea.selectionEnd; const text = textarea.value;
            textarea.value = text.substring(0, start) + prefix + text.substring(start, end) + suffix + text.substring(end);
            textarea.selectionStart = start + prefix.length; textarea.selectionEnd = end + prefix.length; textarea.focus();
            textarea.dispatchEvent(new Event('input'));
        }
        
        function openInsertImageModal() { openModal('modal-insert-image'); toggleImageLayoutInputs('float'); }
        function toggleImageLayoutInputs(type) {
            currentImageLayout = type;
            ['float', 'center', 'grid'].forEach(t => {
                const el = document.getElementById(`layout-inputs-${t}`); const btn = document.getElementById(`btn-layout-${t}`);
                if (t === type) { el.classList.remove('hidden'); btn.classList.add('bg-indigo-100', 'text-indigo-700', 'dark:bg-indigo-900', 'dark:text-indigo-300'); btn.classList.remove('text-gray-600'); } 
                else { el.classList.add('hidden'); btn.classList.remove('bg-indigo-100', 'text-indigo-700', 'dark:bg-indigo-900', 'dark:text-indigo-300'); btn.classList.add('text-gray-600'); }
            });
        }
        function insertImageHtml() {
            let html = '';
            if (currentImageLayout === 'float') {
                const dir = document.getElementById('img-float-dir').value; const size = document.getElementById('img-float-size').value;
                const url = document.getElementById('img-float-url').value; const cap = document.getElementById('img-float-cap').value;
                if(!url) { alert("Link required"); return; }
                const floatClass = dir === 'right' ? 'float-right' : 'float-left';
                html = `<div class="${floatClass} ${size} ml-4 mb-2"><img src="${url}" class="rounded-lg shadow w-full" alt="${cap}">${cap ? `<p class="text-center text-xs text-gray-500 mt-1 italic">${cap}</p>` : ''}</div>`;
            } else if (currentImageLayout === 'center') {
                const url = document.getElementById('img-center-url').value; const cap = document.getElementById('img-center-cap').value;
                if(!url) { alert("Link required"); return; }
                html = `<figure class="w-full my-4"><img src="${url}" class="mx-auto rounded-lg shadow max-h-96 block" alt="${cap}">${cap ? `<figcaption class="text-center text-sm text-gray-500 mt-1 italic">${cap}</figcaption>` : ''}</figure>`;
            } else if (currentImageLayout === 'grid') {
                const url1 = document.getElementById('img-grid-url1').value; const cap1 = document.getElementById('img-grid-cap1').value;
                const url2 = document.getElementById('img-grid-url2').value; const cap2 = document.getElementById('img-grid-cap2').value;
                if(!url1 || !url2) { alert("Both links required"); return; }
                html = `<div class="grid grid-cols-1 md:grid-cols-2 gap-4 my-4"><figure><img src="${url1}" class="w-full rounded-lg shadow h-auto">${cap1 ? `<figcaption class="text-center text-xs text-gray-500 mt-1">${cap1}</figcaption>` : ''}</figure><figure><img src="${url2}" class="w-full rounded-lg shadow h-auto">${cap2 ? `<figcaption class="text-center text-xs text-gray-500 mt-1">${cap2}</figcaption>` : ''}</figure></div>`;
            }
            insertMarkdown(html, ''); closeModal('modal-insert-image'); document.querySelectorAll('#modal-insert-image input').forEach(i => i.value = '');
        }
        function toggleFocusMode(cardId) {
            const card = document.getElementById(cardId); card.classList.toggle('focus-mode');
            const icon = card.querySelector('button i');
            if (card.classList.contains('focus-mode')) icon.setAttribute('data-lucide', 'minimize'); else icon.setAttribute('data-lucide', 'maximize');
            lucide.createIcons();
        }

        function loadLocalTextFile(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) { currentChapterNode.content.text = e.target.result; currentChapterNode.content.textUrl = ''; renderActiveTabContent(); };
                reader.readAsText(input.files[0]);
            }
        }
        function loadLocalPdfFile(input) {
            if (input.files && input.files[0]) {
                const url = URL.createObjectURL(input.files[0]);
                if(!currentChapterNode.content.pdfs) currentChapterNode.content.pdfs = [];
                currentChapterNode.content.pdfs.push({ title: input.files[0].name, url: url });
                renderActiveTabContent();
            }
        }
        function loadLocalVideoFile(input) {
            if (input.files && input.files[0]) {
                const url = URL.createObjectURL(input.files[0]);
                if(!currentChapterNode.content.videos) currentChapterNode.content.videos = [];
                currentChapterNode.content.videos.push({ title: input.files[0].name, url: url });
                renderActiveTabContent();
            }
        }

        function openAddTextLinkModal() { document.getElementById('input-text-url').value = currentChapterNode.content.textUrl || ''; openModal('modal-add-text-link'); }
        function saveTextLink() {
            const url = document.getElementById('input-text-url').value.trim();
            if (url) { currentChapterNode.content.textUrl = url; saveData(); renderActiveTabContent(); closeModal('modal-add-text-link'); }
        }
        async function fetchTextContent(url) {
            if (!url || !url.startsWith('http')) throw new Error("Invalid URL");
            let targetUrl = url;
            if (url.includes('drive.google.com')) {
                const idMatch = url.match(/\/d\/([a-zA-Z0-9_-]+)/) || url.match(/id=([a-zA-Z0-9_-]+)/);
                if (idMatch && idMatch[1]) targetUrl = `https://drive.google.com/uc?id=${idMatch[1]}&export=download`;
            }
            const proxies = [(u) => `https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`, (u) => `https://corsproxy.io/?${encodeURIComponent(u)}`];
            for (const createProxyUrl of proxies) {
                try {
                    const response = await fetch(createProxyUrl(targetUrl));
                    if (!response.ok) throw new Error(`Status ${response.status}`);
                    return await response.text();
                } catch (error) {}
            }
            throw new Error(`Unable to load content`);
        }

        function openEditContentModal(type) {
            if(!currentChapterNode) return;
            const content = currentChapterNode.content;
            if (type === 'text') {
                document.getElementById('input-content-text').value = content.text || '';
                document.getElementById('preview-content-text').innerHTML = marked.parse(content.text || '');
                openModal('modal-edit-text');
            } else if (type === 'pdf') {
                document.getElementById('input-pdf-title').value = ''; document.getElementById('input-pdf-url').value = ''; renderManagePdfList(); openModal('modal-edit-pdf');
            } else if (type === 'video') {
                document.getElementById('input-video-title').value = ''; document.getElementById('input-video-url').value = ''; renderManageVideoList(); openModal('modal-edit-video');
            } else if (type === 'qna') {
                document.getElementById('input-qna-q').value = ''; document.getElementById('input-qna-a').value = ''; renderManageQnaList(); openModal('modal-edit-qna');
            }
        }
        function saveContentText() {
            currentChapterNode.content.text = document.getElementById('input-content-text').value;
            saveData(); renderActiveTabContent(); closeModal('modal-edit-text');
        }

        function addVideo() {
            const title = document.getElementById('input-video-title').value;
            let url = document.getElementById('input-video-url').value.trim();
            let vidId = null;
            if (url.startsWith('<iframe')) { const srcMatch = url.match(/src="([^"]+)"/); if (srcMatch) url = srcMatch[1]; }
            const ytMatch = url.match(/(?:youtu\.be\/|youtube\.com\/(?:.*v=|.*\/))([^"&?\/\s]{11})/);
            if (ytMatch) vidId = ytMatch[1];
            if(title && (vidId || url)) {
                if(!currentChapterNode.content.videos) currentChapterNode.content.videos = [];
                currentChapterNode.content.videos.push({ title, url, id: vidId }); 
                saveData(); renderManageVideoList(); renderActiveTabContent();
                document.getElementById('input-video-title').value = ''; document.getElementById('input-video-url').value = '';
            } else { alert("Invalid Video Link"); }
        }
        function deleteVideo(idx) { currentChapterNode.content.videos.splice(idx, 1); saveData(); renderManageVideoList(); renderActiveTabContent(); }
        function renderManageVideoList() {
            const list = document.getElementById('video-list-manage'); list.innerHTML = '';
            (currentChapterNode.content.videos || []).forEach((v, i) => { list.innerHTML += `<div class="flex justify-between items-center p-2 bg-gray-50 dark:bg-gray-800 mb-1 rounded"><span class="text-xs truncate dark:text-white w-3/4">${v.title}</span><button onclick="deleteVideo(${i})" class="text-red-500 hover:text-red-700"><i data-lucide="trash-2" class="h-4 w-4"></i></button></div>`; });
            lucide.createIcons();
        }

        function addQna() {
            const q = document.getElementById('input-qna-q').value; const a = document.getElementById('input-qna-a').value;
            if(q && a) {
                if(!currentChapterNode.content.qna) currentChapterNode.content.qna = [];
                currentChapterNode.content.qna.push({ q, a });
                saveData(); renderManageQnaList(); renderActiveTabContent();
                document.getElementById('input-qna-q').value = ''; document.getElementById('input-qna-a').value = '';
            }
        }
        function deleteQna(idx) { currentChapterNode.content.qna.splice(idx, 1); saveData(); renderManageQnaList(); renderActiveTabContent(); }
        function renderManageQnaList() {
             const list = document.getElementById('qna-list-manage'); list.innerHTML = '';
            (currentChapterNode.content.qna || []).forEach((qa, i) => { list.innerHTML += `<div class="flex justify-between items-start p-2 bg-gray-50 dark:bg-gray-800 mb-1 rounded"><div class="w-3/4"><p class="text-xs font-bold dark:text-white truncate">${qa.q}</p><p class="text-xs text-gray-500 truncate">${qa.a}</p></div><button onclick="deleteQna(${i})" class="text-red-500 hover:text-red-700 mt-1"><i data-lucide="trash-2" class="h-4 w-4"></i></button></div>`; });
            lucide.createIcons();
        }

        function bulkToggleVisibilitySubjects() {
            if (!currentClass || !subjectsData[currentClass.id]) return;
            subjectsData[currentClass.id].forEach(s => { if(selectedIds.has(s.id)) s.isOptional = !s.isOptional; });
            selectedIds.clear(); saveData(); renderSubjects();
        }
        function bulkDeleteSubjects() {
             openConfirmModal(`${selectedIds.size} টি বিষয় মুছতে চান?`, () => {
                 subjectsData[currentClass.id] = subjectsData[currentClass.id].filter(s => !selectedIds.has(s.id));
                 selectedIds.clear(); saveData(); renderSubjects();
             });
        }
        function bulkDeleteChapters() {
             openConfirmModal(`${selectedIds.size} টি অধ্যায় মুছতে চান?`, () => {
                 function filter(list) { return list.filter(n => { if(selectedIds.has(n.id)) return false; if(n.children) n.children=filter(n.children); return true; }); }
                 currentSubject.chapters = filter(currentSubject.chapters); selectedIds.clear(); saveData(); renderChapters();
             });
        }

        function toggleTheme() { document.documentElement.classList.toggle('dark'); localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light'); lucide.createIcons(); }
        function checkTheme() { if(localStorage.getItem('theme')==='dark') document.documentElement.classList.add('dark'); else document.documentElement.classList.remove('dark'); }

        function toggleEditMode() {
            isEditMode = !isEditMode; selectedIds.clear(); updateEditModeUI();
            const isReader = !document.getElementById('view-reader').classList.contains('hidden');
            if(isReader) renderChapters(); else renderSubjects();
        }
        function updateEditModeUI() {
            const btns = document.querySelectorAll('#btn-edit-mode, #btn-edit-mode-reader');
            btns.forEach(btn => {
                if(isEditMode) {
                    btn.innerHTML = '<i data-lucide="check" class="h-4 w-4"></i> শেষ করুন';
                    btn.className = "flex items-center gap-2 bg-red-100 text-red-600 px-3 py-2 rounded-lg text-sm font-medium transition";
                } else {
                    btn.innerHTML = '<i data-lucide="edit-3" class="h-4 w-4"></i> এডিট';
                    btn.className = "bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 px-3 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2";
                }
            });
            updateBulkActionBar(document.getElementById('view-reader').classList.contains('hidden') ? 'subjects' : 'chapters');
            lucide.createIcons();
        }
        function toggleSelection(id) { if (selectedIds.has(id)) selectedIds.delete(id); else selectedIds.add(id); }
        function clearSelection() { selectedIds.clear(); const isReader = !document.getElementById('view-reader').classList.contains('hidden'); if(isReader) renderChapters(); else renderSubjects(); }
        function updateBulkActionBar(type) {
            const bar = document.getElementById(`bulk-action-bar-${type}`); if(!bar) return;
            const countSpan = document.getElementById(`selected-count-${type === 'subjects' ? 'subs' : 'chaps'}`);
            if (isEditMode && selectedIds.size > 0) { bar.classList.remove('hidden'); countSpan.innerText = selectedIds.size; } else { bar.classList.add('hidden'); }
        }
        function openModal(id) { document.getElementById(id).classList.remove('opacity-0', 'pointer-events-none'); document.body.classList.add('modal-active'); }
        function closeModal(id) { 
            if (id === 'modal-stats') {
                destroyCharts(); 
                if (statsInterval) clearInterval(statsInterval);
            }
            document.getElementById(id).classList.add('opacity-0', 'pointer-events-none'); 
            document.body.classList.remove('modal-active'); 
        }
        let confirmCb = null;
        function openConfirmModal(msg, cb) { document.getElementById('confirm-modal-text').innerText = msg; confirmCb = cb; openModal('modal-confirm'); }
        document.getElementById('confirm-modal-btn').onclick = () => { if(confirmCb) confirmCb(); closeModal('modal-confirm'); };


        function toggleHeaderCollapse() {
            const header = document.getElementById('reader-subject-header');
            const restoreBtn = document.getElementById('header-restore-btn');
            const isCollapsed = header.classList.contains('header-collapsed');
            if (!isCollapsed) {
                header.classList.add('header-collapsed');
                if (restoreBtn) restoreBtn.style.display = 'flex';
            } else {
                header.classList.remove('header-collapsed');
                if (restoreBtn) restoreBtn.style.display = 'none';
            }
        }
        // ---- Reader page tools menu ----
        let _toolsMenuOpen = false;
        function closeToolsMenu() {
            const p = document.getElementById('tools-menu-panel');
            if (p) p.style.display = 'none';
            _toolsMenuOpen = false;
        }
        function toggleToolsMenu() {
            const p = document.getElementById('tools-menu-panel');
            const btn = document.getElementById('tools-menu-btn');
            if (!p || !btn) return;
            if (_toolsMenuOpen) {
                p.style.display = 'none';
                _toolsMenuOpen = false;
            } else {
                const r = btn.getBoundingClientRect();
                p.style.top = (r.bottom + 4) + 'px';
                p.style.right = (window.innerWidth - r.right) + 'px';
                p.style.left = 'auto';
                p.style.display = 'block';
                _toolsMenuOpen = true;
            }
        }
        document.addEventListener('click', function(e) {
            const w1 = document.getElementById('tools-menu-wrapper');
            const p = document.getElementById('tools-menu-panel');
            if (p && w1 && !w1.contains(e.target) && !p.contains(e.target)) {
                p.style.display = 'none';
                _toolsMenuOpen = false;
            }
        }, true);

        // ---- Add button dropdown (subjects page) ----
        let _addMenuOpen = false;
        function closeAddMenu() {
            const p = document.getElementById('add-menu-panel');
            if (p) p.style.display = 'none';
            _addMenuOpen = false;
        }
        function toggleAddMenu() {
            const p = document.getElementById('add-menu-panel');
            if (!p) return;
            if (_addMenuOpen) {
                p.style.display = 'none';
                _addMenuOpen = false;
            } else {
                p.style.display = 'block';
                _addMenuOpen = true;
            }
        }
        document.addEventListener('click', function(e) {
            const w = document.getElementById('add-btn-wrapper');
            const p = document.getElementById('add-menu-panel');
            if (p && w && !w.contains(e.target)) {
                p.style.display = 'none';
                _addMenuOpen = false;
            }
        }, true);

        // ---- Subjects page tools menu ----
        let _toolsMenuSubjectsOpen = false;
        function closeToolsMenuSubjects() {
            const p = document.getElementById('tools-menu-panel-subjects');
            if (p) p.style.display = 'none';
            _toolsMenuSubjectsOpen = false;
        }
        function toggleToolsMenuSubjects() {
            const p = document.getElementById('tools-menu-panel-subjects');
            const btn = document.querySelector('#tools-menu-wrapper-subjects button');
            if (!p || !btn) return;
            if (_toolsMenuSubjectsOpen) {
                p.style.display = 'none';
                _toolsMenuSubjectsOpen = false;
            } else {
                const r = btn.getBoundingClientRect();
                p.style.top = (r.bottom + 4) + 'px';
                p.style.right = (window.innerWidth - r.right) + 'px';
                p.style.left = 'auto';
                p.style.display = 'block';
                _toolsMenuSubjectsOpen = true;
            }
        }
        document.addEventListener('click', function(e) {
            const w2 = document.getElementById('tools-menu-wrapper-subjects');
            const p = document.getElementById('tools-menu-panel-subjects');
            if (p && w2 && !w2.contains(e.target) && !p.contains(e.target)) {
                p.style.display = 'none';
                _toolsMenuSubjectsOpen = false;
            }
        }, true);
        function confirmReset() { openConfirmModal("সতর্কতা: সব ডাটা রিসেট হবে এবং ডিফল্ট লোড হবে।", resetData); }
        
        function openBulkImportSubjectModal(isChapter = false) { 
            const title = isChapter ? "বাল্ক ইম্পোর্ট (অধ্যায়)" : "বাল্ক ইম্পোর্ট (বিষয়)";
            document.getElementById('modal-bulk-title').innerText = title;
            document.getElementById('bulk-import-text').value='';
            const btn = document.getElementById('btn-bulk-process');
            btn.onclick = isChapter ? processBulkImportChapter : processBulkImport;
            btn.innerText = "ইম্পোর্ট করুন";
            document.getElementById('bulk-import-controls').classList.remove('hidden');
            openModal('modal-bulk-import'); 
        }

        // UPDATED: Calls shared parse function
        function processBulkImport() {
            const txt = document.getElementById('bulk-import-text').value; 
            const includeCh = document.getElementById('bulk-include-chapters').checked;
            parseAndImportData(txt, parseInt(currentClass.id), includeCh);
            saveData(); renderSubjects(); closeModal('modal-bulk-import');
        }

        function processBulkImportChapter() {
             const txt = document.getElementById('bulk-import-text').value; 
             const lines = txt.split('\n').filter(l=>l.trim());
             let stack = [];
             lines.forEach(line => {
                 const t = line.trim();
                 let depth = -1; let title = '';
                 if(t.startsWith('#')) { depth=0; title=t.substring(1).trim(); }
                 else if (t.startsWith('-')) {
                     const match = t.match(/^(-+)\s*(.*)/);
                     if(match) { depth = match[1].length; title = match[2].trim(); }
                 }
                 if(depth>-1 && title) {
                     const newNode = { id: generateShortId("chapter", title), title: title, children:[], content: {text:'',pdfUrl:'',pdfs: [], videos:[],qna:[]} };
                     if(stack.length===0) {
                         currentSubject.chapters.push(newNode); stack.push({node:newNode, depth:depth});
                     } else {
                         while(stack.length>0 && stack[stack.length-1].depth >= depth) stack.pop();
                         if(stack.length>0) stack[stack.length-1].node.children.push(newNode);
                         else currentSubject.chapters.push(newNode);
                         stack.push({node:newNode, depth:depth});
                     }
                 }
             });
             saveData(); renderChapters(); closeModal('modal-bulk-import');
        }
        function exportClassData() {
            let output = "";
            const subs = subjectsData[currentClass.id] || [];
            function printNode(node, depth) {
                let prefix = "";
                if(depth === 0) prefix = "#";
                else { for(let i=0; i<depth; i++) prefix += "-"; }
                output += `${prefix} ${node.title}\n`;
                if(node.children) node.children.forEach(c => printNode(c, depth + 1));
            }
            subs.forEach(sub => {
                output += `${sub.isOptional ? '**' : '*'}${sub.name}\n`;
                if(sub.chapters) sub.chapters.forEach(ch => printNode(ch, 0));
                output += "\n";
            });
            document.getElementById('modal-bulk-title').innerText = "বাল্ক এক্সপোর্ট (লিস্ট)";
            document.getElementById('bulk-import-text').value = output;
            document.getElementById('bulk-import-controls').classList.add('hidden');
            const btn = document.getElementById('btn-bulk-process');
            btn.innerText = "কপি করুন";
            btn.onclick = () => { document.getElementById('bulk-import-text').select(); document.execCommand('copy'); alert("কপি হয়েছে!"); };
            openModal('modal-bulk-import');
        }
        function exportChapterData() {
            let output = "";
            function printNode(node, depth) {
                let prefix = "";
                if(depth === 0) prefix = "#";
                else { for(let i=0; i<depth; i++) prefix += "-"; }
                output += `${prefix} ${node.title}\n`;
                if(node.children) node.children.forEach(c => printNode(c, depth + 1));
            }
            if(currentSubject.chapters) currentSubject.chapters.forEach(ch => printNode(ch, 0));
            document.getElementById('modal-bulk-title').innerText = "এক্সপোর্ট (লিস্ট)";
            document.getElementById('bulk-import-text').value = output;
            document.getElementById('bulk-import-controls').classList.add('hidden');
            const btn = document.getElementById('btn-bulk-process');
            btn.innerText = "কপি করুন";
            btn.onclick = () => { document.getElementById('bulk-import-text').select(); document.execCommand('copy'); alert("কপি হয়েছে!"); };
            openModal('modal-bulk-import');
        }
        function openAddSubjectModal() {
             document.getElementById('modal-subject-title').innerText = "নতুন বিষয়"; document.getElementById('input-sub-id').value = '';
             document.getElementById('input-sub-name').value = ''; document.getElementById('input-sub-desc').value = '';
             const gw=document.getElementById('modal-group-select-wrapper'); if(currentClass.id===9||currentClass.id===11) gw.classList.remove('hidden'); else gw.classList.add('hidden');
             openModal('modal-subject');
        }
        function saveSubject() {
            const id = document.getElementById('input-sub-id').value; const name = document.getElementById('input-sub-name').value;
            if(!name) return;
            const newData = { name, desc: document.getElementById('input-sub-desc').value, group: document.getElementById('input-sub-group').value, isOptional: document.getElementById('input-sub-optional').checked, icon: 'book' };
            if(id) { const idx=subjectsData[currentClass.id].findIndex(s=>s.id===id); if(idx>-1) subjectsData[currentClass.id][idx]={...subjectsData[currentClass.id][idx],...newData}; }
            else subjectsData[currentClass.id].push({id: generateShortId("subject", newData.name, currentClass.id), ...newData, chapters: []});
            saveData(); renderSubjects(); closeModal('modal-subject');
        }
        function editSubject(id) {
             const sub = subjectsData[currentClass.id].find(s => s.id === id); if(!sub) return;
             document.getElementById('modal-subject-title').innerText = "এডিট বিষয়"; document.getElementById('input-sub-id').value = sub.id;
             document.getElementById('input-sub-name').value = sub.name; document.getElementById('input-sub-desc').value = sub.desc||'';
             document.getElementById('input-sub-optional').checked = sub.isOptional;
             const gw=document.getElementById('modal-group-select-wrapper'); if(currentClass.id===9||currentClass.id===11) gw.classList.remove('hidden'); else gw.classList.add('hidden');
             openModal('modal-subject');
        }
        function openAddChapterModal() { document.getElementById('input-chap-name').value = ''; openModal('modal-add-chapter'); }
        function saveNewChapter() {
             const name = document.getElementById('input-chap-name').value;
             if(name) {
                 const newCh = {id: generateShortId("chapter", name), title:name, children:[], content:{text:'',pdfUrl:'',pdfs: [], videos:[],qna:[]}};
                 currentSubject.chapters.push(newCh); saveData(); renderChapters(); closeModal('modal-add-chapter');
             }
        }
        
        // --- NEW EXPORT/IMPORT FEATURES ---
        
        // Export as JSON File download
        function exportData() {
            const dataStr = JSON.stringify(subjectsData, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            const date = new Date().toISOString().split('T')[0];
            a.download = `smart_pathshala_backup_${date}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Import Backup JSON
        function importBackup(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        // Basic validation
                        if (typeof importedData === 'object') {
                            if (confirm("বর্তমান ডাটা মুছে ব্যাকআপ রিস্টোর হবে। আপনি কি নিশ্চিত?")) {
                                subjectsData = importedData;
                                saveData();
                                alert("ডাটা সফলভাবে রিস্টোর হয়েছে!");
                                location.reload();
                            }
                        } else {
                            alert("ভুল ফাইল ফরম্যাট!");
                        }
                    } catch (err) {
                        alert("ব্যাকআপ ফাইল পড়া যায়নি: " + err.message);
                    }
                    // Reset input so same file can be selected again
                    input.value = '';
                };
                reader.readAsText(input.files[0]);
            }
        }


        // Sidebar Toggle Function
        function toggleSidebar() {
            const sidebar = document.getElementById('reader-sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            const isMobile = window.innerWidth < 1024;
            
            if (isMobile) {
                const isOpen = !sidebar.classList.contains('-translate-x-full');
                if (isOpen) {
                    sidebar.classList.add('-translate-x-full');
                    sidebar.classList.remove('flex');
                    overlay.classList.add('hidden');
                } else {
                    sidebar.classList.remove('-translate-x-full');
                    sidebar.classList.add('flex');
                    overlay.classList.remove('hidden');
                }
            } else {
                // Desktop: collapse width to 0 — content fills the gap naturally
                const isHidden = sidebar.classList.contains('lg:w-0');
                const panels = document.getElementById('reader-panels');
                if (isHidden) {
                    sidebar.classList.remove('lg:w-0', 'lg:opacity-0', 'lg:pointer-events-none');
                    if (panels) panels.classList.add('lg:gap-6');
                    sessionStorage.removeItem('sidebarHidden');
                } else {
                    sidebar.classList.add('lg:w-0', 'lg:opacity-0', 'lg:pointer-events-none');
                    if (panels) panels.classList.remove('lg:gap-6');
                    sessionStorage.setItem('sidebarHidden', '1');
                }
            }
            
            setTimeout(() => lucide.createIcons(), 100);
        }
        
        // Auto-adjust sidebar on window resize
        window.addEventListener('resize', () => {
            const sidebar = document.getElementById('reader-sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            const panels = document.getElementById('reader-panels');
            if (!sidebar) return;
            
            if (window.innerWidth >= 1024) {
                sidebar.classList.remove('-translate-x-full', 'flex');
                overlay.classList.add('hidden');
                if (sessionStorage.getItem('sidebarHidden')) {
                    sidebar.classList.add('lg:w-0', 'lg:opacity-0', 'lg:pointer-events-none');
                    if (panels) panels.classList.remove('lg:gap-6');
                } else {
                    sidebar.classList.remove('lg:w-0', 'lg:opacity-0', 'lg:pointer-events-none');
                    if (panels) panels.classList.add('lg:gap-6');
                }
            } else {
                sidebar.classList.add('-translate-x-full');
                sidebar.classList.remove('flex', 'lg:w-0', 'lg:opacity-0', 'lg:pointer-events-none');
                if (panels) panels.classList.add('lg:gap-6');
                overlay.classList.add('hidden');
            }
        });

        window.onload = init;

        // URL Routing System with PERMANENT, universal links
        let isNavigating = false; // Prevent recursive calls
        
        function updateURL(skipHistory = false) {
            if (isNavigating) return;
            
            let hash = '#/';
            
            if (currentClass) {
                hash += currentClass.id; // Just the class number
                
                if (currentSubject) {
                    // Use subject ID directly (now they're already short!)
                    hash += '/' + currentSubject.id;
                    
                    if (currentChapterNode) {
                        // Use chapter ID directly
                        hash += '/' + currentChapterNode.id;
                    }
                }
            }
            
            // Update URL hash
            if (window.location.hash !== hash) {
                if (!skipHistory) {
                    window.location.hash = hash;
                } else {
                    history.replaceState(null, '', hash);
                }
            }
        }
        
        // Find subject by ID
        function findSubjectById(classId, subjectId) {
            const subjects = subjectsData[classId] || [];
            return subjects.find(s => s.id === subjectId);
        }
        
        // Find chapter by ID
        function findChapterById(nodes, chapterId) {
            for (let node of nodes) {
                if (node.id === chapterId) {
                    return node;
                }
                if (node.children && node.children.length > 0) {
                    const found = findChapterById(node.children, chapterId);
                    if (found) return found;
                }
            }
            return null;
        }
        
        // Restore state from URL hash
        function restoreFromURL() {
            if (isNavigating) return;
            isNavigating = true;
            
            try {
                const hash = window.location.hash.slice(1); // Remove #
                const parts = hash.split('/').filter(p => p);
                
                if (parts.length === 0) {
                    // Show class selection
                    currentClass = null;
                    currentSubject = null;
                    currentChapterNode = null;
                    hideAllViews();
                    document.getElementById('view-classes').classList.remove('hidden');
                    return;
                }
                
                // Parse class ID (supports both "Class8" and "8")
                const classIdStr = parts[0].replace('Class', '');
                const classId = parseInt(classIdStr);
                const subjectIdOrShort = parts[1];
                const chapterIdOrShort = parts[2];
                
                // Find class data
                const classes = [
                    { id: 6, name: 'ষষ্ঠ শ্রেণী' },
                    { id: 7, name: 'সপ্তম শ্রেণী' },
                    { id: 8, name: 'অষ্টম শ্রেণী' },
                    { id: 9, name: 'এসএসসি' },
                    { id: 11, name: 'এইচএসসি' }
                ];
                
                const foundClass = classes.find(c => c.id === classId);
                if (!foundClass) {
                    currentClass = null;
                    currentSubject = null;
                    currentChapterNode = null;
                    hideAllViews();
                    document.getElementById('view-classes').classList.remove('hidden');
                    return;
                }
                
                // Set class
                currentClass = { id: classId, name: foundClass.name };
                
                if (!subjectIdOrShort) {
                    // Just show subjects for this class
                    currentSubject = null;
                    currentChapterNode = null;
                    hideAllViews();
                    document.getElementById('view-subjects').classList.remove('hidden');
                    document.getElementById('selected-class-name').innerText = foundClass.name;
                    const gs = document.getElementById('group-selector-container');
                    if (classId === 9 || classId === 11) gs.classList.remove('hidden');
                    else gs.classList.add('hidden');
                    renderSubjects();
                    return;
                }
                
                // Find subject by ID
                const foundSubject = findSubjectById(classId, subjectIdOrShort);
                
                if (!foundSubject) {
                    // Subject not found, show subjects list
                    currentSubject = null;
                    currentChapterNode = null;
                    hideAllViews();
                    document.getElementById('view-subjects').classList.remove('hidden');
                    document.getElementById('selected-class-name').innerText = foundClass.name;
                    renderSubjects();
                    return;
                }
                
                currentSubject = foundSubject;
                
                // Open reader
                hideAllViews();
                document.getElementById('view-reader').classList.remove('hidden');
                document.getElementById('reader-subject-title').innerText = `${currentClass.name} > ${currentSubject.name}`;
                
                if (chapterIdOrShort) {
                    // Find chapter by ID
                    const chapter = findChapterById(currentSubject.chapters, chapterIdOrShort);
                    
                    if (chapter) {
                        // Expand path to this chapter
                        const path = findPathToNode(currentSubject.chapters, chapter.id);
                        if (path) {
                            path.forEach(parentId => openAccordionIds.add(parentId));
                        }
                        
                        // Render the chapter tree with expanded path
                        renderChapters();
                        
                        // Open the chapter
                        clickChapter(chapter.id, null, true);
                        
                        // Scroll to the chapter in sidebar instantly
                        setTimeout(() => {
                            const chapterElement = document.querySelector(`[onclick*="clickChapter('${chapter.id}'"]`);
                            if (chapterElement) {
                                chapterElement.scrollIntoView({ behavior: 'instant', block: 'center' });
                            }
                        }, 100);
                    } else {
                        // Chapter not found, just show all chapters
                        expandAllChapters(currentSubject.chapters);
                        renderChapters();
                    }
                } else {
                    // No specific chapter, expand all and show empty state
                    expandAllChapters(currentSubject.chapters);
                    renderChapters();
                    document.getElementById('content-empty').classList.remove('hidden');
                    document.getElementById('content-tabs').classList.add('hidden');
                }
            } finally {
                isNavigating = false;
            }
        }
        
        // Handle browser back/forward buttons
        window.addEventListener('hashchange', (event) => {
            if (!isNavigating) {
                restoreFromURL();
            }
        });
        
        // Initialize from URL on page load
        window.addEventListener('load', () => {
            if (window.location.hash && window.location.hash !== '#/' && window.location.hash !== '#') {
                restoreFromURL();
            }
        });


        // --- CHART RENDERING FUNCTIONS ---
        let charts = {}; // Store chart instances
        
        function destroyCharts() {
            for (let key in charts) {
                if (charts[key]) {
                    charts[key].destroy();
                    delete charts[key];
                }
            }
        }
        
        function renderWeeklyChart() {
            const ctx = document.getElementById('weeklyChart');
            if (!ctx) return;
            
            // Get last 7 days data
            const days = ['রবি', 'সোম', 'মঙ্গল', 'বুধ', 'বৃহঃ', 'শুক্র', 'শনি'];
            const today = new Date();
            const labels = [];
            const data = [];
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateStr = date.toDateString();
                labels.push(days[date.getDay()]);
                
                let dayMinutes = 0;
                statsData.sessionsLog.forEach(session => {
                    if (new Date(session.date).toDateString() === dateStr) {
                        dayMinutes += Math.round(session.duration / 60);
                    }
                });
                
                // Include current session if it's today - Use float for real-time visual
                if (i === 0 && studySessionStart && currentStudySubject) {
                    const currentDuration = (Date.now() - studySessionStart) / 60000; // minutes (float)
                    dayMinutes += currentDuration;
                }
                
                data.push(dayMinutes);
            }
            
            if (charts.weekly) charts.weekly.destroy();
            charts.weekly = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'মিনিট',
                        data: data,
                        backgroundColor: 'rgba(99, 102, 241, 0.7)',
                        borderColor: 'rgba(99, 102, 241, 1)',
                        borderWidth: 1,
                        borderRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    animation: false,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 10,
                            borderRadius: 6,
                            callbacks: {
                                label: (context) => `${Math.round(context.parsed.y)} মিনিট`
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            suggestedMax: 5,
                            ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('color') || '#6b7280' }
                        },
                        x: {
                            ticks: { color: getComputedStyle(document.documentElement).getPropertyValue('color') || '#6b7280' }
                        }
                    }
                }
            });
        }
        
        function renderSubjectChart() {
            const ctx = document.getElementById('subjectChart');
            if (!ctx || !currentClass) return;
            
            const subjects = subjectsData[currentClass.id] || [];
            const labels = [];
            const data = [];
            const colors = [
                'rgba(99, 102, 241, 0.7)',   // Indigo
                'rgba(16, 185, 129, 0.7)',   // Green
                'rgba(249, 115, 22, 0.7)',   // Orange
                'rgba(168, 85, 247, 0.7)',   // Purple
                'rgba(236, 72, 153, 0.7)',   // Pink
                'rgba(59, 130, 246, 0.7)',   // Blue
                'rgba(245, 158, 11, 0.7)',   // Amber
                'rgba(239, 68, 68, 0.7)'     // Red
            ];
            
            subjects.forEach((sub, idx) => {
                const key = `${currentClass.id}_${sub.id}`;
                let minutes = Math.round((statsData.studyTime[key] || 0) / 60);

                // Add current session if applicable
                if (studySessionStart && currentStudySubject === sub.id) {
                     minutes += Math.round((Date.now() - studySessionStart) / 60000);
                }

                if (minutes > 0) {
                    labels.push(sub.name.length > 15 ? sub.name.substring(0, 15) + '...' : sub.name);
                    data.push(minutes);
                }
            });
            
            if (data.length === 0) {
                ctx.parentElement.innerHTML = '<p class="text-sm text-gray-500 text-center py-8">এখনও কোনো ডাটা নেই</p>';
                return;
            }
            
            if (charts.subject) charts.subject.destroy();
            charts.subject = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors.slice(0, data.length),
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    animation: false,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                boxWidth: 12,
                                padding: 8,
                                font: { size: 10 },
                                color: getComputedStyle(document.documentElement).getPropertyValue('color') || '#6b7280'
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 10,
                            borderRadius: 6,
                            callbacks: {
                                label: (context) => {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${value}মি (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // --- MONTHLY CHART LOGIC (MOVED OUTSIDE) ---
        let dayViewOffset = 0; // Track which 30-day period we're viewing

        function renderMonthlyChart(offset = 0) {
            const ctx = document.getElementById('monthlyChart');
            if (!ctx) return;
            
            // Get 30 days data with offset
            const today = new Date();
            const labels = [];
            const data = [];
            
            // Calculate start day based on offset
            const startDayOffset = offset * 30;
            
            for (let i = 29; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i - startDayOffset);
                const dateStr = date.toDateString();
                const dayMonth = `${date.getDate()}/${date.getMonth() + 1}`;
                labels.push(dayMonth);
                
                let dayMinutes = 0;
                statsData.sessionsLog.forEach(session => {
                    if (new Date(session.date).toDateString() === dateStr) {
                        dayMinutes += Math.round(session.duration / 60);
                    }
                });
                
                // Include current session if it's today and offset is 0
                // Use float to show incremental progress
                if (offset === 0 && i === 0 && studySessionStart && currentStudySubject) {
                    const currentDuration = (Date.now() - studySessionStart) / 60000; // minutes (float)
                    dayMinutes += currentDuration;
                }
                
                data.push(dayMinutes);
            }
            
            // Update label
            const labelEl = document.getElementById('monthViewLabel');
            if (labelEl) {
                if (offset === 0) {
                    labelEl.innerText = 'শেষ ৩০ দিন';
                } else {
                    const endDate = new Date(today);
                    endDate.setDate(endDate.getDate() - startDayOffset);
                    const startDate = new Date(today);
                    startDate.setDate(startDate.getDate() - 29 - startDayOffset);
                    const months = ['জানুয়ারি', 'ফেব্রুয়ারি', 'মার্চ', 'এপ্রিল', 'মে', 'জুন', 'জুলাই', 'আগস্ট', 'সেপ্টেম্বর', 'অক্টোবর', 'নভেম্বর', 'ডিসেম্বর'];
                    labelEl.innerText = `${startDate.getDate()} ${months[startDate.getMonth()]} - ${endDate.getDate()} ${months[endDate.getMonth()]}`;
                }
            }
            
            if (charts.monthly) charts.monthly.destroy();
            
            try {
                charts.monthly = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'মিনিট',
                            data: data,
                            backgroundColor: 'rgba(16, 185, 129, 0.7)',
                            borderColor: 'rgba(16, 185, 129, 1)',
                            borderWidth: 1,
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        animation: false,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                padding: 10,
                                borderRadius: 6,
                                callbacks: {
                                    title: (items) => labels[items[0].dataIndex],
                                    label: (context) => `${Math.round(context.parsed.y)} মিনিট`
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                suggestedMax: 5,
                                ticks: { 
                                    color: '#6b7280',
                                    font: { size: 10 }
                                }
                            },
                            x: {
                                ticks: { 
                                    color: '#6b7280',
                                    maxRotation: 45,
                                    minRotation: 45,
                                    font: { size: 8 }
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error rendering monthly chart:', error);
            }
        }
        
        function changeMonthView(direction) {
            dayViewOffset += direction;
            if (dayViewOffset < 0) dayViewOffset = 0;
            renderMonthlyChart(dayViewOffset);
        }

        function renderTrendChart() {
            const ctx = document.getElementById('trendChart');
            if (!ctx) return;
            
            // Get last 14 days data
            const labels = [];
            const data = [];
            const today = new Date();
            
            for (let i = 13; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const dateStr = date.toDateString();
                const dayMonth = `${date.getDate()}/${date.getMonth() + 1}`;
                labels.push(dayMonth);
                
                let dayMinutes = 0;
                statsData.sessionsLog.forEach(session => {
                    if (new Date(session.date).toDateString() === dateStr) {
                        dayMinutes += Math.round(session.duration / 60);
                    }
                });
                
                // Include current session if it's today
                if (i === 0 && studySessionStart && currentStudySubject) {
                    const currentDuration = (Date.now() - studySessionStart) / 60000; // minutes (float)
                    dayMinutes += currentDuration;
                }
                
                data.push(dayMinutes);
            }
            
            if (charts.trend) charts.trend.destroy();
            charts.trend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'মিনিট',
                        data: data,
                        borderColor: 'rgba(16, 185, 129, 1)',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 3,
                        pointHoverRadius: 5,
                        pointBackgroundColor: 'rgba(16, 185, 129, 1)'
                    }]
                },
                options: {
                    responsive: true,
                    animation: false,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 10,
                            borderRadius: 6,
                            callbacks: {
                                title: (items) => `তারিখ: ${items[0].label}`,
                                label: (context) => `${Math.round(context.parsed.y)} মিনিট`
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            suggestedMax: 5,
                            ticks: { 
                                color: getComputedStyle(document.documentElement).getPropertyValue('color') || '#6b7280',
                                stepSize: 10
                            }
                        },
                        x: {
                            ticks: { 
                                color: getComputedStyle(document.documentElement).getPropertyValue('color') || '#6b7280',
                                maxRotation: 45,
                                minRotation: 45
                            }
                        }
                    }
                }
            });
        }

        // --- STUDY STATISTICS FUNCTIONS ---
        let studySessionStart = null;
        let currentStudySubject = null;
        let currentStudyChapter = null;
        let statsInterval = null; // Interval for real-time chart updates
        
        function startStudySession(subjectId, chapterId) {
            studySessionStart = Date.now();
            currentStudySubject = subjectId;
            currentStudyChapter = chapterId;
            updateStreak();
        }
        
        function endStudySession() {
            if (!studySessionStart || !currentStudySubject) return;
            
            const duration = Math.floor((Date.now() - studySessionStart) / 1000); // seconds
            const key = `${currentClass.id}_${currentStudySubject}`;
            
            if (!statsData.studyTime[key]) statsData.studyTime[key] = 0;
            statsData.studyTime[key] += duration;
            
            // Log session
            statsData.sessionsLog.push({
                date: new Date().toISOString(),
                classId: currentClass.id,
                subjectId: currentStudySubject,
                chapterId: currentStudyChapter,
                duration: duration
            });
            
            // Keep only last 100 sessions
            if (statsData.sessionsLog.length > 100) {
                statsData.sessionsLog = statsData.sessionsLog.slice(-100);
            }
            
            saveData();
            studySessionStart = null;
            currentStudySubject = null;
            currentStudyChapter = null;
        }
        
        function updateStreak() {
            const today = new Date().toDateString();
            const lastDate = statsData.streak.lastStudyDate;
            
            if (!lastDate) {
                // First time studying
                statsData.streak.current = 1;
                statsData.streak.best = 1;
                statsData.streak.lastStudyDate = today;
            } else if (lastDate === today) {
                // Already studied today
                return;
            } else {
                const lastStudyDate = new Date(lastDate);
                const todayDate = new Date(today);
                const diffDays = Math.floor((todayDate - lastStudyDate) / (1000 * 60 * 60 * 24));
                
                if (diffDays === 1) {
                    // Consecutive day
                    statsData.streak.current++;
                    if (statsData.streak.current > statsData.streak.best) {
                        statsData.streak.best = statsData.streak.current;
                    }
                } else {
                    // Streak broken
                    statsData.streak.current = 1;
                }
                statsData.streak.lastStudyDate = today;
            }
            saveData();
        }
        
        function getStudyTime(classId, subjectId) {
            const key = `${classId}_${subjectId}`;
            const seconds = statsData.studyTime[key] || 0;
            return formatTime(seconds);
        }
        
        function getTotalStudyTime() {
            let total = 0;
            for (let key in statsData.studyTime) {
                total += statsData.studyTime[key];
            }
            
            // Add current active session
            if (studySessionStart && currentStudySubject) {
                total += Math.floor((Date.now() - studySessionStart) / 1000);
            }
            
            return formatTime(total);
        }
        
        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            if (hours > 0) {
                return minutes > 0 ? `${hours} ঘন্টা ${minutes} মিনিট` : `${hours} ঘন্টা`;
            } else if (minutes > 0) {
                return `${minutes} মিনিট`;
            } else {
                return `${secs} সেকেন্ড`;
            }
        }
        
        function getTodayStudyTime() {
            const today = new Date().toDateString();
            let todaySeconds = 0;
            
            statsData.sessionsLog.forEach(session => {
                const sessionDate = new Date(session.date).toDateString();
                if (sessionDate === today) {
                    todaySeconds += session.duration;
                }
            });
            
            // Include current ongoing session
            if (studySessionStart && currentStudySubject) {
                const currentDuration = Math.floor((Date.now() - studySessionStart) / 1000);
                todaySeconds += currentDuration;
            }
            
            return formatTime(todaySeconds);
        }
        
        function getWeeklyStats() {
            const now = new Date();
            const weekAgo = new Date(now - 7 * 24 * 60 * 60 * 1000);
            let weeklySeconds = 0;
            let sessionCount = 0;
            
            statsData.sessionsLog.forEach(session => {
                const sessionDate = new Date(session.date);
                if (sessionDate >= weekAgo) {
                    weeklySeconds += session.duration;
                    sessionCount++;
                }
            });
            
            return {
                time: formatTime(weeklySeconds),
                sessions: sessionCount
            };
        }
        
        function renderChartsWrapper(isSubjectView = false) {
             // Refresh text stats
             const totalTimeEl = document.querySelector('#stats-modal-content .text-indigo-700');
             const todayTimeEl = document.querySelector('#stats-modal-content .text-green-700');
             if(totalTimeEl) totalTimeEl.innerText = getTotalStudyTime();
             if(todayTimeEl) todayTimeEl.innerText = getTodayStudyTime();

             // Refresh charts
             if (!isSubjectView) {
                renderWeeklyChart();
                if (currentClass) renderSubjectChart();
             }
             renderMonthlyChart(dayViewOffset);
             renderTrendChart();
        }

        function openStatsModal() {
            const totalTime = getTotalStudyTime();
            const todayTime = getTodayStudyTime();
            const weekStats = getWeeklyStats();
            const streak = statsData.streak;
            
            // Count completed chapters - ONLY from current class and NON-HIDDEN subjects
            let totalCompleted = 0;
            let completedChaptersList = [];
            
            if (currentClass) {
                const subjects = subjectsData[currentClass.id] || [];
                subjects.forEach(sub => {
                    // Skip hidden/optional subjects if not showing optional
                    if (sub.isOptional && !showOptional) return;
                    
                    if (progressData[currentClass.id] && progressData[currentClass.id][sub.id]) {
                        for (let chapterId in progressData[currentClass.id][sub.id]) {
                            if (progressData[currentClass.id][sub.id][chapterId]) {
                                totalCompleted++;
                                // Find chapter name
                                const chapter = findNode(sub.chapters, chapterId);
                                if (chapter) {
                                    completedChaptersList.push({
                                        subject: sub.name,
                                        chapter: chapter.title
                                    });
                                }
                            }
                        }
                    }
                });
            }
            
            // Build completed chapters list HTML
            let completedHTML = '';
            if (completedChaptersList.length > 0) {
                completedHTML = `
                    <div class="mt-3 max-h-40 overflow-y-auto space-y-1">
                        ${completedChaptersList.map(item => `
                            <div class="text-xs bg-purple-50 dark:bg-purple-900/20 px-2 py-1 rounded">
                                <span class="font-semibold text-purple-700 dark:text-purple-300">${item.subject}</span>
                                <span class="text-purple-600 dark:text-purple-400"> → ${item.chapter}</span>
                            </div>
                        `).join('')}
                    </div>`;
            }
            
            // Context-aware: If viewing a subject, show subject-specific stats
            const isSubjectView = currentSubject !== null;
            const contextTitle = isSubjectView 
                ? `${currentSubject.name} - পরিসংখ্যান`
                : 'পড়াশোনার পরিসংখ্যান';
            
            // Get subject-wise stats - EXCLUDE HIDDEN subjects
            let subjectStats = '';
            if (currentClass && !isSubjectView) {
                const subjects = subjectsData[currentClass.id] || [];
                subjects.forEach(sub => {
                    // Skip hidden subjects
                    if (sub.isOptional && !showOptional) return;
                    
                    const time = getStudyTime(currentClass.id, sub.id);
                    const progress = calculateProgress(currentClass.id, sub.id, sub.chapters);
                    
                    // Get completed chapters for this subject
                    let subChapters = [];
                    if (progressData[currentClass.id] && progressData[currentClass.id][sub.id]) {
                        for (let chapterId in progressData[currentClass.id][sub.id]) {
                            if (progressData[currentClass.id][sub.id][chapterId]) {
                                const chapter = findNode(sub.chapters, chapterId);
                                if (chapter) subChapters.push(chapter.title);
                            }
                        }
                    }
                    
                    const chaptersHTML = subChapters.length > 0 
                        ? `<div class="text-xs text-gray-500 dark:text-gray-400 mt-1">${subChapters.join(', ')}</div>`
                        : '';
                    
                    subjectStats += `
                        <div class="py-2 border-b border-gray-100 dark:border-gray-800">
                            <div class="flex justify-between items-center">
                                <span class="text-sm font-medium">${sub.name}</span>
                                <div class="text-right">
                                    <div class="text-sm font-bold text-indigo-600 dark:text-indigo-400">${time}</div>
                                    <div class="text-xs text-gray-500">${progress}% সম্পন্ন</div>
                                </div>
                            </div>
                            ${chaptersHTML}
                        </div>`;
                });
            }
            
            // Chapter-wise stats if viewing a subject
            let chapterStats = '';
            if (isSubjectView) {
                const chapters = currentSubject.chapters || [];
                
                function buildChapterStats(nodes, depth = 0) {
                    let html = '';
                    nodes.forEach(node => {
                        const isCompleted = isChapterCompleted(currentClass.id, currentSubject.id, node.id);
                        const time = getChapterStudyTime(currentClass.id, currentSubject.id, node.id);
                        const indent = depth * 1.5;
                        
                        html += `
                            <div class="py-2 border-b border-gray-100 dark:border-gray-800" style="padding-left: ${indent}rem">
                                <div class="flex justify-between items-center">
                                    <div class="flex items-center gap-2">
                                        ${isCompleted ? '<i data-lucide="check-circle" class="h-4 w-4 text-green-500"></i>' : '<i data-lucide="circle" class="h-4 w-4 text-gray-300"></i>'}
                                        <span class="text-sm ${isCompleted ? 'font-semibold' : ''}">${node.title}</span>
                                    </div>
                                    <span class="text-xs text-gray-500">${time}</span>
                                </div>
                            </div>`;
                        
                        if (node.children && node.children.length > 0) {
                            html += buildChapterStats(node.children, depth + 1);
                        }
                    });
                    return html;
                }
                
                chapterStats = buildChapterStats(chapters);
            }
            
            // Duolingo-style streak calendar
            
            document.getElementById('stats-modal-content').innerHTML = `
                <div class="space-y-6">
                    <!-- Title -->
                    <h4 class="text-lg font-bold text-gray-800 dark:text-gray-200">${contextTitle}</h4>
                    
                    <!-- Overview Cards -->
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-gradient-to-br from-indigo-50 to-indigo-100 dark:from-indigo-900/20 dark:to-indigo-800/20 p-4 rounded-xl">
                            <div class="text-xs text-indigo-600 dark:text-indigo-400 font-semibold mb-1">মোট পড়ার সময়</div>
                            <div class="text-2xl font-bold text-indigo-700 dark:text-indigo-300">${totalTime}</div>
                        </div>
                        <div class="bg-gradient-to-br from-green-50 to-green-100 dark:from-green-900/20 dark:to-green-800/20 p-4 rounded-xl">
                            <div class="text-xs text-green-600 dark:text-green-400 font-semibold mb-1">আজকের পড়া</div>
                            <div class="text-2xl font-bold text-green-700 dark:text-green-300">${todayTime}</div>
                        </div>
                        <div class="bg-gradient-to-br from-orange-50 to-orange-100 dark:from-orange-900/20 dark:to-orange-800/20 p-4 rounded-xl">
                            <div class="text-xs text-orange-600 dark:text-orange-400 font-semibold mb-1">স্ট্রিক 🔥</div>
                            <div class="text-2xl font-bold text-orange-700 dark:text-orange-300">${streak.current} দিন</div>
                            <div class="text-xs text-orange-500 mt-1">সর্বোচ্চ: ${streak.best} দিন</div>
                        </div>
                        <div class="bg-gradient-to-br from-purple-50 to-purple-100 dark:from-purple-900/20 dark:to-purple-800/20 p-4 rounded-xl cursor-pointer" onclick="toggleCompletedList()">
                            <div class="text-xs text-purple-600 dark:text-purple-400 font-semibold mb-1">সম্পন্ন অধ্যায়</div>
                            <div class="text-2xl font-bold text-purple-700 dark:text-purple-300">${totalCompleted}</div>
                            <div class="text-xs text-purple-500 mt-1">বিস্তারিত দেখুন ▼</div>
                        </div>
                    </div>
                    
                    <!-- Completed Chapters List (collapsible) -->
                    <div id="completed-list" class="hidden">
                        <h4 class="text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">সম্পন্ন অধ্যায়সমূহ</h4>
                        ${completedHTML || '<p class="text-sm text-gray-500">এখনও কোনো অধ্যায় সম্পন্ন হয়নি</p>'}
                    </div>
                    
                    
                    <!-- Charts Section -->
                    ${!isSubjectView ? `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Weekly Activity Chart -->
                        <div class="bg-white dark:bg-gray-800 p-4 rounded-xl border border-gray-200 dark:border-gray-700">
                            <h4 class="text-sm font-bold text-gray-700 dark:text-gray-300 mb-3">সাপ্তাহিক কার্যকলাপ</h4>
                            <div style="position: relative; height: 200px;">
                                <canvas id="weeklyChart"></canvas>
                            </div>
                        </div>
                        
                        <!-- Subject Distribution Chart -->
                        ${currentClass ? `
                        <div class="bg-white dark:bg-gray-800 p-4 rounded-xl border border-gray-200 dark:border-gray-700">
                            <h4 class="text-sm font-bold text-gray-700 dark:text-gray-300 mb-3">বিষয়ভিত্তিক সময়</h4>
                            <div style="position: relative; height: 200px;">
                                <canvas id="subjectChart"></canvas>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                    ` : ''}
                    
                    <!-- Monthly/Yearly View -->
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-xl border border-gray-200 dark:border-gray-700">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-sm font-bold text-gray-700 dark:text-gray-300">৩০ দিনের পরিসংখ্যান</h4>
                            <div class="flex gap-2">
                                <button onclick="changeMonthView(-1)" class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded text-xs hover:bg-gray-200 dark:hover:bg-gray-600">◀ আগে</button>
                                <span id="monthViewLabel" class="text-xs text-gray-600 dark:text-gray-400 px-2 py-1">শেষ ৩০ দিন</span>
                                <button onclick="changeMonthView(1)" class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded text-xs hover:bg-gray-200 dark:hover:bg-gray-600">পরে ▶</button>
                            </div>
                        </div>
                        <div style="position: relative; height: 200px;">
                            <canvas id="monthlyChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Study Trend Chart -->
                    <div class="bg-white dark:bg-gray-800 p-4 rounded-xl border border-gray-200 dark:border-gray-700">
                        <h4 class="text-sm font-bold text-gray-700 dark:text-gray-300 mb-3">পড়াশোনার ধারা (শেষ ১৪ দিন)</h4>
                        <div style="position: relative; height: 180px;">
                            <canvas id="trendChart"></canvas>
                        </div>
                    </div>
                    
                    ${chapterStats ? `
                    <!-- Chapter-wise Stats (Subject View) -->
                    <div>
                        <h4 class="text-sm font-bold text-gray-700 dark:text-gray-300 mb-3">অধ্যায়ভিত্তিক পরিসংখ্যান</h4>
                        <div class="max-h-96 overflow-y-auto">
                            ${chapterStats}
                        </div>
                    </div>
                    ` : ''}
                    
                    ${subjectStats && !isSubjectView ? `
                    <!-- Subject-wise Stats -->
                    <div>
                        <h4 class="text-sm font-bold text-gray-700 dark:text-gray-300 mb-3">বিষয়ভিত্তিক পরিসংখ্যান</h4>
                        <div class="space-y-1 max-h-96 overflow-y-auto">
                            ${subjectStats}
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;
            
            openModal('modal-stats');
            
            // Initial Render
            requestAnimationFrame(() => {
                setTimeout(() => {
                    renderChartsWrapper(isSubjectView);
                    lucide.createIcons();
                }, 300);
            });

            // Start Real-time Update Interval
            if(statsInterval) clearInterval(statsInterval);
            statsInterval = setInterval(() => {
                renderChartsWrapper(isSubjectView);
            }, 5000); // Update charts every 5 seconds
        }
        
        function toggleCompletedList() {
            const list = document.getElementById('completed-list');
            if (list) {
                list.classList.toggle('hidden');
            }
        }
        
        function getChapterStudyTime(classId, subjectId, chapterId) {
            let totalSeconds = 0;
            statsData.sessionsLog.forEach(session => {
                if (session.classId === classId && session.subjectId === subjectId && session.chapterId === chapterId) {
                    totalSeconds += session.duration;
                }
            });
            // Add current session if same chapter
            if(studySessionStart && currentStudyChapter === chapterId) {
                totalSeconds += Math.floor((Date.now() - studySessionStart) / 1000);
            }
            return formatTime(totalSeconds);
        }
        


        // --- PROGRESS TRACKING FUNCTIONS ---
        function toggleChapterCompletion(chapterId) {
            if (!progressData[currentClass.id]) progressData[currentClass.id] = {};
            if (!progressData[currentClass.id][currentSubject.id]) progressData[currentClass.id][currentSubject.id] = {};
            
            progressData[currentClass.id][currentSubject.id][chapterId] = !progressData[currentClass.id][currentSubject.id][chapterId];
            saveData();
            
            // Update UI
            const checkbox = document.querySelector(`[data-chapter-checkbox="${chapterId}"]`);
            if (checkbox) checkbox.checked = progressData[currentClass.id][currentSubject.id][chapterId];
            
            // Update progress bar in subject view if visible
            if (!document.getElementById('view-subjects').classList.contains('hidden')) {
                updateSubjectProgress(currentSubject.id);
            }
        }
        
        function isChapterCompleted(classId, subjectId, chapterId) {
            return progressData[classId]?.[subjectId]?.[chapterId] || false;
        }
        
        function calculateProgress(classId, subjectId, chapters) {
            if (!chapters || chapters.length === 0) return 0;
            
            let total = 0;
            let completed = 0;
            
            function countChapters(nodes) {
                nodes.forEach(node => {
                    total++;
                    if (isChapterCompleted(classId, subjectId, node.id)) completed++;
                    if (node.children && node.children.length > 0) countChapters(node.children);
                });
            }
            
            countChapters(chapters);
            return total > 0 ? Math.round((completed / total) * 100) : 0;
        }
        
        function updateSubjectProgress(subjectId) {
            const subject = subjectsData[currentClass.id].find(s => s.id === subjectId);
            if (!subject) return;
            
            const progress = calculateProgress(currentClass.id, subjectId, subject.chapters);
            const progressBar = document.querySelector(`[data-progress-bar="${subjectId}"]`);
            const progressText = document.querySelector(`[data-progress-text="${subjectId}"]`);
            
            if (progressBar) {
                progressBar.style.width = `${progress}%`;
                progressBar.className = `h-full rounded-full transition-all duration-300 ${progress === 100 ? 'bg-green-500' : 'bg-indigo-600'}`;
            }
            if (progressText) progressText.innerText = `${progress}%`;
        }
    </script>
</body>
</html>
